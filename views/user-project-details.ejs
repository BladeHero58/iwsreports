<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
    <!-- Handsontable CSS -->
    <script src="https://cdn.jsdelivr.net/npm/handsontable@latest/dist/handsontable.full.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable@latest/dist/handsontable.full.min.css"></script>
       <!-- Undo - Redo CSS-->
     <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
     <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

 <style>
    #hot-container {
      max-width: 794px;
      margin: 0 auto;
      overflow-x: auto;
    }

    .handsontable {
      font-size: 15px;
      line-height: 1.2;
    }

    @media print {
      #hot-container {
        max-width: 100% !important;
        overflow: visible !important;
      }

      .handsontable {
        font-size: 8px !important;
      }

      htCore td {
        padding: 2px !important;
      }
    }

    .black-cell {
        background-color: black !important;
        color: yellow !important;
        border-color: yellow !important;
        font-weight: bold !important;
        font-size: 16px !important;
    }

    /* Fekete cell√°k szerkeszt√©si √°llapotban */
    .handsontable td.black-cell.area {
        background-color: black !important;
    }

    /* Fekete cell√°k kijel√∂lve */
    .handsontable td.black-cell.current {
        background-color: black !important;
    }

    /* Fekete cell√°k highlight √°llapotban */
    .handsontable td.black-cell.highlight {
        background-color: black !important;
    }

    /* Fekete cell√°k szerkeszt√©si m√≥dban */
    .handsontable tbody tr td.black-cell.htInvalid {
        background-color: black !important;
    }

    .yellow-row {
        background-color: yellow !important;
    }

    .white-row {
        background-color: white !important;
    }

    .htCenter {
        text-align: center;
        vertical-align: middle;
    }

    .first-row-style {
        text-align: center !important;
        font-size: 22px !important;
        background-color: #ffffff !important;
        color: black !important;
        font-weight: bold !important;
        vertical-align: middle !important;
        text-decoration: underline !important;
    }

    .eleventh-row-style {
        text-align: center !important;
        vertical-align: middle !important;
    }

    .last-row-style {
        font-weight: bold !important;
        background-color: lightgrey !important;
        font-size: 18px !important;
        text-align: center !important;
    }

    .handsontable tr.beszurt-sor {
        height: 70px !important;
    }

    .vertical-text {
        writing-mode: vertical-lr;
    }

    .cell-centered {
        text-align: center !important;
        vertical-align: middle !important;
    }

    .project-description {
        display: block;
        max-width: 1200px;
        word-wrap: break-word;
        overflow-wrap: break-word;
        white-space: normal;
        margin-top: 0;
        margin-bottom: 16px;
        font-family: sans-serif;
    }
</style>

    <title>Projekt r√©szletei</title>

    <link rel="stylesheet" href="/css/pages/user-project-details-style.css">

</head>
<body>
    <h1>Projekt r√©szletei</h1>

    <h2><%= project.name %></h2>
    <p><strong>Le√≠r√°s:</strong></p>
    <div class="project-description"><%= project.description %></div>
    <p><strong>√Ållapot:</strong> <%= project.status %></p>
    <p><strong>Projekt ID:</strong> <%= project.id %></p>

    <!-- Google Drive mappa gomb -->
    <% if (project.drive_folder_id) { %>
        <div style="margin-top: 15px; margin-bottom: 15px;">
            <a href="https://drive.google.com/drive/folders/<%= project.drive_folder_id %>"
               target="_blank"
               class="btn-drive"
               style="display: inline-block; padding: 10px 20px; background-color: #4285f4; color: white; text-decoration: none; border-radius: 5px; font-weight: 600;">
                <i class="fab fa-google-drive"></i> Projekt Drive mappa megnyit√°sa
            </a>
        </div>
    <% } %>

    <section>
        <!-- Szerkeszt√©s gomb -->
        <a href="/user/projects/edit/<%= project.id %>">
            <button type="submit" class="btn"><i class="fas fa-pen-to-square"></i> Projekt szerkeszt√©se</button>
        </a>
    </section>
    
    <!-- Rejtett input mez≈ë a projectId-hoz -->
    <input type="hidden" id="projectId" value="<%= project.id %>">
    <input type="hidden" id="projectType" value="IWS Solutions">
     
    <!-- Gombok -->
    <button id="generateReportBtn" type="submit" class="btn"><i class="fas fa-plus"></i> √öj jegyz≈ëk√∂nyv gener√°l√°sa</button>
    <button id="loadReportBtn" type="submit" class="btn"><i class="fas fa-clock-rotate-left"></i> Legut√≥bbi jegyz≈ëk√∂nyv</button>
    <button id="saveReportBtn" type="submit" class="btn"><i class="fas fa-save"></i> Jegyz≈ëk√∂nyv ment√©se</button>

<button type="button" class="btn" onclick="window.open('/reports/fine-list', '_blank')">
    Szankci√≥s lista
</button>

    <button id="undo" class="btn-blue" style="font-size:10px">
        <i class="material-icons">undo</i>
    </button>
    
    <button id="redo" class="btn-blue" style="font-size:10px">
        <i class="material-icons">redo</i>
    </button>

    <div id="tableContainer" style="margin-top: 20px;"></div>

    <script src="https://cdn.jsdelivr.net/npm/handsontable@12.3.1/dist/handsontable.min.js"></script>
    <script>
        
        //project id mez≈ë
        const projectId = document.getElementById('projectId').value; 
        console.log('Aktu√°lis projekt ID:', projectId);

   // K√©p megjelen√≠t≈ë renderer (M√ìDOS√çTOTT)
const imageRenderer = (instance, td, row, col, prop, value, cellProperties) => {
    // T√∂r√∂lj√ºk a megl√©v≈ë tartalmat
    while (td.firstChild) {
        td.removeChild(td.firstChild);
    }

    // M√ìDOS√çT√ÅS: Most m√°r a GCS URL-eket is kezelj√ºk
    if (value && (value.startsWith('data:image') || value.startsWith('https://storage.googleapis.com/'))) {
        // Kont√©ner div l√©trehoz√°sa
        const container = document.createElement('div');
        container.style.width = '100%';
        container.style.height = '100%';
        container.style.display = 'flex';
        container.style.alignItems = 'center';
        container.style.justifyContent = 'center';
        container.style.overflow = 'hidden';
        container.style.position = 'relative';

        // Forgat√°si √©rt√©k lek√©r√©se
        let rotation = instance.getCellMeta(row, col).rotation || 0;

        // K√©p elem l√©trehoz√°sa
        const img = document.createElement('img');
        img.src = value; // A 'value' m√°r a GCS URL vagy Data URI lesz

        // Forgat√°s alkalmaz√°sa
        img.style.position = 'absolute';
        img.style.transformOrigin = 'center';
        img.style.transform = `rotate(${rotation}deg)`;

        // M√©retez√©s
        img.style.width = '100%';
        img.style.height = '100%';
        img.style.objectFit = 'cover';

        container.appendChild(img);
        td.appendChild(container);
    }

    // Cella padding elt√°vol√≠t√°sa
    td.style.padding = '0';
    td.style.overflow = 'hidden';

    return td;
};

// Kezdeti cella st√≠lusok be√°ll√≠t√°sa a t√°bl√°zat l√©trehoz√°sakor (M√ìDOS√çTOTT)
const setupInitialCellStyles = (hot, data) => {
    console.log("Frontend oldali data.cellStyles a setupInitialCellStyles f√ºggv√©nyben:", data.cellStyles);
    if (data.cellStyles && Array.isArray(data.cellStyles)) {
        data.cellStyles.forEach(style => {
            const row = style.row;
            const col = style.col;
            const value = hot.getDataAtCell(row, col);

            console.log(`setupInitialCellStyles: Sor=${row}, Oszlop=${col}, St√≠lus=${JSON.stringify(style)}`);

            // K√©p renderer √©s forgat√°s be√°ll√≠t√°sa
            // M√ìDOS√çT√ÅS: Most m√°r a GCS URL-eket is kezelj√ºk
            if (value && (value.startsWith('data:image') || value.startsWith('https://storage.googleapis.com/'))) {
                hot.setCellMeta(row, col, 'renderer', imageRenderer);
                if (style.rotation !== undefined) {
                    hot.setCellMeta(row, col, 'rotation', style.rotation);
                }
            }

            // Egy√©b st√≠lusok be√°ll√≠t√°sa a cellMeta-ban
            if (style.backgroundColor) {
                hot.setCellMeta(row, col, 'backgroundColor', style.backgroundColor);
            }
            if (style.color) {
                hot.setCellMeta(row, col, 'color', style.color);
            }
            if (style.fontWeight) {
                hot.setCellMeta(row, col, 'fontWeight', style.fontWeight);
            }
            if (style.fontSize) {
                hot.setCellMeta(row, col, 'fontSize', style.fontSize);
            }
            if (style.textAlign) {
                hot.setCellMeta(row, col, 'textAlign', style.textAlign);
            }
            if (style.borderColor) {
                hot.setCellMeta(row, col, 'borderColor', style.borderColor);
            }
            if (style.className) {
                hot.setCellMeta(row, col, 'className', style.className);
            }
            if (style.rotation !== undefined) {
                hot.setCellMeta(row, col, 'rotation', style.rotation);
            }
        });

        hot.render();
    }
};

// Export Json-ba
function exportToJson(hotInstance) {
    const json = hotInstance.getData().map((row, rowIndex) => {
        return row.map((cell, colIndex) => {
            const cellMeta = hotInstance.getCellMeta(rowIndex, colIndex);
            if (cellMeta.renderer === imageRenderer) {
                // Ha a cella m√°r tartalmaz data URI-t, haszn√°ld azt
                if (typeof cell === 'string' && cell.startsWith('data:image')) {
                    return cell;
                } else {
                    // Ha csak base64 string, form√°zd data URI-v√°
                    return `data:image/png;base64,${cell}`;
                }
            }
            return cell;
        });
    });
    return json;
}

// Sorsz√°moz√°s friss√≠t√©se f√ºggv√©ny - utols√≥ 10 sorban nem m√≥dos√≠t semmit
function updateRowNumbers(hot) {
    const rowCount = hot.countRows();
    
    // Ne sz√°mozzuk az utols√≥ 10 sort
    const lastNumberedRow = rowCount - 11; // Az utols√≥ sz√°mozott sor indexe
    
    // Csak a 11. √©s az utols√≥ 10 sor k√∂z√∂tti sorokat sz√°mozzuk
    let counter = 1; // Kezd≈ë sorsz√°m
    
    for (let row = 11; row <= lastNumberedRow; row++) {
        // A 0. oszlopba be√≠rjuk a sorsz√°mot
        hot.setDataAtCell(row, 0, counter.toString());
        counter++;
    }
    
    // Az utols√≥ 10 sort nem m√≥dos√≠tjuk, meghagyjuk az eredeti tartalmukat
}

// Handsontable inicializ√°l√°sa
let hot;

// Undo/Redo esem√©nykezel≈ëk hozz√°ad√°sa
document.getElementById('undo').addEventListener('click', () => {
    if (hot) {
        hot.undo();
    }
});

document.getElementById('redo').addEventListener('click', () => {
    if (hot) {
        hot.redo();
    }
});

// Handsontable tov√°bbi inicializ√°l√°sa
function displayEditableTable(data, mergeCells, colWidths, rowHeights) {
    const container = document.getElementById('tableContainer');

    // Ellen≈ërizz√ºk, hogy a hot l√©tezik-e √©s m√©g nem lett elpuszt√≠tva
    if (hot && !hot.isDestroyed) {
        hot.destroy();
    }

    // Dropdown opci√≥k defin√≠ci√≥ja
    const typeOptions = [
        'Munkater√ºletre val√≥ lejut√°s/feljut√°s', 'Lehat√°rol√°s, elker√≠t√©s', 'Viselked√©s',
        'Vegyianyagok', 'Besz√°ll√°sos munka', 'Emel≈ëg√©pek, emel√©shez haszn√°lt eszk√∂z√∂k',
        'Emel√©si m≈±velet', 'Dokument√°ci√≥k, Iratok', 'Munkater√ºleten val√≥ k√∂zleked√©s (j√°rm≈±)',
        'Elektromos hib√°k', 'K√∂rnyezetk√°ros√≠t√≥ hat√°sok', 'F√∂ldmunka', 'Lees√©s elleni v√©delem',
        'T≈±zv√©delem', 'Eg√©szs√©get k√°ros√≠t√≥', 'T≈±zvesz√©lyes munka', 'Rendtart√°s', 'Megvil√°g√≠t√°s',
        'Fel√ºlvzsg√°latok, tesztek', 'LMRA, Toolbox, Munkav√©gz√©s el≈ëtti megbesz√©l√©s',
        'Anyag rendez√©s', 'Zajterhel√©s', 'Egy√©ni v√©d≈ëeszk√∂z√∂k', '√Ållv√°nyoz√°s, Munkaeszk√∂z√∂k',
        'Munka organiz√°ci√≥', 'Munkaenged√©ly', 'Hullad√©kkezel√©s', 'Cs√∫sz√°s- √©s botl√°svesz√©ly',
        '√Åtsz√∫r√°s elleni v√©delem', 'Jel√∂l√©sek', 'G√°zpalack t√°rol√°s',
        'Munkater√ºleten val√≥ k√∂zleked√©s (gyalogos)', 'Nem besorolt'
    ];

    const categoryOptions = [
        'Nem biztons√°gos munkav√©gz√©s',
        'Nem biztons√°gos √°llapot',
        'J√≥ gyakorlat'
    ];

const riskOptions = [
    { value: 'Alacsony', color: '#ffff00' },
    { value: 'K√∂zepes', color: '#ed7d31' },
    { value: 'Magas', color: '#ff0000' },
    { value: '-', color: 'white' } // Ez a sor most m√°r "white", de a k√≥dban dinamikusan fel√ºl√≠rjuk
];

const statusOptions = [
    { value: 'Nyitott', color: '#ff0000' },
    { value: 'Lez√°rt', color: '#92d050' },
    { value: 'Folyamatban', color: '#ffff00' },
    { value: 'Nem teljes√≠tett', color: 'grey' },
    { value: 'Felsz√≥l√≠t√°s ut√°n teljes√≠tve', color: '#ffd966' },
    { value: 'NA', color: 'white' } // Hasonl√≥an, ezt is dinamikusan fel√ºl√≠rjuk
];

// Egyedi renderer a sz√≠nes cell√°khoz
function colorRenderer(instance, td, row, col, prop, value, cellProperties) {
    Handsontable.renderers.TextRenderer.apply(this, arguments);

    if (cellProperties.type === 'dropdown') {
        Handsontable.renderers.DropdownRenderer.apply(this, arguments);
    }

    const rowCount = instance.countRows();
    const tenthRowFromBottom = rowCount - 10;

    if (row === tenthRowFromBottom && (col === 0 || col === 1)) {
        td.style.backgroundColor = 'black';
        td.style.color = 'yellow';
        td.style.fontWeight = 'bold';
        instance.setCellMeta(row, col, 'backgroundColor', 'black');
        instance.setCellMeta(row, col, 'color', 'yellow');
        instance.setCellMeta(row, col, 'fontWeight', 'bold');
        return;
    }

    if ((row < 7 && row > 2) || row === 8 || row === 10) {
        td.style.backgroundColor = 'black';
        td.style.color = 'yellow';
        td.style.fontWeight = 'bold';
        instance.setCellMeta(row, col, 'backgroundColor', 'black');
        instance.setCellMeta(row, col, 'color', 'yellow');
        instance.setCellMeta(row, col, 'fontWeight', 'bold');
        return;
    }

    // --- M√ìDOS√çTOTT K√ìD ---
    if (col === 7) {
        // Ha az √©rt√©k '-', akkor dinamikusan √°ll√≠tjuk be a sz√≠nt
        if (value === '-') {
            const rowColor = getRowColor(row, instance);
            td.style.backgroundColor = rowColor;
            td.style.color = 'black'; // A sz√∂veg sz√≠ne maradjon fekete
            instance.setCellMeta(row, col, 'backgroundColor', rowColor);
            instance.setCellMeta(row, col, 'color', 'black');
            return;
        }

        const riskOption = riskOptions.find(option => option.value === value);
        if (riskOption) {
            td.style.backgroundColor = riskOption.color;
            td.style.color = 'black';
            instance.setCellMeta(row, col, 'backgroundColor', riskOption.color);
            instance.setCellMeta(row, col, 'color', 'black');
            return;
        }
    }

    // --- M√ìDOS√çTOTT K√ìD ---
    if (col === 10) {
        // Ha az √©rt√©k 'NA', akkor dinamikusan √°ll√≠tjuk be a sz√≠nt
        if (value === 'NA') {
            const rowColor = getRowColor(row, instance);
            td.style.backgroundColor = rowColor;
            td.style.color = 'black'; // A sz√∂veg sz√≠ne maradjon fekete
            instance.setCellMeta(row, col, 'backgroundColor', rowColor);
            instance.setCellMeta(row, col, 'color', 'black');
            return;
        }
        
        const statusOption = statusOptions.find(option => option.value === value);
        if (statusOption) {
            td.style.backgroundColor = statusOption.color;
            td.style.color = 'black';
            instance.setCellMeta(row, col, 'backgroundColor', statusOption.color);
            instance.setCellMeta(row, col, 'color', 'black');
            return;
        }
    }

    if (value && (value.startsWith('data:image') || value.startsWith('/uploads/'))) {
        return;
    }

    // El≈ësz√∂r a 'backgroundColor' metaadatot ellen≈ërizz√ºk
    const storedBackgroundColor = cellProperties.backgroundColor;
    if (storedBackgroundColor) {
        td.style.backgroundColor = storedBackgroundColor;
        td.style.color = storedBackgroundColor === 'black' ? 'yellow' : 'black';
        return;
    }

    // Ha nincs 'backgroundColor', akkor n√©zz√ºk a 'color' metaadatot a besz√∫rt sorokhoz
    const storedColor = cellProperties.color;
    if (row >= 11 && row < tenthRowFromBottom && storedColor) {
        td.style.backgroundColor = storedColor;
        td.style.color = 'black'; // A sz√∂veg sz√≠ne maradjon fekete a besz√∫rt sorokban
        return;
    }

    // Ha nincs t√°rolt sz√≠n a metaadatokban, akkor n√©zz√ºk a localStorage-t
    const rowColors = JSON.parse(localStorage.getItem('rowColors')) || {};
    if (rowColors[row]) {
        td.style.backgroundColor = rowColors[row];
        td.style.color = rowColors[row] === 'black' ? 'yellow' : 'black';
        return;
    }

    // Besz√∫rt dinamikus sorok altern√°l√≥ sz√≠nez√©se (√°tdolgozva)
    if (row >= 11 && row < tenthRowFromBottom) {
        // Az eltol√°s biztos√≠tja, hogy az els≈ë dinamikus sor feh√©r legyen
        const isEven = (row - 11) % 2 === 0;
        const backgroundColor = isEven ? 'white' : '#fff2cc';
        td.style.backgroundColor = backgroundColor;
        td.style.color = 'black';
        
        // Be√°ll√≠tjuk a metaadatot √©s mentj√ºk a LocalStorage-ba is
        instance.setCellMeta(row, col, 'backgroundColor', backgroundColor);
        instance.setCellMeta(row, col, 'color', 'black');
        
        // Friss√≠tj√ºk a rowColors objektumot
        if (!rowColors[row]) {
            rowColors[row] = backgroundColor;
            localStorage.setItem('rowColors', JSON.stringify(rowColors));
        }
    }
}

// Dinamikusan meghat√°rozza a sor sz√≠n√©t
function getRowColor(row, hotInstance) {
    if ((row < 7 && row > 2) || row === 10) {
        return 'black';
    }

    // Az els≈ë 11 sor sz√≠ne ne v√°ltozzon alap√©rtelmezetten
    if (row < 11) {
        return ''; // Vagy 'white', ha alap√©rtelmezetten feh√©rnek kell lennie
    }

    const rowCount = hotInstance.countRows();
    const tenthRowFromBottom = rowCount - 10;
    
    // Ha az utols√≥ 10 sorban vagyunk, nem alkalmazunk sz√≠nt
    if (row >= tenthRowFromBottom) {
        return '';
    }
    
    // Besz√∫rt dinamikus sorok - az els≈ë FEH√âR legyen, nem sz√ºrke
    const isEven = (row - 11) % 2 === 0;
    return isEven ? 'white' : '#fff2cc';
}

// A getInitialRowColor f√ºggv√©nyt is m√≥dos√≠tjuk
function getInitialRowColor(row, hotInstance) {
    const rowCount = hotInstance.countRows();
    const tenthRowFromBottom = rowCount - 10;
    
    if ((row < 7 && row > 2) || row === 10) return 'black';
    
    // A 11. sort√≥l az utols√≥ 10 sor kezdet√©ig alkalmazzuk a v√°ltakoz√≥ sz√≠neket
    if (row >= 11 && row < tenthRowFromBottom) {
        const isEven = (row - 11) % 2 === 0;
        return isEven ? 'white' : '#fff2cc';
    }
    
    return ''; // Alap√©rtelmezett √©rt√©k
}
    
// Define saveRowColor (m√≥dos√≠tva, hogy figyelembe vegye az els≈ë 11 sort)
function saveRowColor(row, color) {
    const rowColors = JSON.parse(localStorage.getItem('rowColors')) || {};
    
    // A dinamikus sorok sz√≠neinek ment√©se
    if (row >= 11) {
        rowColors[row] = color;
        localStorage.setItem('rowColors', JSON.stringify(rowColors));
    }
}

// Define loadRowColors (m√≥dos√≠tva)
function loadRowColors(hotInstance) {
    console.log("loadRowColors f√ºggv√©ny megh√≠vva");

    const rowColors = JSON.parse(localStorage.getItem('rowColors')) || {};
    console.log("Bet√∂lt√∂tt sor sz√≠nek:", rowColors);

    const rows = hotInstance.countRows();
    const cols = hotInstance.countCols();
    const lastTenRowsStart = rows - 10;

    for (let row = 0; row < rows; row++) {
        // Hagyjuk ki a fekete sorokat √âS az utols√≥ 10 sort
        if ((row < 7 && row > 2) || row === 8 || row === 10 || row >= lastTenRowsStart) continue;

        if (rowColors[row]) {
            console.log(`Sz√≠n alkalmaz√°sa a ${row}. sorra: ${rowColors[row]}`);
            for (let col = 0; col < cols; col++) {
                hotInstance.setCellMeta(row, col, 'renderer', colorRenderer);
                hotInstance.setCellMeta(row, col, 'color', rowColors[row]);
            }
        } else if (row >= 11 && row < lastTenRowsStart) {
            // M√≥dos√≠tott sor a v√°ltakoz√≥ sz√≠nez√©shez - az els≈ë dinamikus sor FEH√âR
            const isEven = (row - 11) % 2 === 0;
            const color = isEven ? 'white' : '#fff2cc';
            
            for (let col = 0; col < cols; col++) {
                hotInstance.setCellMeta(row, col, 'renderer', colorRenderer);
                hotInstance.setCellMeta(row, col, 'backgroundColor', color);
                hotInstance.setCellMeta(row, col, 'color', 'black');
            }
            
            // Ments√ºk el a sz√≠nt a localStorage-ba is
            rowColors[row] = color;
        } else if (row >= lastTenRowsStart) {
            // Az utols√≥ 10 sorban t√∂r√∂lj√ºk a 'color' √©s 'backgroundColor' metaadatot
            for (let col = 0; col < cols; col++) {
                hotInstance.setCellMeta(row, col, 'color', undefined);
                hotInstance.setCellMeta(row, col, 'backgroundColor', undefined);
            }
        }
    }
    
    // Ments√ºk el a friss√≠tett sz√≠neket
    localStorage.setItem('rowColors', JSON.stringify(rowColors));

    hotInstance.render();
    console.log("Sorsz√≠nek bet√∂ltve √©s alkalmazva");
}

console.log("A data objektum a Handsontable inicializ√°l√°sa el≈ëtt:", data);
    //Handsontable inicializ√°l√°sa
    hot = new Handsontable(container, {
        data: data,
        colHeaders: true,
        rowHeaders: true,
        undo: true, // Enged√©lyezi az undo/redo funkcionalit√°st
        redo: true,
        contextMenu: {
            items: {
                "row_above": {
  name: "Sor besz√∫r√°sa fel√ºlre",
  callback: function(key, selection) {
    const row = selection[0].start.row;
    this.alter('insert_row_above', row);
    const rowHeights = this.getSettings().rowHeights;
    rowHeights.splice(row, 0, 180);
    this.updateSettings({ rowHeights: rowHeights });
    const cols = this.countCols();
    for (let col = 0; col < cols; col++) {
      if (row < 7 || row === 10) continue;
      this.setCellMeta(row, col, 'renderer', colorRenderer);
      // A sz√≠n a getRowColor f√ºggv√©nyben dinamikusan gener√°l√≥dik
    }
    // Sorsz√°moz√°s friss√≠t√©se
    if (row >= 11) {
      updateRowNumbers(this);
    }
    this.render();
  }
},
"row_below": {
  name: "Sor besz√∫r√°sa alulra",
  callback: function(key, selection) {
    const row = selection[0].start.row;
    this.alter('insert_row_below', row);
    const rowHeights = this.getSettings().rowHeights;
    rowHeights.splice(row + 1, 0, 180);
    this.updateSettings({ rowHeights: rowHeights });
    const cols = this.countCols();
    for (let col = 0; col < cols; col++) {
      if (row + 1 < 7 || row + 1 === 10) continue; // +1 az als√≥ besz√∫r√°shoz
      this.setCellMeta(row + 1, col, 'renderer', colorRenderer);
      // A sz√≠n a getRowColor f√ºggv√©nyben dinamikusan gener√°l√≥dik
    }
    // Sorsz√°moz√°s friss√≠t√©se
    if (row >= 10) { // Alulra besz√∫r√°s eset√©n m√°r a 10. sort√≥l
      updateRowNumbers(this);
    }
    this.render();
  }
},
                "remove_row": {name: "Sor elt√°vol√≠t√°sa"},
                "upload_image": {
    name: "K√©p felt√∂lt√©se",
    callback: function () {
        const coords = hot.getSelected()[0];
        const projectId = document.getElementById('projectId').value; // Projekt ID lek√©r√©se

        if (!projectId) {
            alert('K√©rlek v√°lassz egy projektet!');
            return; // Kil√©p√©s, ha nincs projectId
        }

        if (coords) {
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = 'image/*';

            fileInput.addEventListener('change', function (event) {
                const file = event.target.files[0];
                if (file) {
                    const formData = new FormData();
                    formData.append('image', file);
                    formData.append('projectId', projectId); // Projekt ID hozz√°ad√°sa

                    // A backend felt√∂lt√©si √∫tvonala nem v√°ltozik
                    fetch('/reports/upload', {
                        method: 'POST',
                        body: formData,
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success && data.url) {
                            // A backend most m√°r GCS URL-t ad vissza
                            hot.setDataAtCell(coords[0], coords[1], data.url); // Friss√≠tj√ºk a cell√°t az √∫j URL-lel
                            hot.setCellMeta(coords[0], coords[1], 'renderer', imageRenderer); // Renderer hozz√°ad√°sa
                            hot.render(); // Friss√≠tj√ºk a t√°bl√°zatot
                        } else {
                            alert('Hiba t√∂rt√©nt a felt√∂lt√©s sor√°n.');
                        }
                    })
                    .catch(error => {
                        console.error('K√©p felt√∂lt√©si hiba:', error);
                        alert('Hiba t√∂rt√©nt a f√°jl felt√∂lt√©sekor.');
                    });
                }
            });

            fileInput.click();
        } else {
            alert('K√©rlek v√°lassz egy cell√°t a k√©p felt√∂lt√©s√©hez!');
        }
    }
},
              "rotate_image": {
    name: "K√©p forgat√°sa 90¬∞ jobbra",
    callback: function() {
        const coords = hot.getSelected()[0];
        if (coords) {
            const row = coords[0];
            const col = coords[1];
            const value = hot.getDataAtCell(row, col);

            // M√ìDOS√çT√ÅS: A felt√©tel most m√°r a GCS URL-t is kezeli
            if (value && (value.startsWith('data:image') || value.startsWith('https://storage.googleapis.com/'))) {
                // Get current rotation or default to 0
                let currentRotation = hot.getCellMeta(row, col).rotation || 0;

                // Add 90 degrees (modulo 360 to keep it between 0-359)
                let newRotation = (currentRotation + 90) % 360;

                // Always ensure the renderer is set before setting rotation
                hot.setCellMeta(row, col, 'renderer', imageRenderer);
                hot.setCellMeta(row, col, 'rotation', newRotation);

                // Explicitly log the new rotation to verify (can be removed in production)
                console.log(`Image rotated: row=${row}, col=${col}, rotation=${newRotation}`);

                hot.render();
            }
        }
    }
},
                "remove_image": {
    name: "K√©p elt√°vol√≠t√°sa",
    callback: function () {
        const coords = hot.getSelected()[0];
        if (coords) {
            const value = hot.getDataAtCell(coords[0], coords[1]);

            // M√ìDOS√çT√ÅS: A felt√©tel most m√°r a GCS URL-t is kezeli
            if (value && (value.startsWith('data:image') || value.startsWith('https://storage.googleapis.com/'))) {
                // Ha Base64 adat URI, akkor nem k√ºld√ºnk t√∂rl√©si k√©r√©st,
                // mert az nincs k√ºl√∂n f√°jlk√©nt t√°rolva a GCS-en.
                // Ha GCS URL, akkor k√ºld√ºnk t√∂rl√©si k√©r√©st.
                const imageUrlToDelete = value.startsWith('https://storage.googleapis.com/') ? value : null;

                hot.setDataAtCell(coords[0], coords[1], null); // T√∂r√∂lj√ºk a cella tartalm√°t
                hot.removeCellMeta(coords[0], coords[1], 'renderer'); // Elt√°vol√≠tjuk a renderer meta adatot
                hot.render(); // Friss√≠tj√ºk a t√°bl√°zatot

                if (imageUrlToDelete) {
                    // Itt a backend /reports/delete-image endpointj√°nak is tudnia kell
                    // GCS-r≈ël t√∂r√∂lni a f√°jlt az imageUrlToDelete alapj√°n!
                    fetch('/reports/delete-image', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ imageUrl: imageUrlToDelete }),
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            console.log('K√©p sikeresen t√∂r√∂lve a Google Cloud Storage-r≈ël');
                        } else {
                            console.error('Hiba a k√©p t√∂rl√©s√©ben a Google Cloud Storage-r≈ël:', data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Hiba a szerverrel val√≥ kommunik√°ci√≥ban k√©p t√∂rl√©sekor:', error);
                    });
                                }
                            }
                        }
                    }
                }
            }
        },
        manualRowInsert: true,
        manualColumnInsert: true,
        manualRowMove: true,
        manualColumnMove: true,
        manualRowResize: true,
        manualColumnResize: true,
        licenseKey: 'non-commercial-and-evaluation',
        mergeCells: mergeCells, // Egyes√≠tett cell√°k be√°ll√≠t√°sa
        colWidths: Array.isArray(colWidths) && colWidths.length > 0 ? colWidths : undefined,
        rowHeights: Array.isArray(rowHeights) && rowHeights.length > 0 ? rowHeights : undefined,
        // Oszlopok konfigur√°ci√≥ja
        columns: [
    { type: 'text' }, // 0-5 oszlop - sz√∂veg t√≠pus√∫ak maradnak
    { type: 'text' },
    { type: 'text' },
    { type: 'text' },
    { type: 'text' },
    {
        type: 'dropdown', // 5. oszlop - dropdown t√≠pus
        source: function(query, process) {
            const selectedRow = hot.getSelectedLast()[0];
            const rowCount = hot.countRows();
            const lastTenRowsStart = rowCount - 10;
            
            // Csak a dinamikus sorokra (11-t≈ël az utols√≥ 10 sor el≈ëttig)
            if (selectedRow >= 11 && selectedRow < lastTenRowsStart) {
                process(typeOptions);
            } else {
                process([]);
            }
        }
    },
    {
        type: 'dropdown', // 6. oszlop - dropdown t√≠pus
        source: function(query, process) {
            const selectedRow = hot.getSelectedLast()[0];
            const rowCount = hot.countRows();
            const lastTenRowsStart = rowCount - 10;
            
            if (selectedRow >= 11 && selectedRow < lastTenRowsStart) {
                process(categoryOptions);
            } else {
                process([]);
            }
        }
    },
    {
        type: 'dropdown', // 7. oszlop - dropdown t√≠pus
        source: function(query, process) {
            const selectedRow = hot.getSelectedLast()[0];
            const rowCount = hot.countRows();
            const lastTenRowsStart = rowCount - 10;
            
            if (selectedRow >= 11 && selectedRow < lastTenRowsStart) {
                process(riskOptions.map(option => option.value));
            } else {
                process([]);
            }
        },
        renderer: colorRenderer
    },
    { type: 'text' },
    { type: 'text' },
    {
        type: 'dropdown', // 10. oszlop - dropdown t√≠pus
        source: function(query, process) {
            const selectedRow = hot.getSelectedLast()[0];
            const rowCount = hot.countRows();
            const lastTenRowsStart = rowCount - 10;
            
            if (selectedRow >= 11 && selectedRow < lastTenRowsStart) {
                process(statusOptions.map(option => option.value));
            } else {
                process([]);
            }
        },
        renderer: colorRenderer
    },
    { type: 'text' }
],
        beforeChange: function(changes, source) {
  if (source === 'insert_row_above' || source === 'insert_row_below') {
    const rowHeights = this.getSettings().rowHeights || [];
    const rowCount = this.countRows();
    while (rowHeights.length < rowCount) {
      rowHeights.push(undefined); // Alap√©rtelmezett magass√°g
    }
    for (let i = 0; i < rowCount; i++) {
      if (i < 7 || i === 10) continue;
      if (!rowHeights[i]) {
        rowHeights[i] = 180;
      }
    }
    this.updateSettings({ rowHeights: rowHeights });
  }
},
afterCreateRow: function(index, amount) {
  const cols = this.countCols();
  for (let col = 0; col < cols; col++) {
    if (index < 7 || index === 10) continue;
    this.setCellMeta(index, col, 'renderer', colorRenderer);
    // √öj: A sz√≠n dinamikus be√°ll√≠t√°sa a cellMeta-ban
    const rowColor = getRowColor(index, this);
    if (rowColor) {
      this.setCellMeta(index, col, 'color', rowColor);
    }
  }
  this.render();
},
// Adjunk hozz√° egy beforeRender hook-ot
beforeRender: function(isForced) {
    // V√©gigmegy√ºnk az √∂sszes cell√°n
    const rows = this.countRows();
    const cols = this.countCols();
    for (let row = 0; row < rows; row++) {
        for (let col = 0; col < cols; col++) {
            const value = this.getDataAtCell(row, col);
            // M√ìDOS√çT√ÅS: GCS URL-ek kezel√©se
            if (value && (value.startsWith('data:image') || value.startsWith('https://storage.googleapis.com/'))) {
                this.setCellMeta(row, col, 'renderer', imageRenderer);
            }
        }
    }
},

        // Adjunk hozz√° egy afterLoadData hook-ot
       afterLoadData: function(initialLoad) {
    if (initialLoad) {
        // Cellast√≠lusok vissza√°ll√≠t√°sa
        if (data.cellStyles && Array.isArray(data.cellStyles)) {
            data.cellStyles.forEach(style => {
                const row = style.row;
                const col = style.col;
                // Be√°ll√≠tjuk a renderereket √©s metaadatokat
                const value = this.getDataAtCell(row, col);
                // M√ìDOS√çT√ÅS: GCS URL-ek kezel√©se
                if (value && (value.startsWith('data:image') || value.startsWith('https://storage.googleapis.com/'))) {
                    this.setCellMeta(row, col, 'renderer', imageRenderer);
                    if (style.rotation !== undefined) {
                        this.setCellMeta(row, col, 'rotation', style.rotation);
                        console.log(`K√©p forgat√°s vissza√°ll√≠tva: sor=${row}, oszlop=${col}, forgat√°s=${style.rotation}`);
                    }
                }
                if (style.color) {
                    // Itt nem √°ll√≠tjuk be a sz√≠nt, mert a colorRenderer kezeli
                }
            });
            this.render(); // √öjrarajzol√°s
        }
    }
},
        // Adjunk hozz√° egy afterRemoveRow esem√©nykezel≈ët a Handsontable inicializ√°l√°s√°hoz
        afterRemoveRow: function(index, amount) {
  const rowsRemoved = amount || 1;
  const storedColors = JSON.parse(localStorage.getItem('rowColors')) || {};
  const updatedColors = {};

  Object.keys(storedColors).forEach(rowStr => {
    const row = parseInt(rowStr);
    if (row < index) {
      updatedColors[row] = storedColors[row];
    } else if (row >= index + rowsRemoved) {
      updatedColors[row - rowsRemoved] = storedColors[row];
    }
  });
  localStorage.setItem('rowColors', JSON.stringify(updatedColors));

  const rowHeights = this.getSettings().rowHeights || [];
  if (Array.isArray(rowHeights) && rowHeights.length > 0) {
    rowHeights.splice(index, rowsRemoved);
    this.updateSettings({ rowHeights: rowHeights });
  }

  if (index >= 11) {
    updateRowNumbers(this);
  }
  this.render();
},
cells: function (row, col) {
    const cellMeta = {};
    const value = this.instance.getDataAtCell(row, col);
    const lastRowIndex = this.instance.countRows() - 1;
    const tenthFromLastRowIndex = lastRowIndex - 9; // Utols√≥ el≈ëtti 10. sor indexe

    // FEKETE CELL√ÅK BE√ÅLL√çT√ÅSA (hozz√°adva a row === 10 felt√©tel)
    if ((row < 7 && row > 2) || row === 8 || row === 10 || (row === tenthFromLastRowIndex && (col === 0 || col === 1))) {
        cellMeta.renderer = 'html';
        cellMeta.className = cellMeta.className ? cellMeta.className + ' black-cell' : 'black-cell';
    }

    // K√ñZ√âPRE IGAZ√çT√ÅS az utols√≥ sort√≥l visszafel√© sz√°molt 10. sor els≈ë k√©t cell√°j√°ban
    if (row === tenthFromLastRowIndex && (col === 0 || col === 1)) {
        const style = {
            'display': 'flex',
            'justify-content': 'center',
            'align-items': 'center',
            'text-align': 'center'  // Horizont√°lis igaz√≠t√°s biztos√≠t√°sa
        };
        cellMeta.style = style;
        // Adjunk hozz√° egy extra oszt√°lyt a k√∂z√©pre igaz√≠t√°shoz
        cellMeta.className = cellMeta.className ? cellMeta.className + ' cell-centered' : 'cell-centered';
    }

    // Egy√©b fekete cell√°k eset√©n is k√∂z√©pre igaz√≠t√°s, ha sz√ºks√©ges (hozz√°adva a row === 10 felt√©tel)
    else if ((row < 7 && row > 2) || row === 8 || row === 10) {
        const style = {
            'display': 'flex',
            'justify-content': 'center',
            'align-items': 'center',
            'text-align': 'center' // Fontos a v√≠zszintes igaz√≠t√°s!
        };
        cellMeta.style = style;
    }

    // M√ìDOS√çT√ÅS: GCS URL-ek kezel√©se
    if (typeof value === 'string' && (value.startsWith('data:image') || value.startsWith('https://storage.googleapis.com/'))) {
        cellMeta.renderer = imageRenderer;
        cellMeta.className = 'image-cell';
    }

    if (row === 0) {
        cellMeta.className = 'first-row-style';
    }

    if (row === 10) {
        cellMeta.className = cellMeta.className ? cellMeta.className + ' eleventh-row-style' : 'eleventh-row-style';
    }

    if (row === lastRowIndex) {
        cellMeta.className = cellMeta.className ? cellMeta.className + ' last-row-style' : 'last-row-style';
    }

    // F√ºgg≈ëleges sz√∂veg be√°ll√≠t√°sa a 11. sor 1. oszlop√°ban (ez m√°r itt van)
    if (row === 10 && col === 0) {
        cellMeta.className = cellMeta.className ? cellMeta.className + ' vertical-text' : 'vertical-text';
    }

    // F√ºgg≈ëleges sz√∂veg be√°ll√≠t√°sa az utols√≥t√≥l visszafel√© sz√°m√≠tott 10. sor 1. oszlop√°ban
    if (row === tenthFromLastRowIndex && col === 0) {
        cellMeta.className = cellMeta.className ? cellMeta.className + ' vertical-text' : 'vertical-text';
    }

    // 8. sor √©s 11. sor k√∂z√©pre igaz√≠t√°sa, *mindig* (itt a 11. sorra vonatkoz√≥ r√©sz m√°r j√≥)
    if (row === 8 || row === 10) {
        cellMeta.className = cellMeta.className ? cellMeta.className + ' htCenter' : 'htCenter';
    }

    // 11. sor felett k√∂z√©pre igaz√≠t√°s, *mindig* (de csak 5. oszlopt√≥l kezdve)
    if (row > 10 && col >= 5) {
        cellMeta.className = cellMeta.className ? cellMeta.className + ' htCenter' : 'htCenter';
    }

    return cellMeta;
},
    });
    loadRowColors(hot); // <--- IDE, k√∂zvetlen√ºl a Handsontable l√©trehoz√°sa UT√ÅN
    // √öj: K√©pek forgat√°s√°nak explicit vissza√°ll√≠t√°sa
    if (data.cellStyles && Array.isArray(data.cellStyles)) {
        setTimeout(() => {
            data.cellStyles.forEach(style => {
                if (style.rotation !== undefined) {
                    const row = style.row;
                    const col = style.col;
                    const value = hot.getDataAtCell(row, col);

                    // M√ìDOS√çT√ÅS: GCS URL-ek kezel√©se
                    if (value && (value.startsWith('data:image') || value.startsWith('https://storage.googleapis.com/'))) {
                        hot.setCellMeta(row, col, 'renderer', imageRenderer);
                        hot.setCellMeta(row, col, 'rotation', style.rotation);
                        console.log(`K√©sleltetett k√©p forgat√°s be√°ll√≠tva: sor=${row}, oszlop=${col}, forgat√°s=${style.rotation}`);
                    }
                }
            });
            hot.render();
        }, 200); // Kis k√©sleltet√©s a DOM friss√≠t√©s√©nek biztos√≠t√°sa √©rdek√©ben
    }
    // Friss√≠ts√ºk a sorok sz√≠neit a t√°bl√°zat inicializ√°l√°sakor is
    if (hot && hot.render) {
        hot.render();
    }
}

// √öj jegyz≈ëk√∂nyv gener√°l√°sa
document.getElementById('generateReportBtn').addEventListener('click', () => {
    const data = Array(22).fill().map(() => Array(12).fill(''));

    // Statikus tartalom be√°ll√≠t√°sa
    data[0][3] = "Heti munkav√©delmi bej√°r√°si jegyz≈ëk√∂nyv";
    data[0][1] = "K√©p helye";
    data[0][9] = "K√©p helye";
    data[3][1] = "D√°tum:";
    data[3][6] = "Bej√°r√°st v√©gezte:";
    data[4][1] = "Projekt megnevez√©se:";
    data[4][6] = "Telefonsz√°m:";
    data[5][6] = "HSE megb√≠zott:";
    data[5][7] = "IWS Solutions Kft.";
    data[5][1] = "Helysz√≠n:";
    data[6][6] = "C√≠m:";
    data[6][7] = "2040 Buda√∂rs (Terrapark), Pusk√°s Tivadar √∫t 14/C.";
    data[6][1] = "√âp√≠tkez√©s jellege:";
    data[8][3] = "√âszrev√©telek, megfigyel√©sek, megjegyz√©sek";
    data[11][0] = "1";
    data[18][3] = "Pecs√©t helye";

    data[10] = [
        "Sorsz√°m", "Megfigyel√©s", "Megold√°s/ Javaslat/ Megjegyz√©s",
        "√ârintett C√©g", "F√©nyk√©p", "Kateg√≥ria", "Oszt√°lyoz√°s",
        "Hiba s√∫lyoss√°ga", "Jegyz≈ëk√∂nyvbe felv√©ve", "Hat√°rid≈ë",
        "St√°tusz", "Kiszabhat√≥ b√≠rs√°g √∂sszege, szankci√≥s list√°ban szerepl≈ë sorsz√°ma"
    ];

    data[12][0] = "Sorsz√°m";
    data[12][1] = "Ellen≈ërz√©skor a helysz√≠nen dolgoz√≥ c√©gek list√°ja";

    // Sz√°mozott sorok
    for (let i = 13; i <= 20; i++) {
        data[i][0] = (i - 12).toString();
    }
    data[21][0] = "A fenti jegyz≈ëk√∂nyv tartalma az √©rintett c√©gek al√°√≠r√°sa n√©lk√ºl is √©rv√©nyesnek tekintend≈ë!";

    // Egyes√≠tett cell√°k be√°ll√≠t√°sa
    const mergeCells = [
        { row: 0, col: 3, rowspan: 1, colspan: 5 },
        { row: 0, col: 9, rowspan: 1, colspan: 2 },
        { row: 1, col: 0, rowspan: 1, colspan: 12 },
        { row: 3, col: 2, rowspan: 1, colspan: 2 },
        { row: 4, col: 2, rowspan: 1, colspan: 2 },
        { row: 5, col: 2, rowspan: 1, colspan: 2 },
        { row: 5, col: 7, rowspan: 1, colspan: 4 },
        { row: 6, col: 2, rowspan: 1, colspan: 2 },
        { row: 6, col: 7, rowspan: 1, colspan: 4 },
        { row: 8, col: 3, rowspan: 1, colspan: 5 },
        { row: 8, col: 9, rowspan: 1, colspan: 2 },
        { row: 12, col: 1, rowspan: 1, colspan: 2 },
        { row: 13, col: 1, rowspan: 1, colspan: 2 },
        { row: 12, col: 5, rowspan: 9, colspan: 7 },
        { row: 14, col: 1, rowspan: 1, colspan: 2 },
        { row: 15, col: 1, rowspan: 1, colspan: 2 },
        { row: 16, col: 1, rowspan: 1, colspan: 2 },
        { row: 18, col: 3, rowspan: 3, colspan: 2 },
        { row: 17, col: 1, rowspan: 1, colspan: 2 },
        { row: 18, col: 1, rowspan: 1, colspan: 2 },
        { row: 19, col: 1, rowspan: 1, colspan: 2 },
        { row: 20, col: 1, rowspan: 1, colspan: 2 },
        { row: 21, col: 0, rowspan: 1, colspan: 12 }
    ];

    // √úres sorok jel√∂l√©se
    [2, 7, 9].forEach(row => {
        mergeCells.push({ row, col: 0, rowspan: 1, colspan: 12 });
    });

    // localStorage √ºr√≠t√©se
    localStorage.removeItem('rowColors');

    // A k√≠v√°nt kezdeti oszlop sz√©less√©gek
    const initialColWidths = [
        40,   // 1. oszlop: 40px
        180,  // 2. oszlop: 180px
        180,  // 3. oszlop: 180px
        100,   // 4. oszlop: 80px
        160,  // 5. oszlop: 120px
        120,  // 6. oszlop: 120px
        150,  // 7. oszlop: 120px
        120,  // 8. oszlop: 120px
        130,  // 9. oszlop: 120px
        90,   // 10. oszlop: 90px
        100,   // 11. oszlop: 90px
        110   // 12. oszlop: 110px
    ];

    // A k√≠v√°nt kezdeti sor magass√°gok
    const initialRowHeights = Array(22).fill(30); // Alap√©rtelmezett magass√°g minden sornak
    
    // Speci√°lis magass√°g√∫ sorok be√°ll√≠t√°sa
    initialRowHeights[0] = 80;  // 1. sor: 
    // 2-9. sor marad 30px
    initialRowHeights[10] = 180; // 11. sor: 180px
    initialRowHeights[11] = 180; // 
    initialRowHeights[12] = 70; // 
    initialRowHeights[13] = 50; // 
    initialRowHeights[14] = 50; // 
    initialRowHeights[15] = 50; // 
    initialRowHeights[16] = 50; // 
    initialRowHeights[17] = 50; // 
    initialRowHeights[18] = 50; // 
    initialRowHeights[19] = 50; // 
    initialRowHeights[20] = 50; // 
    
    // T√°bl√°zat l√©trehoz√°sa a kezdeti be√°ll√≠t√°sokkal
    displayEditableTable(data, mergeCells, initialColWidths, initialRowHeights);
});

// Jegyz≈ëk√∂nyv bet√∂lt√©se
document.getElementById('loadReportBtn').addEventListener('click', () => {
    const projectId = document.getElementById('projectId').value;

    fetch(`/reports/${projectId}/report`)
        .then(response => response.json())
        .then(data => {
            console.log("Frontend: API v√°lasz a bet√∂lt√©shez:", data);

            if (data.success && data.data) {
                // ... (bet√∂lt√©si logika v√°ltozatlan) ...
                
                const mergeCells = data.mergeCells || [];
                const colWidths = Array.isArray(data.colWidths) && data.colWidths.length ? data.colWidths : undefined;
                const rowHeights = Array.isArray(data.rowHeights) && data.rowHeights.length ? data.rowHeights : undefined;
                const cellStyles = data.cellStyles || [];

                console.log("Frontend: Bet√∂lt√∂tt adatok:", { data: data.data, mergeCells, colWidths, rowHeights, cellStyles });

                displayEditableTable(data.data, mergeCells, colWidths, rowHeights);

                // A cellast√≠lusok be√°ll√≠t√°sa a setupInitialCellStyles f√ºggv√©ny seg√≠ts√©g√©vel
                if (cellStyles && Array.isArray(cellStyles)) {
                    setTimeout(() => {
                        setupInitialCellStyles(hot, { cellStyles: cellStyles });
                        console.log("Frontend: Kezdeti cellast√≠lusok be√°ll√≠tva a bet√∂lt√©s ut√°n.");
                    }, 300); // Kis k√©sleltet√©s a t√°bl√°zat inicializ√°l√≥d√°s√°hoz
                } else {
                    console.log("Frontend: Nincsenek cellast√≠lusok a bet√∂lt√∂tt adatokban vagy nem t√∂mb form√°tumban √©rkeztek.");
                }

            } else {
                alert(data.message || 'Nem tal√°lhat√≥ jelent√©s.');
            }
        })
        .catch(error => {
            console.error('Frontend: Hiba t√∂rt√©nt a jelent√©s bet√∂lt√©sekor:', error);
        });
});

// Jegyz≈ëk√∂nyv ment√©se
document.getElementById('saveReportBtn').addEventListener('click', async () => {
    const projectId = document.getElementById('projectId').value;
    
    // üõë √öJ: Kinyerj√ºk a projektt√≠pust a DOM-b√≥l. 
    // Felt√©telezve, hogy az EJS sablon tartalmazza: <input type="hidden" id="projectType" value="IWS Solutions">
    const projectTypeElement = document.getElementById('projectType');
    const projectType = projectTypeElement ? projectTypeElement.value : 'IWS Solutions'; 

    if (!hot) {
        alert('Nincs bet√∂lt√∂tt jegyz≈ëk√∂nyv a ment√©shez!');
        return;
    }

    // Meger≈ës√≠t≈ë alert hozz√°ad√°sa
    const confirmSave = window.confirm('Biztosan szeretn√© menteni a jegyz≈ëk√∂nyvet?');
    if (!confirmSave) {
        return; // Ha a felhaszn√°l√≥ a "Nem" gombra kattint, a ment√©s megszakad
    }

    // Alapadatok √∂sszegy≈±jt√©se
    const data = hot.getData(); 
    const mergePlugin = hot.getPlugin('mergeCells');
    const currentMergeCells = mergePlugin
        ? mergePlugin.mergedCellsCollection.mergedCells
        : [];

    // Oszlop √©s sor m√©retek lek√©r√©se
    const columnSizes = Array.from(
        { length: hot.countCols() },
        (_, index) => hot.getColWidth(index)
    );

    const rowSizes = Array.from(
        { length: hot.countRows() },
        (_, index) => hot.getRowHeight(index)
    );

    // Cellast√≠lusok √∂sszegy≈±jt√©se a cellMeta-b√≥l
    const cellStyles = [];
    const totalRows = hot.countRows();
    const totalCols = hot.countCols();

    console.log("Frontend: Cellast√≠lusok √∂sszegy≈±jt√©se a cellMeta-b√≥l...");
    for (let row = 0; row < totalRows; row++) {
        for (let col = 0; col < totalCols; col++) {
            const cellMeta = hot.getCellMeta(row, col);
            const styleObject = {};

            if (cellMeta.backgroundColor) {
                styleObject.backgroundColor = cellMeta.backgroundColor;
            }
            if (cellMeta.color) {
                styleObject.color = cellMeta.color;
            }
            if (cellMeta.fontWeight) {
                styleObject.fontWeight = cellMeta.fontWeight;
            }
            if (cellMeta.fontSize) {
                styleObject.fontSize = cellMeta.fontSize;
            }
            if (cellMeta.textAlign) {
                styleObject.textAlign = cellMeta.textAlign;
            }
            if (cellMeta.borderColor) {
                styleObject.borderColor = cellMeta.borderColor;
            }
            if (cellMeta.className) {
                styleObject.className = cellMeta.className;
            }
            if (cellMeta.rotation !== undefined) {
                styleObject.rotation = cellMeta.rotation;
            }

            // Csak akkor adjuk hozz√° a cell√°hoz a st√≠lust, ha van legal√°bb egy be√°ll√≠tott st√≠lus
            if (Object.keys(styleObject).length > 0) {
                styleObject.row = row;
                styleObject.col = col;
                cellStyles.push(styleObject);
            }
        }
    }

    // Debug: Ellen≈ërizz√ºk a mentett cellast√≠lusokat
    console.log("Frontend: Mentett cellStyles (cellMeta-b√≥l):", cellStyles);

    try {
        const response = await fetch('/reports/save', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                data: data, 
                projectId: projectId,
                // üõë JAV√çT√ÅS: HOZZ√ÅADVA A projectType MEZ≈êT A BACKEND SZ√ÅM√ÅRA üõë
                projectType: projectType, 
                mergeCells: currentMergeCells,
                columnSizes: columnSizes,
                rowSizes: rowSizes,
                cellStyles: cellStyles
            }),
        });

        const result = await response.json();

        if (result.success) {
            alert(result.message || 'Jelent√©s sikeresen mentve!');
            console.log("Frontend: Jelent√©s ment√©se sikeres. Report ID:", result.reportId);
        } else {
            alert(result.message || 'Hiba t√∂rt√©nt a ment√©s sor√°n.');
        }
    } catch (error) {
        console.error('Hiba t√∂rt√©nt a ment√©skor:', error);
        alert('Hiba t√∂rt√©nt a ment√©s sor√°n. K√©rj√ºk pr√≥b√°lja √∫jra.');
    }
});
    </script>

<!-- .xlsx let√∂lt√©s -->
<!--<form action="/reports//download" method="GET">
    <button type="submit">Let√∂lt√©s .xlsx</button>
</form> -->

<!-- .pdf let√∂lt√©s -->
 <form action="/reports/<%= projectId %>/download-pdf" method="GET">
    <button type="submit" class="btn-blue"><i class="fas fa-file-pdf"></i> PDF EXPORT√ÅL√ÅSA</button>
</form>
    
    <form action="/user/projects" method="GET">
        <button type="submit" class="logout-btn"><i class="fas fa-arrow-left"></i> Vissza a projektekhez</button>
    </form>

</body>
</html>




