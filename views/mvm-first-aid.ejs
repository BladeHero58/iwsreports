<!--7. Kateg√≥ria: Els≈ëseg√©lyny√∫jt√°s --->
<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>7. Els≈ëseg√©lyny√∫jt√°s - <%= project.name %></title>
     <link rel="stylesheet" href="/css/pages/mvm-documentation.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.min.js"></script>
    <!-- ‚≠ê EXIF.js - √∫jabb verzi√≥ mobilos kompatibilit√°ssal -->
    <script src="https://cdn.jsdelivr.net/npm/exif-js@2.3.0/exif.min.js"></script>

    <!-- ‚≠ê HEIC to JPEG konverzi√≥hoz -->
    <script src="https://cdn.jsdelivr.net/npm/heic2any@0.0.4/dist/heic2any.min.js"></script>

    <!-- ‚≠ê exifr - HEIC EXIF t√°mogat√°ssal (TELJES verzi√≥ GPS parsing-gel) -->
    <script src="https://cdn.jsdelivr.net/npm/exifr@7.1.3/dist/full.umd.js"></script>

    <!-- ‚≠ê piexifjs - GPS √≠r√°sra/olvas√°sra optimaliz√°lt (mobil kompatibilit√°s) -->
    <script src="https://cdn.jsdelivr.net/npm/piexifjs@1.0.6/piexif.min.js"></script>

    <!-- ‚≠ê EXIF metaadatok megjelen√≠t√©s√©re CSS -->

</head>
<body>

    <%
// Eld√∂ntj√ºk hogy admin vagy user oldal kell
const isAdmin = user.isAdmin || false;
const backUrl = isAdmin
    ? `/admin/projects/${project.id}`
    : `/user/projects/${project.id}`;
%>

<a href="<%= backUrl %>" class="back-button">
    <i class="fas fa-arrow-left"></i> Vissza a kateg√≥ri√°khoz
</a>

    <div class="container">

        <!-- Projekt inform√°ci√≥k -->
        <div class="project-info">
            <h3><i class="fas fa-project-diagram"></i> Projekt r√©szletek</h3>

            <div class="form-group" style="margin-bottom: 15px;">
                <label for="projectName"><strong>Projekt neve:</strong></label>
                <input type="text" id="projectName" name="projectName" value="<%= project.name %>" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
            </div>

            <div class="form-group" style="margin-bottom: 15px;">
                <label for="inspectionDate"><strong>D√°tum:</strong></label>
                <input type="date" id="inspectionDate" name="inspectionDate" onchange="updateSerialNumber()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
            </div>

            <div class="form-group" style="margin-bottom: 15px;">
                <label for="serialNumber"><strong>Sorsz√°m:</strong></label>
                <input type="text" id="serialNumber" name="serialNumber" placeholder="Pl. IWS/BCS/20251201" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                <% if (project.serial_prefix) { %>
                    <p style="font-size: 11px; color: #666; margin-top: 5px;">A sorsz√°m automatikusan gener√°l√≥dik a d√°tum kiv√°laszt√°sa alapj√°n</p>
                <% } %>
            </div>

            <div class="form-group" style="margin-bottom: 15px;">
                <label for="inspectorPerson"><strong>Ellen≈ërz≈ë szem√©ly:</strong></label>
                <input type="text" id="inspectorPerson" name="inspectorPerson" value="<%= user.username %>" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
            </div>

            <p style="font-size: 13px; color: #999; margin-top: 10px;">
                <em>Projekt t√≠pus: <%= project.project_type %></em>
            </p>

            <!--  √öJ ellen≈ërz√©s GOMB -->
<div style="text-align: center; margin: 20px 0;">
    <button type="button" class="add-button" onclick="startNewInspection()" style="width: auto; padding: 12px 30px;">
        <i class="fas fa-plus"></i> √öj ellen≈ërz√©s ind√≠t√°sa
    </button>
</div>

        </div>

        <!-- Header -->
        <div class="header">
            <h1>7. Egy√©ni v√©d≈ëeszk√∂z√∂k</h1>
            <p>Els≈ëseg√©lyny√∫jt√≥ helyek, szem√©lyek, m≈±szaki ment√©s, E√ú t√°sk√°k</p>
        </div>

        <form id="documentationForm" method="POST" action="/projects/<%= project.id %>/reports/first-aid">

            <!-- Ellen≈ërz√©s r√©sztvev≈ëi -->
            <div class="form-section">
                <div class="section-title">Ellen≈ërz√©s r√©sztvev≈ëi</div>

                <!-- Ellen≈ërz√©st v√©gz≈ë -->
                <div class="form-group">
                    <label>Ellen≈ërz√©st v√©gz≈ë</label>
                    <div class="two-column">
                        <input type="text" name="inspector_name" placeholder="N√©v" value="<%= user.username %>">
                        <input type="text" name="inspector_position" placeholder="Beoszt√°s">
                    </div>

                    <div class="signature-container">
                        <div class="signature-preview" id="inspectorPreview" onclick="openSignatureModal('inspector')">
                            <span><i class="fas fa-pen"></i> Kattintson ide az al√°√≠r√°s hozz√°ad√°s√°hoz</span>
                        </div>
                        <div class="signature-buttons">
                            <button type="button" class="add-button" onclick="openSignatureModal('inspector')">
                                <i class="fas fa-signature"></i> Al√°√≠r√°s hozz√°ad√°sa
                            </button>
                            <button type="button" class="clear-signature" onclick="clearSignature('inspector')" style="display: none;" id="inspectorClear">
                                <i class="fas fa-trash"></i> T√∂rl√©s
                            </button>
                        </div>
                    </div>
                    <input type="hidden" name="inspector_signature" id="inspectorSignature">
                </div>

                <!-- Munkater√ºlet√©rt felel≈ës -->
                <div class="form-group">
                    <label>Munkater√ºlet√©rt felel≈ës</label>
                    <div class="two-column">
                        <input type="text" name="responsible_name" placeholder="Munkater√ºlet√©rt felel≈ës neve">
                        <input type="text" name="responsible_position" placeholder="Beoszt√°s">
                    </div>

                    <div class="signature-container">
                        <div class="signature-preview" id="responsiblePreview" onclick="openSignatureModal('responsible')">
                            <span><i class="fas fa-pen"></i> Kattintson ide az al√°√≠r√°s hozz√°ad√°s√°hoz</span>
                        </div>
                        <div class="signature-buttons">
                            <button type="button" class="add-button" onclick="openSignatureModal('responsible')">
                                <i class="fas fa-signature"></i> Al√°√≠r√°s hozz√°ad√°sa
                            </button>
                            <button type="button" class="clear-signature" onclick="clearSignature('responsible')" style="display: none;" id="responsibleClear">
                                <i class="fas fa-trash"></i> T√∂rl√©s
                            </button>
                        </div>
                    </div>
                    <input type="hidden" name="responsible_signature" id="responsibleSignature">
                </div>

                <!-- Tan√∫k - Alapb√≥l elrejtve -->
        <div id="witnessToggleButton" style="margin-bottom: 15px; text-align: center;">
    <button
        type="button"
        class="add-button witness-button"
        onclick="showWitnesses()"
    >
        <i class="fas fa-user-times"></i> Al√°√≠r√°st megtagadta
    </button>
</div>

                <div id="witnessSection" style="display: none;">
                    <div id="witnessesContainer"></div>

                    <div style="margin-top: 15px; padding: 10px; background-color: #f8f9fa; border-radius: 6px;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="noWitnessAvailable" onchange="toggleNoWitness()" style="margin-right: 10px; width: 18px; height: 18px;">
                            <span style="font-weight: 500;">Nem √°ll rendelkez√©sre Tan√∫</span>
                        </label>
                    </div>
                </div>

                <!-- Alv√°llalkoz√≥i l√°nc -->
                <div class="form-group">
                    <label>Alv√°llalkoz√≥i l√°nc</label>
                    <div style="background-color: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                        <div style="display: flex; align-items: center; margin-bottom: 8px;">
                            <span style="font-weight: 600; color: #2c5282; margin-right: 10px;">1.</span>
                            <input type="text" value="MVM Xpert Zrt." readonly
                                   style="flex: 1; background-color: #e8f4f8; border: 2px solid #bee3f8; padding: 8px 12px; border-radius: 6px; font-weight: 500;">
                        </div>
                        <div id="subcontractorsList"></div>
                        <button type="button" class="add-button" onclick="addSubcontractor()" style="margin-top: 10px; width: 100%;">
                            <i class="fas fa-plus"></i> Alv√°llalkoz√≥ c√©g hozz√°ad√°sa
                        </button>
                    </div>
                </div>
            </div>

            
            
            
            <!-- 7.1 -->
            <div class="checklist-item">
                <div class="checklist-header">7.1 Els≈ëseg√©ly felszerel√©sek, dobozok felt√∂lt√∂tts√©ge, el√©rhet≈ës√©ge</div>
                <div class="checklist-description">Els≈ëseg√©ly dobozok √°llapota √©s tartalom</div>

                <div class="radio-options">
                    <div class="radio-option success">
                        <input type="radio" id="item_7_1_m" name="item_7_1" value="megfelel≈ë" onchange="toggleSeverity('7_1')">
                        <label for="item_7_1_m">Megfelelt</label>
                    </div>
                    <div class="radio-option danger">
                        <input type="radio" id="item_7_1_nm" name="item_7_1" value="nem_megfelel≈ë" onchange="toggleSeverity('7_1')">
                        <label for="item_7_1_nm">Nem megfelelt</label>
                    </div>
                    <div class="radio-option info">
                        <input type="radio" id="item_7_1_ft" name="item_7_1" value="felsz√≥l√≠t√°s_ut√°n" onchange="toggleSeverity('7_1')">
                        <label for="item_7_1_ft">Felsz√≥l√≠t√°s ut√°n teljes√≠tve</label>
                    </div>
                    <div class="radio-option warning">
                        <input type="radio" id="item_7_1_nv" name="item_7_1" value="nem_vizsg√°lt" onchange="toggleSeverity('7_1')">
                        <label for="item_7_1_nv">Nem vonatkozik / Nem vizsg√°lt</label>
                    </div>
                </div>

                <div id="severity_7_1" class="severity-selector" style="display: none; margin-top: 15px; padding: 15px; background-color: #f7fafc; border-radius: 8px;">
                    <label style="font-weight: 600; display: block; margin-bottom: 10px;">Hiba s√∫lyoss√°ga:</label>
                    <div class="radio-options">
                        <div class="radio-option" style="border-color: #FFFF00;">
                            <input type="radio" id="item_7_1_sev_low" name="item_7_1_severity" value="alacsony">
                            <label for="item_7_1_sev_low" style="color: #000000;">üü°Alacsony</label>
                        </div>
                        <div class="radio-option" style="border-color: #ED7D31;">
                            <input type="radio" id="item_7_1_sev_medium" name="item_7_1_severity" value="k√∂zepes">
                            <label for="item_7_1_sev_medium" style="color: #000000;">üü†K√∂zepes</label>
                        </div>
                        <div class="radio-option" style="border-color: #FF0000;">
                            <input type="radio" id="item_7_1_sev_high" name="item_7_1_severity" value="magas">
                            <label for="item_7_1_sev_high" style="color: #000000;">üî¥Magas</label>
                        </div>
                    </div>
                </div>

              <div class="form-group" style="margin-top: 15px;">
    <label><i class="fas fa-camera"></i> F√©nyk√©pek / dokument√°ci√≥</label>
    <p style="font-size: 11px; color: #4CAF50; margin: 5px 0;">
        <i class="fas fa-check-circle"></i> Minden k√©pform√°tum t√°mogatott (HEIC is) ‚Ä¢ Automatikus t√∂m√∂r√≠t√©s
    </p>

    <!-- Rejtett file input -->
    <input
        type="file"
        id="photos_7_1"
        multiple
        onchange="handleImageUpload(event, '7_1')"
        style="display: none;"
    >

    <!-- Sz√©p gomb -->
    <button type="button" class="upload-btn" onclick="document.getElementById('photos_7_1').click()">
        <i class="fas fa-upload"></i> F√°jlok felt√∂lt√©se
    </button>

    <div id="preview_7_1" class="image-preview-container"></div>
</div>

                <textarea class="notes-textarea" name="notes_7_1" placeholder="Megjegyz√©s..."></textarea>
            </div>


            <!-- 7.2 -->
            <div class="checklist-item">
                <div class="checklist-header">7.2 Els≈ëseg√©lyny√∫jt√≥k kijel√∂l√©se, k√©pzetts√©ge, tan√∫s√≠tv√°nyok</div>
                <div class="checklist-description">K√©pzett els≈ëseg√©lyny√∫jt√≥k jelenl√©te</div>

                <div class="radio-options">
                    <div class="radio-option success">
                        <input type="radio" id="item_7_2_m" name="item_7_2" value="megfelel≈ë" onchange="toggleSeverity('7_2')">
                        <label for="item_7_2_m">Megfelelt</label>
                    </div>
                    <div class="radio-option danger">
                        <input type="radio" id="item_7_2_nm" name="item_7_2" value="nem_megfelel≈ë" onchange="toggleSeverity('7_2')">
                        <label for="item_7_2_nm">Nem megfelelt</label>
                    </div>
                    <div class="radio-option info">
                        <input type="radio" id="item_7_2_ft" name="item_7_2" value="felsz√≥l√≠t√°s_ut√°n" onchange="toggleSeverity('7_2')">
                        <label for="item_7_2_ft">Felsz√≥l√≠t√°s ut√°n teljes√≠tve</label>
                    </div>
                    <div class="radio-option warning">
                        <input type="radio" id="item_7_2_nv" name="item_7_2" value="nem_vizsg√°lt" onchange="toggleSeverity('7_2')">
                        <label for="item_7_2_nv">Nem vonatkozik / Nem vizsg√°lt</label>
                    </div>
                </div>

                <div id="severity_7_2" class="severity-selector" style="display: none; margin-top: 15px; padding: 15px; background-color: #f7fafc; border-radius: 8px;">
                    <label style="font-weight: 600; display: block; margin-bottom: 10px;">Hiba s√∫lyoss√°ga:</label>
                    <div class="radio-options">
                        <div class="radio-option" style="border-color: #FFFF00;">
                            <input type="radio" id="item_7_2_sev_low" name="item_7_2_severity" value="alacsony">
                            <label for="item_7_2_sev_low" style="color: #000000;">üü°Alacsony</label>
                        </div>
                        <div class="radio-option" style="border-color: #ED7D31;">
                            <input type="radio" id="item_7_2_sev_medium" name="item_7_2_severity" value="k√∂zepes">
                            <label for="item_7_2_sev_medium" style="color: #000000;">üü†K√∂zepes</label>
                        </div>
                        <div class="radio-option" style="border-color: #FF0000;">
                            <input type="radio" id="item_7_2_sev_high" name="item_7_2_severity" value="magas">
                            <label for="item_7_2_sev_high" style="color: #000000;">üî¥Magas</label>
                        </div>
                    </div>
                </div>

              <div class="form-group" style="margin-top: 15px;">
    <label><i class="fas fa-camera"></i> F√©nyk√©pek / dokument√°ci√≥</label>
    <p style="font-size: 11px; color: #4CAF50; margin: 5px 0;">
        <i class="fas fa-check-circle"></i> Minden k√©pform√°tum t√°mogatott (HEIC is) ‚Ä¢ Automatikus t√∂m√∂r√≠t√©s
    </p>

    <!-- Rejtett file input -->
    <input
        type="file"
        id="photos_7_2"
        multiple
        onchange="handleImageUpload(event, '7_2')"
        style="display: none;"
    >

    <!-- Sz√©p gomb -->
    <button type="button" class="upload-btn" onclick="document.getElementById('photos_7_2').click()">
        <i class="fas fa-upload"></i> F√°jlok felt√∂lt√©se
    </button>

    <div id="preview_7_2" class="image-preview-container"></div>
</div>

                <textarea class="notes-textarea" name="notes_7_2" placeholder="Megjegyz√©s..."></textarea>
            </div>


            <!-- 7.3 -->
            <div class="checklist-item">
                <div class="checklist-header">7.3 Els≈ëseg√©ly ny√∫jt√°si pontok jel√∂l√©se, t√°bl√°k</div>
                <div class="checklist-description">Jelz√©sek √©s inform√°ci√≥k</div>

                <div class="radio-options">
                    <div class="radio-option success">
                        <input type="radio" id="item_7_3_m" name="item_7_3" value="megfelel≈ë" onchange="toggleSeverity('7_3')">
                        <label for="item_7_3_m">Megfelelt</label>
                    </div>
                    <div class="radio-option danger">
                        <input type="radio" id="item_7_3_nm" name="item_7_3" value="nem_megfelel≈ë" onchange="toggleSeverity('7_3')">
                        <label for="item_7_3_nm">Nem megfelelt</label>
                    </div>
                    <div class="radio-option info">
                        <input type="radio" id="item_7_3_ft" name="item_7_3" value="felsz√≥l√≠t√°s_ut√°n" onchange="toggleSeverity('7_3')">
                        <label for="item_7_3_ft">Felsz√≥l√≠t√°s ut√°n teljes√≠tve</label>
                    </div>
                    <div class="radio-option warning">
                        <input type="radio" id="item_7_3_nv" name="item_7_3" value="nem_vizsg√°lt" onchange="toggleSeverity('7_3')">
                        <label for="item_7_3_nv">Nem vonatkozik / Nem vizsg√°lt</label>
                    </div>
                </div>

                <div id="severity_7_3" class="severity-selector" style="display: none; margin-top: 15px; padding: 15px; background-color: #f7fafc; border-radius: 8px;">
                    <label style="font-weight: 600; display: block; margin-bottom: 10px;">Hiba s√∫lyoss√°ga:</label>
                    <div class="radio-options">
                        <div class="radio-option" style="border-color: #FFFF00;">
                            <input type="radio" id="item_7_3_sev_low" name="item_7_3_severity" value="alacsony">
                            <label for="item_7_3_sev_low" style="color: #000000;">üü°Alacsony</label>
                        </div>
                        <div class="radio-option" style="border-color: #ED7D31;">
                            <input type="radio" id="item_7_3_sev_medium" name="item_7_3_severity" value="k√∂zepes">
                            <label for="item_7_3_sev_medium" style="color: #000000;">üü†K√∂zepes</label>
                        </div>
                        <div class="radio-option" style="border-color: #FF0000;">
                            <input type="radio" id="item_7_3_sev_high" name="item_7_3_severity" value="magas">
                            <label for="item_7_3_sev_high" style="color: #000000;">üî¥Magas</label>
                        </div>
                    </div>
                </div>

              <div class="form-group" style="margin-top: 15px;">
    <label><i class="fas fa-camera"></i> F√©nyk√©pek / dokument√°ci√≥</label>
    <p style="font-size: 11px; color: #4CAF50; margin: 5px 0;">
        <i class="fas fa-check-circle"></i> Minden k√©pform√°tum t√°mogatott (HEIC is) ‚Ä¢ Automatikus t√∂m√∂r√≠t√©s
    </p>

    <!-- Rejtett file input -->
    <input
        type="file"
        id="photos_7_3"
        multiple
        onchange="handleImageUpload(event, '7_3')"
        style="display: none;"
    >

    <!-- Sz√©p gomb -->
    <button type="button" class="upload-btn" onclick="document.getElementById('photos_7_3').click()">
        <i class="fas fa-upload"></i> F√°jlok felt√∂lt√©se
    </button>

    <div id="preview_7_3" class="image-preview-container"></div>
</div>

                <textarea class="notes-textarea" name="notes_7_3" placeholder="Megjegyz√©s..."></textarea>
            </div>


            <!-- 7.4 -->
            <div class="checklist-item">
                <div class="checklist-header">7.4 Szem√∂bl√≠t≈ë, vegyszeres s√©r√ºl√©s elleni felszerel√©sek</div>
                <div class="checklist-description">Speci√°lis els≈ëseg√©ly eszk√∂z√∂k</div>

                <div class="radio-options">
                    <div class="radio-option success">
                        <input type="radio" id="item_7_4_m" name="item_7_4" value="megfelel≈ë" onchange="toggleSeverity('7_4')">
                        <label for="item_7_4_m">Megfelelt</label>
                    </div>
                    <div class="radio-option danger">
                        <input type="radio" id="item_7_4_nm" name="item_7_4" value="nem_megfelel≈ë" onchange="toggleSeverity('7_4')">
                        <label for="item_7_4_nm">Nem megfelelt</label>
                    </div>
                    <div class="radio-option info">
                        <input type="radio" id="item_7_4_ft" name="item_7_4" value="felsz√≥l√≠t√°s_ut√°n" onchange="toggleSeverity('7_4')">
                        <label for="item_7_4_ft">Felsz√≥l√≠t√°s ut√°n teljes√≠tve</label>
                    </div>
                    <div class="radio-option warning">
                        <input type="radio" id="item_7_4_nv" name="item_7_4" value="nem_vizsg√°lt" onchange="toggleSeverity('7_4')">
                        <label for="item_7_4_nv">Nem vonatkozik / Nem vizsg√°lt</label>
                    </div>
                </div>

                <div id="severity_7_4" class="severity-selector" style="display: none; margin-top: 15px; padding: 15px; background-color: #f7fafc; border-radius: 8px;">
                    <label style="font-weight: 600; display: block; margin-bottom: 10px;">Hiba s√∫lyoss√°ga:</label>
                    <div class="radio-options">
                        <div class="radio-option" style="border-color: #FFFF00;">
                            <input type="radio" id="item_7_4_sev_low" name="item_7_4_severity" value="alacsony">
                            <label for="item_7_4_sev_low" style="color: #000000;">üü°Alacsony</label>
                        </div>
                        <div class="radio-option" style="border-color: #ED7D31;">
                            <input type="radio" id="item_7_4_sev_medium" name="item_7_4_severity" value="k√∂zepes">
                            <label for="item_7_4_sev_medium" style="color: #000000;">üü†K√∂zepes</label>
                        </div>
                        <div class="radio-option" style="border-color: #FF0000;">
                            <input type="radio" id="item_7_4_sev_high" name="item_7_4_severity" value="magas">
                            <label for="item_7_4_sev_high" style="color: #000000;">üî¥Magas</label>
                        </div>
                    </div>
                </div>

              <div class="form-group" style="margin-top: 15px;">
    <label><i class="fas fa-camera"></i> F√©nyk√©pek / dokument√°ci√≥</label>
    <p style="font-size: 11px; color: #4CAF50; margin: 5px 0;">
        <i class="fas fa-check-circle"></i> Minden k√©pform√°tum t√°mogatott (HEIC is) ‚Ä¢ Automatikus t√∂m√∂r√≠t√©s
    </p>

    <!-- Rejtett file input -->
    <input
        type="file"
        id="photos_7_4"
        multiple
        onchange="handleImageUpload(event, '7_4')"
        style="display: none;"
    >

    <!-- Sz√©p gomb -->
    <button type="button" class="upload-btn" onclick="document.getElementById('photos_7_4').click()">
        <i class="fas fa-upload"></i> F√°jlok felt√∂lt√©se
    </button>

    <div id="preview_7_4" class="image-preview-container"></div>
</div>

                <textarea class="notes-textarea" name="notes_7_4" placeholder="Megjegyz√©s..."></textarea>
            </div>


            <!-- 7.5 -->
            <div class="checklist-item">
                <div class="checklist-header">7.5 Els≈ëseg√©lyny√∫jt√°ssal kapcsolatos dokument√°ci√≥k, utas√≠t√°sok</div>
                <div class="checklist-description">Protokollok √©s elj√°r√°srendek</div>

                <div class="radio-options">
                    <div class="radio-option success">
                        <input type="radio" id="item_7_5_m" name="item_7_5" value="megfelel≈ë" onchange="toggleSeverity('7_5')">
                        <label for="item_7_5_m">Megfelelt</label>
                    </div>
                    <div class="radio-option danger">
                        <input type="radio" id="item_7_5_nm" name="item_7_5" value="nem_megfelel≈ë" onchange="toggleSeverity('7_5')">
                        <label for="item_7_5_nm">Nem megfelelt</label>
                    </div>
                    <div class="radio-option info">
                        <input type="radio" id="item_7_5_ft" name="item_7_5" value="felsz√≥l√≠t√°s_ut√°n" onchange="toggleSeverity('7_5')">
                        <label for="item_7_5_ft">Felsz√≥l√≠t√°s ut√°n teljes√≠tve</label>
                    </div>
                    <div class="radio-option warning">
                        <input type="radio" id="item_7_5_nv" name="item_7_5" value="nem_vizsg√°lt" onchange="toggleSeverity('7_5')">
                        <label for="item_7_5_nv">Nem vonatkozik / Nem vizsg√°lt</label>
                    </div>
                </div>

                <div id="severity_7_5" class="severity-selector" style="display: none; margin-top: 15px; padding: 15px; background-color: #f7fafc; border-radius: 8px;">
                    <label style="font-weight: 600; display: block; margin-bottom: 10px;">Hiba s√∫lyoss√°ga:</label>
                    <div class="radio-options">
                        <div class="radio-option" style="border-color: #FFFF00;">
                            <input type="radio" id="item_7_5_sev_low" name="item_7_5_severity" value="alacsony">
                            <label for="item_7_5_sev_low" style="color: #000000;">üü°Alacsony</label>
                        </div>
                        <div class="radio-option" style="border-color: #ED7D31;">
                            <input type="radio" id="item_7_5_sev_medium" name="item_7_5_severity" value="k√∂zepes">
                            <label for="item_7_5_sev_medium" style="color: #000000;">üü†K√∂zepes</label>
                        </div>
                        <div class="radio-option" style="border-color: #FF0000;">
                            <input type="radio" id="item_7_5_sev_high" name="item_7_5_severity" value="magas">
                            <label for="item_7_5_sev_high" style="color: #000000;">üî¥Magas</label>
                        </div>
                    </div>
                </div>

              <div class="form-group" style="margin-top: 15px;">
    <label><i class="fas fa-camera"></i> F√©nyk√©pek / dokument√°ci√≥</label>
    <p style="font-size: 11px; color: #4CAF50; margin: 5px 0;">
        <i class="fas fa-check-circle"></i> Minden k√©pform√°tum t√°mogatott (HEIC is) ‚Ä¢ Automatikus t√∂m√∂r√≠t√©s
    </p>

    <!-- Rejtett file input -->
    <input
        type="file"
        id="photos_7_5"
        multiple
        onchange="handleImageUpload(event, '7_5')"
        style="display: none;"
    >

    <!-- Sz√©p gomb -->
    <button type="button" class="upload-btn" onclick="document.getElementById('photos_7_5').click()">
        <i class="fas fa-upload"></i> F√°jlok felt√∂lt√©se
    </button>

    <div id="preview_7_5" class="image-preview-container"></div>
</div>

                <textarea class="notes-textarea" name="notes_7_5" placeholder="Megjegyz√©s..."></textarea>
            </div>

<!-- Szankci√≥s lista -->
            <div class="price-section">
                <h3>Szankci√≥s lista - Els≈ëseg√©lyny√∫jt√°s kateg√≥ria vonatkoz√≥ pontjai</h3>

                <div class="price-item">
                    <input type="checkbox" id="price_1" name="sanction_1" value="100000" onchange="calculateTotal()">
                    <label for="price_1">1. MVM XPert munka-, t≈±z-, vagy k√∂rnyezetv√©delmi szab√°lyainak (szerz≈ëd√©sben r√∂gz√≠tett, illetve a BET-ben szerepl≈ë, √©s itt nem r√©szletezett) megs√©rt√©se</label>
                    <input type="number" name="sanction_1_count" min="1" value="1" style="width: 60px; margin: 0 10px;" onchange="calculateTotal()" placeholder="db">
                    <span style="margin-right: 10px; font-weight: 600;">√ó</span>
                    <span class="price">100¬†000 Ft</span>
                </div>


                <div class="price-item">
                    <input type="checkbox" id="price_2" name="sanction_3" value="50000" onchange="calculateTotal()">
                    <label for="price_2">3. Els≈ëseg√©lyny√∫jt√≥ felszerel√©s hi√°nya, el√©rhetetlens√©ge, nem megfelel≈ës√©ge</label>
                    <input type="number" name="sanction_3_count" min="1" value="1" style="width: 60px; margin: 0 10px;" onchange="calculateTotal()" placeholder="db">
                    <span style="margin-right: 10px; font-weight: 600;">√ó</span>
                    <span class="price">50¬†000 Ft</span>
                </div>

                <div class="total-section">
                    <label for="totalPrice">Kiszabhat√≥ √∂sszes√≠tett b√≠rs√°g:</label>
                    <span id="totalPrice" class="total-price">0 Ft</span>
                </div>
            </div>

            <!-- Submit gombok -->
            <div class="submit-section">
                <button type="button" class="submit-button" onclick="exportToPDF()">
                    <i class="fas fa-file-pdf"></i> PDF export√°l√°sa
                </button>
                <button type="submit" class="preview-button">
                    <i class="fas fa-save"></i> Ellen≈ërz√©s ment√©se
                </button>
            </div>

        </form>
    </div>

    <!-- Al√°√≠r√°s Modal -->
        <div id="signatureModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-signature"></i> Al√°√≠r√°s hozz√°ad√°sa</h2>
                <button class="close-modal" onclick="closeSignatureModal()">&times;</button>
            </div>
            <canvas id="signatureCanvas" width="540" height="300"></canvas>
            <div class="canvas-controls">
                <button class="btn-clear" onclick="clearCanvas()">
                    <i class="fas fa-trash"></i> T√∂rl√©s
                </button>
                <button class="btn-save" onclick="saveSignature()">
                    <i class="fas fa-save"></i> Ment√©s
                </button>
            </div>
        </div>
    </div>



    <script>
        // ========================================
        // PROGRESS BAR F√úGGV√âNYEK
        // ========================================
        function showUploadProgress() {
            const overlay = document.getElementById('uploadProgressOverlay');
            if (overlay) {
                overlay.style.display = 'flex';
            }
        }

        function hideUploadProgress() {
            const overlay = document.getElementById('uploadProgressOverlay');
            if (overlay) {
                overlay.style.display = 'none';
            }
        }

        function updateUploadProgress(percent, status) {
            const bar = document.getElementById('uploadProgressBar');
            const text = document.getElementById('uploadProgressText');
            const statusDiv = document.getElementById('uploadProgressStatus');

            if (bar) bar.style.width = percent + '%';
            if (text) text.textContent = Math.round(percent) + '%';
            if (status && statusDiv) {
                statusDiv.textContent = status;
            }

            console.log('üìä Progress: ' + Math.round(percent) + '% - ' + status);
        }

        // ========================================
        // GLOB√ÅLIS V√ÅLTOZ√ìK
        // ========================================
        const uploadedImages = {};
        const signatures = {};
        let currentSignatureType = '';
        let canvas, ctx;
        let isDrawing = false;
        let witnessesVisible = false;
        let witnessCounter = 0;

        // Canvas inicializ√°l√°s az oldal bet√∂lt√©sekor
        document.addEventListener('DOMContentLoaded', async function() {
            canvas = document.getElementById('signatureCanvas');
            if (canvas) {
                ctx = canvas.getContext('2d');
                ctx.strokeStyle = '#000000';
                ctx.lineWidth = 2;
                ctx.lineCap = 'round';

                // Rajzol√°s esem√©nyek
                canvas.addEventListener('mousedown', startDrawing);
                canvas.addEventListener('mousemove', draw);
                canvas.addEventListener('mouseup', stopDrawing);
                canvas.addEventListener('mouseout', stopDrawing);

                // Touch esem√©nyek mobilra
                canvas.addEventListener('touchstart', handleTouchStart, { passive: false });
                canvas.addEventListener('touchmove', handleTouchMove, { passive: false });
                canvas.addEventListener('touchend', handleTouchEnd, { passive: false });
            }

            // Aktu√°lis d√°tum be√°ll√≠t√°sa alap√©rtelmezettnek
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('inspectionDate').value = today;

            // Sorsz√°m gener√°l√°s inicializ√°l√°sa
            updateSerialNumber();

            // Mentett adatok bet√∂lt√©se szerverr≈ël
            try {
                const response = await fetch('/projects/<%= project.id %>/reports/first-aid');
                const result = await response.json();

                if (result.success && result.data) {
                    console.log('Mentett adatok bet√∂ltve:', result.data);
                    loadSavedData(result.data);
                } else {
                    console.log('Nincs mentett adat ehhez a projekthez/kateg√≥ri√°hoz');
                }
            } catch (error) {
                console.error('Hiba a mentett adatok bet√∂lt√©sekor:', error);
            }
        });

        // ========================================
        // SORSZ√ÅM GENER√ÅL√ÅS
        // ========================================
        function updateSerialNumber() {
            const dateInput = document.getElementById('inspectionDate');
            const serialInput = document.getElementById('serialNumber');
            const serialPrefix = '<%= project.serial_prefix || "" %>';

            if (!dateInput.value || !serialPrefix) return;

            const selectedDate = new Date(dateInput.value + 'T00:00:00');
            const year = selectedDate.getFullYear();
            const month = String(selectedDate.getMonth() + 1).padStart(2, '0');
            const day = String(selectedDate.getDate()).padStart(2, '0');

            const generatedSerial = serialPrefix + '/' + year + month + day;
            serialInput.value = generatedSerial;

            console.log('‚úì Sorsz√°m gener√°lva:', generatedSerial);
        }

        // ========================================
        // TAN√öK KEZEL√âSE
        // ========================================
        function showWitnesses() {
            const section = document.getElementById('witnessSection');
            const button = document.getElementById('witnessToggleButton');

            if (section.style.display === 'none') {
                section.style.display = 'block';
                button.style.display = 'none';
                witnessesVisible = true;

                // 2 tan√∫ mez≈ë hozz√°ad√°sa
                if (witnessCounter === 0) {
                    for (let i = 0; i < 2; i++) {
                        addWitness();
                    }
                }
            }
        }

        function addWitness() {
            const container = document.getElementById('witnessesContainer');
            const witnessIndex = witnessCounter;

            const witnessDiv = document.createElement('div');
            witnessDiv.className = 'form-group witness-group';
            witnessDiv.id = 'witness_' + witnessIndex;

            witnessDiv.innerHTML = `
                <label>Tan√∫ ${witnessIndex + 1}</label>
                <div class="two-column">
                    <input type="text" name="witness_name_${witnessIndex}" placeholder="N√©v">
                    <input type="text" name="witness_position_${witnessIndex}" placeholder="Beoszt√°s">
                </div>
                <div class="two-column" style="margin-top: 10px;">
                    <input type="text" name="witness_id_number_${witnessIndex}" placeholder="Szem√©lyi sz√°m">
                    <input type="text" name="witness_address_${witnessIndex}" placeholder="Lakc√≠m">
                </div>

                <div class="signature-container">
                    <div class="signature-preview" id="witnessPreview_${witnessIndex}" onclick="openSignatureModal('witness_${witnessIndex}')">
                        <span><i class="fas fa-pen"></i> Kattintson ide az al√°√≠r√°s hozz√°ad√°s√°hoz</span>
                    </div>
                    <div class="signature-buttons">
                        <button type="button" class="add-button" onclick="openSignatureModal('witness_${witnessIndex}')">
                            <i class="fas fa-signature"></i> Al√°√≠r√°s hozz√°ad√°sa
                        </button>
                        <button type="button" class="clear-signature" onclick="clearSignature('witness_${witnessIndex}')" style="display: none;" id="witness_${witnessIndex}Clear">
                            <i class="fas fa-trash"></i> T√∂rl√©s
                        </button>
                    </div>
                </div>
                <input type="hidden" name="witness_signature_${witnessIndex}" id="witness_${witnessIndex}Signature">
            `;

            container.appendChild(witnessDiv);
            witnessCounter++;
        }

        function toggleNoWitness() {
            const checkbox = document.getElementById('noWitnessAvailable');
            const witnessGroups = document.querySelectorAll('.witness-group');

            witnessGroups.forEach(group => {
                const inputs = group.querySelectorAll('input[type="text"]');
                inputs.forEach(input => {
                    input.disabled = checkbox.checked;
                    if (checkbox.checked) {
                        input.style.backgroundColor = '#f0f0f0';
                    } else {
                        input.style.backgroundColor = '';
                    }
                });
            });
        }

        // ========================================
        // ALV√ÅLLALKOZ√ìK KEZEL√âSE
        // ========================================
        let subcontractorCounter = 0;

        function addSubcontractor() {
            subcontractorCounter++;
            const container = document.getElementById('subcontractorsList');
            const div = document.createElement('div');
            div.className = 'subcontractor-item';
            div.style.cssText = 'display: flex; align-items: center; margin-bottom: 8px;';

            div.innerHTML = `
                <span style="font-weight: 600; color: #2c5282; margin-right: 10px; min-width: 20px;">' + (subcontractorCounter + 1) + '.</span>
                <input type="text"
                       name="subcontractor_' + subcontractorCounter + '"
                       placeholder="Alv√°llalkoz√≥ c√©g neve"
                       style="flex: 1; padding: 8px 12px; border: 2px solid #cbd5e0; border-radius: 6px;">
                <button type="button"
                        onclick="removeSubcontractor(this)"
                        style="margin-left: 8px; padding: 6px 12px; background-color: #fc8181; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    <i class="fas fa-times"></i>
                </button>
            `;

            container.appendChild(div);
        }

        function removeSubcontractor(button) {
            const item = button.closest('.subcontractor-item');
            item.remove();
            renumberSubcontractors();
        }

        function renumberSubcontractors() {
            const items = document.querySelectorAll('.subcontractor-item');
            subcontractorCounter = 0;
            items.forEach((item, index) => {
                const span = item.querySelector('span');
                span.textContent = (index + 2) + '.';
                subcontractorCounter++;
            });
        }

        // ========================================
        // S√öLYOSS√ÅG TOGGLE
        // ========================================
        function toggleSeverity(itemId) {
            const selectedValue = document.querySelector('input[name="item_' + itemId + '"]:checked')?.value;
            const severityDiv = document.getElementById('severity_' + itemId);

            if (selectedValue === 'nem_megfelel≈ë' || selectedValue === 'felsz√≥l√≠t√°s_ut√°n') {
                severityDiv.style.display = 'block';
            } else {
                severityDiv.style.display = 'none';
                // S√∫lyoss√°g radio-k t√∂rl√©se
                const severityRadios = document.querySelectorAll('input[name="item_' + itemId + '_severity"]');
                severityRadios.forEach(radio => radio.checked = false);
            }
        }

        // ========================================
        // K√âPFELT√ñLT√âS √âS METAADATOK
        // ========================================
        function formatDate(dateString) {
            const date = new Date(dateString);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');
            return `${year}.${month}.${day}. ${hours}:${minutes}:${seconds}`;
        }

        async function handleImageUpload(event, itemId) {
            const files = event.target.files;
            if (!files || files.length === 0) return;

            if (!uploadedImages[itemId]) {
                uploadedImages[itemId] = [];
            }

            const previewContainer = document.getElementById(`preview_${itemId}`);

            for (let file of files) {
                try {
                    console.log(`üì∏ Feldolgoz√°s: ${file.name} (${file.type})`);

                    let processedFile = file;
                    let exifData = null;

                    // ‚≠ê HEIC konverzi√≥ JPEG-re
                    if (file.type === 'image/heic' || file.name.toLowerCase().endsWith('.heic')) {
                        console.log('üîÑ HEIC konverzi√≥ folyamatban...');
                        try {
                            const jpegBlob = await heic2any({
                                blob: file,
                                toType: 'image/jpeg',
                                quality: 0.9
                            });
                            processedFile = new File([jpegBlob], file.name.replace(/\.heic$/i, '.jpg'), { type: 'image/jpeg' });
                            console.log('‚úÖ HEIC ‚Üí JPEG konverzi√≥ sikeres');

                            // ‚≠ê exifr-rel HEIC EXIF olvas√°s
                            try {
                                exifData = await exifr.parse(file, {
                                    gps: true,
                                    tiff: true,
                                    exif: true,
                                    iptc: false,
                                    icc: false
                                });
                                console.log('üìç HEIC EXIF adatok:', exifData);
                            } catch (exifError) {
                                console.warn('‚ö†Ô∏è HEIC EXIF olvas√°si hiba:', exifError);
                            }
                        } catch (conversionError) {
                            console.error('‚ùå HEIC konverzi√≥ sikertelen:', conversionError);
                            alert(`‚ö†Ô∏è Ez a k√©p nem t√°mogatott form√°tumban van.\n\nK√©rlek pr√≥b√°ld meg:\n1. JPEG/PNG form√°tumba konvert√°lni\n2. M√°sik alkalmaz√°ssal megnyitni √©s √∫jra menteni`);
                            continue;
                        }
                    }

                    // ‚≠ê JPEG/PNG EXIF olvas√°s (piexifjs + exifr kombin√°lva)
                    if (!exifData && (processedFile.type === 'image/jpeg' || processedFile.type === 'image/png')) {
                        try {
                            exifData = await exifr.parse(processedFile, {
                                gps: true,
                                tiff: true,
                                exif: true,
                                iptc: false,
                                icc: false
                            });
                            console.log('üìç JPEG/PNG EXIF adatok (exifr):', exifData);
                        } catch (e) {
                            console.warn('‚ö†Ô∏è exifr olvas√°si hiba, piexifjs pr√≥b√°lkoz√°s...', e);
                        }
                    }

                    // ‚≠ê K√©p bet√∂lt√©se
                    const reader = new FileReader();
                    reader.onload = async function(e) {
                        const originalDataUrl = e.target.result;

                        // ‚≠ê T√∂m√∂r√≠t√©s 70% min≈ës√©g, max 1600px sz√©less√©g
                        const compressedDataUrl = await compressImage(originalDataUrl, 0.7, 1600);

                        // ‚≠ê Metaadatok gy≈±jt√©se
                        const metadata = {
                            fileName: file.name,
                            hasDate: false,
                            hasGPS: false,
                            takenDate: null,
                            location: null,
                            latitude: null,
                            longitude: null,
                            camera: null
                        };

                        // ‚≠ê D√°tum feldolgoz√°s
                        if (exifData) {
                            if (exifData.DateTimeOriginal) {
                                metadata.hasDate = true;
                                metadata.takenDate = exifData.DateTimeOriginal.toISOString();
                            } else if (exifData.DateTime) {
                                metadata.hasDate = true;
                                metadata.takenDate = exifData.DateTime.toISOString();
                            }

                            // ‚≠ê GPS feldolgoz√°s
                            if (exifData.latitude && exifData.longitude) {
                                metadata.hasGPS = true;
                                metadata.latitude = exifData.latitude;
                                metadata.longitude = exifData.longitude;
                                metadata.location = `${exifData.latitude.toFixed(6)}, ${exifData.longitude.toFixed(6)}`;
                                console.log('‚úÖ GPS adat be√°gyazva:', metadata.location);
                            }

                            // ‚≠ê Kamera modell
                            if (exifData.Make && exifData.Model) {
                                metadata.camera = `${exifData.Make} ${exifData.Model}`;
                            }
                        }

                        // ‚≠ê Fallback d√°tum (file m√≥dos√≠t√°si id≈ë)
                        if (!metadata.hasDate) {
                            metadata.takenDate = new Date(file.lastModified).toISOString();
                            console.log('‚ö†Ô∏è EXIF d√°tum hi√°nyzik, file d√°tum haszn√°lva');
                        }

                        // ‚≠ê K√©p hozz√°ad√°sa t√∂mbbh√∂z
                        uploadedImages[itemId].push({
                            data: compressedDataUrl,
                            originalData: originalDataUrl,
                            metadata: metadata
                        });

                        // ‚≠ê Preview elem l√©trehoz√°sa
                        const previewItem = document.createElement('div');
                        previewItem.className = 'image-preview-item';

                        const img = document.createElement('img');
                        img.src = compressedDataUrl;
                        img.style.width = '100%';
                        img.style.height = '200px';
                        img.style.objectFit = 'cover';
                        img.style.display = 'block';

                        const metaInfo = document.createElement('div');
                        metaInfo.className = 'image-meta-info';

                        let metaHTML = '';

                        if (metadata.hasDate && metadata.takenDate) {
                            metaHTML += `
                                <div class="meta-item">
                                    <i class="fas fa-calendar"></i>
                                    <span>${formatDate(metadata.takenDate)}</span>
                                </div>
                            `;
                        }

                        if (metadata.hasGPS && metadata.location) {
                            metaHTML += `
                                <div class="meta-item">
                                    <i class="fas fa-map-marker-alt"></i>
                                    <span>
                                        <a href="https://www.google.com/maps?q=${metadata.latitude},${metadata.longitude}"
                                           target="_blank"
                                           rel="noopener noreferrer"
                                           class="map-link"
                                           style="color: #4CAF50; text-decoration: none; font-weight: bold;">
                                           ${metadata.location}
                                        </a>
                                    </span>
                                </div>
                            `;
                        } else {
                            metaHTML += `
                                <div class="meta-item">
                                    <i class="fas fa-map-marker-alt"></i>
                                    <span style="color: #ffc107;">Nincs GPS adat</span>
                                </div>
                            `;
                        }

                        if (!metadata.hasDate || !metadata.hasGPS) {
                            metaHTML += `
                                <div class="no-metadata-warning">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    <span>Hi√°nyos metaadatok</span>
                                </div>
                            `;
                        }

                        metaInfo.innerHTML = metaHTML;

                        const removeBtn = document.createElement('button');
                        removeBtn.className = 'image-remove-btn';
                        removeBtn.innerHTML = '&times;';
                        removeBtn.title = 'K√©p elt√°vol√≠t√°sa';
                        removeBtn.onclick = function() {
                            const index = uploadedImages[itemId].findIndex(img => img.data === compressedDataUrl);
                            if (index > -1) {
                                uploadedImages[itemId].splice(index, 1);
                                console.log('üóëÔ∏è K√©p elt√°vol√≠tva');
                            }
                            previewItem.remove();
                        };

                        previewItem.appendChild(img);
                        previewItem.appendChild(metaInfo);
                        previewItem.appendChild(removeBtn);
                        previewContainer.appendChild(previewItem);

                        console.log('‚úÖ K√©p felt√∂ltve metaadatokkal:', metadata);
                    };

                    reader.readAsDataURL(processedFile);

                } catch (error) {
                    console.error('‚ùå K√©pfeldolgoz√°si hiba:', error);
                    alert(`Hiba a k√©p feldolgoz√°sa k√∂zben: ${file.name}`);
                }
            }

            event.target.value = '';
        }

        // ‚≠ê K√©pt√∂m√∂r√≠t√©s f√ºggv√©ny
        function compressImage(dataUrl, quality = 0.7, maxWidth = 1600) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;

                    if (width > maxWidth) {
                        height = (height * maxWidth) / width;
                        width = maxWidth;
                    }

                    canvas.width = width;
                    canvas.height = height;

                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);

                    resolve(canvas.toDataURL('image/jpeg', quality));
                };
                img.src = dataUrl;
            });
        }

        // ========================================
        // SZANKCI√ìK SZ√ÅM√çT√ÅSA
        // ========================================
                function calculateTotal() {
            let total = 0;
            const checkboxes = document.querySelectorAll('.price-item input[type="checkbox"]');

            checkboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    const basePrice = parseInt(checkbox.value);
                    const sanctionName = checkbox.name;
                    const countInput = document.querySelector('input[name="' + sanctionName + '_count"]');
                    const count = countInput ? parseInt(countInput.value) || 1 : 1;
                    total += basePrice * count;
                }
            });

            document.getElementById('totalPrice').textContent = total.toLocaleString('hu-HU') + ' Ft';
            return total;
        }

        // ========================================
        // AL√Å√çR√ÅS MODAL
        // ========================================
        
        // ========================================
        // AL√Å√çR√ÅS RAJZOL√ì F√úGGV√âNYEK
        // ========================================

        // Rajzol√°s kezd√©se
        function startDrawing(e) {
            isDrawing = true;
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;

            ctx.beginPath();
            ctx.moveTo(
                (e.clientX - rect.left) * scaleX,
                (e.clientY - rect.top) * scaleY
            );
        }

        // Rajzol√°s
        function draw(e) {
            if (!isDrawing) return;

            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;

            ctx.lineTo(
                (e.clientX - rect.left) * scaleX,
                (e.clientY - rect.top) * scaleY
            );
            ctx.stroke();
        }

        // Rajzol√°s befejez√©se
        function stopDrawing() {
            if (isDrawing) {
                ctx.closePath();
            }
            isDrawing = false;
        }

        // Touch esem√©nyek - Start
        function handleTouchStart(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;

            isDrawing = true;
            ctx.beginPath();
            ctx.moveTo(
                (touch.clientX - rect.left) * scaleX,
                (touch.clientY - rect.top) * scaleY
            );
        }

        // Touch esem√©nyek - Move
        function handleTouchMove(e) {
            e.preventDefault();
            if (!isDrawing) return;

            const touch = e.touches[0];
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;

            ctx.lineTo(
                (touch.clientX - rect.left) * scaleX,
                (touch.clientY - rect.top) * scaleY
            );
            ctx.stroke();
        }

        // Touch esem√©nyek - End
        function handleTouchEnd(e) {
            e.preventDefault();
            if (isDrawing) {
                ctx.closePath();
            }
            isDrawing = false;
        }

        // Canvas t√∂rl√©se
        function clearCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        // Al√°√≠r√°s ment√©se
        function saveSignature() {
            const dataURL = canvas.toDataURL('image/png');
            signatures[currentSignatureType] = dataURL;

            let hiddenInputId = currentSignatureType + 'Signature';
            if (currentSignatureType.startsWith('witness_')) {
                hiddenInputId = currentSignatureType + 'Signature';
            }

            const hiddenInput = document.getElementById(hiddenInputId);
            if (hiddenInput) {
                hiddenInput.value = dataURL;
                console.log('Hidden input friss√≠tve:', hiddenInputId);
            } else {
                console.warn('Nem tal√°lhat√≥ hidden input:', hiddenInputId);
            }

            const previewId = currentSignatureType + 'Preview';
            const preview = document.getElementById(previewId);
            if (preview) {
                preview.innerHTML = '<img src="' + dataURL + '" alt="Al√°√≠r√°s">';
            }

            const clearBtnId = currentSignatureType + 'Clear';
            const clearBtn = document.getElementById(clearBtnId);
            if (clearBtn) {
                clearBtn.style.display = 'block';
            }

            closeSignatureModal();
        }

        // Al√°√≠r√°s t√∂rl√©se
        function clearSignature(type) {
            signatures[type] = null;

            const hiddenInput = document.getElementById(type + 'Signature');
            if (hiddenInput) {
                hiddenInput.value = '';
            }

            const preview = document.getElementById(type + 'Preview');
            if (preview) {
                preview.innerHTML = '<span><i class="fas fa-pen"></i> Kattintson ide az al√°√≠r√°s hozz√°ad√°s√°hoz</span>';
            }

            const clearBtn = document.getElementById(type + 'Clear');
            if (clearBtn) {
                clearBtn.style.display = 'none';
            }
        }

        
        // PDF f√°jln√©v gener√°l√°sa
        function generatePdfFileName() {
            const serialNumber = document.getElementById('serialNumber').value;
            const projectName = document.getElementById('projectName').value || '<%= project.name %>';
            const timestamp = new Date().toISOString().split('T')[0];

            if (serialNumber && serialNumber.trim() !== '' && serialNumber !== 'N-A') {
                return serialNumber + '_' + timestamp + '.pdf';
            } else {
                return projectName + '_' + timestamp + '.pdf';
            }
        }

        function openSignatureModal(type) {
            currentSignatureType = type;
            document.getElementById('signatureModal').style.display = 'block';
            clearCanvas();
        }

        function closeSignatureModal() {
            document.getElementById('signatureModal').style.display = 'none';
            currentSignatureType = '';
        }

                function getStatusStyle(status) {
            switch(status) {
                case 'megfelel≈ë': return 'statusOk';
                case 'nem_megfelel≈ë': return 'statusFail';
                case 'felsz√≥l√≠t√°s_ut√°n': return 'statusFT';
                case 'nem_vizsg√°lt': return 'statusNA';
                default: return 'statusNA';
            }
        }

        function getSeverityBadge(itemId, data) {
            const severity = data['item_' + itemId + '_severity'];
            if (!severity) return null;

            const severityConfig = {
                'alacsony': { text: 'Hiba s√∫lyoss√°ga: üü° ALACSONY', color: '#000000', bg: '#FFFF00' },
                'k√∂zepes': { text: 'Hiba s√∫lyoss√°ga: üü† K√ñZEPES', color: '#000000', bg: '#ED7D31' },
                'magas': { text: 'Hiba s√∫lyoss√°ga: üî¥ MAGAS', color: '#000000', bg: '#FF0000' }
            };

            const config = severityConfig[severity];
            if (!config) return null;

            return {
                text: config.text,
                bold: true,
                fontSize: 10,
                color: config.color,
                background: config.bg,
                margin: [0, 5, 0, 0]
            };
        }

async function exportToPDF() {
            const projectName = document.getElementById('projectName').value || '<%= project.name %>';
            const serialNumber = document.getElementById('serialNumber').value || 'N/A';
            const inspectorPerson = document.getElementById('inspectorPerson').value || '<%= user.name %>';
            const inspectionDateValue = document.getElementById('inspectionDate').value;
            const formattedDate = inspectionDateValue ? new Date(inspectionDateValue).toLocaleDateString('hu-HU', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            }) : 'N/A';

            // Log√≥k bet√∂lt√©se base64-k√©nt
            async function imageToBase64(url) {
                try {
                    const response = await fetch(url);
                    const blob = await response.blob();
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onloadend = () => resolve(reader.result);
                        reader.onerror = reject;
                        reader.readAsDataURL(blob);
                    });
                } catch (error) {
                    console.warn(`‚ö†Ô∏è Nem siker√ºlt bet√∂lteni a log√≥t: ${url}`, error);
                    return null;
                }
            }

            const mvmLogoBase64 = await imageToBase64('/images/MVM.png');
            const iwsLogoBase64 = await imageToBase64('/images/IWS-Solutions.jpg');

            const formData = new FormData(document.getElementById('documentationForm'));
            const data = {};

            formData.forEach((value, key) => {
                data[key] = value;
            });

            // Projekt inform√°ci√≥k
            data.projectName = document.getElementById('projectName').value;
            data.serialNumber = document.getElementById('serialNumber').value;
            data.inspectorPerson = document.getElementById('inspectorPerson').value;
            data.inspectionDate = document.getElementById('inspectionDate').value;

            // Al√°√≠r√°sok
            Object.keys(signatures).forEach(key => {
                if (signatures[key]) {
                    data[`${key}_signature`] = signatures[key];
                }
            });

            // Alv√°llalkoz√≥k
            const subcontractors = [];
            const subcontractorInputs = document.querySelectorAll('[name^="subcontractor_"]');
            subcontractorInputs.forEach(input => {
                if (input.value.trim()) {
                    subcontractors.push(input.value.trim());
                }
            });
            data.subcontractors = subcontractors;

            data.witnessesVisible = witnessesVisible;
            const noWitnessCheckbox = document.getElementById('noWitnessAvailable');
            data.noWitnessAvailable = noWitnessCheckbox ? noWitnessCheckbox.checked : false;

            // K√©pek
            data.images = uploadedImages;

            // PDF defin√≠ci√≥
            const docDefinition = {
                pageSize: 'A4',
                pageMargins: [40, 60, 40, 60],
                content: [
                    { text: '4. MUNKAG√âPEK, MUNKAESZK√ñZ√ñK', style: 'header' },
                    { text: 'Ellen≈ërz√©si jegyz≈ëk√∂nyv', style: 'subheader' },
                    { text: '\n' },

                    // Projekt inform√°ci√≥k
                    {
                        table: {
                            widths: ['30%', '70%'],
                            body: [
                                [{ text: 'Projekt neve:', bold: true }, data.projectName || 'N/A'],
                                [{ text: 'Sorsz√°m:', bold: true }, data.serialNumber || 'N/A'],
                                [{ text: 'D√°tum:', bold: true }, data.inspectionDate || 'N/A'],
                                [{ text: 'Ellen≈ërz≈ë szem√©ly:', bold: true }, data.inspectorPerson || 'N/A']
                            ]
                        },
                        layout: 'lightHorizontalLines',
                        margin: [0, 0, 0, 20]
                    },

                    // R√©sztvev≈ëk
                    ...getParticipantsForPDF(data),

                    // Ellen≈ërz√©si pontok
                    ...getChecklistItemsForPDF(data),

                    // Szankci√≥k (csak ha van)
                    ...getSanctionsSectionForPDF(data)
                ],
                styles: {
                    header: { fontSize: 20, bold: true, alignment: 'center', margin: [0, 0, 0, 10] },
                    subheader: { fontSize: 14, alignment: 'center', margin: [0, 0, 0, 20] },
                    sectionHeader: { fontSize: 16, bold: true, margin: [0, 15, 0, 10] },
                    participantLabel: { fontSize: 11, bold: true, color: '#666', margin: [0, 0, 0, 3] },
                    participantName: { fontSize: 13, bold: true, margin: [0, 0, 0, 2] },
                    participantPosition: { fontSize: 11, color: '#666', margin: [0, 0, 0, 10] },
                    checklistHeader: { fontSize: 14, bold: true, margin: [0, 10, 0, 5] },
                    checklistDescription: { fontSize: 10, italics: true, color: '#666', margin: [0, 0, 0, 5] },
                    statusBadge: { fontSize: 11, bold: true, alignment: 'center', margin: [0, 5, 0, 5] },
                    imageTitle: { fontSize: 12, bold: true, margin: [0, 10, 0, 5] },
                    sanctions: { fontSize: 11, margin: [0, 3, 0, 3] },
                    sanctionsSubtitle: { fontSize: 12, italics: true, color: '#666' },
    statusOk: {
        fontSize: 11,
        color: '#000000',
        bold: true,
        background: '#66FF66',
        margin: [5, 0, 5, 5]
    },
    statusFail: {
        fontSize: 11,
        color: '#000000',
        bold: true,
        background: '#FF0000',
        margin: [5, 0, 5, 5]
    },
    statusFT: {
        fontSize: 11,
        color: '#000000',
        bold: true,
        background: '#3b82f6',
        margin: [5, 0, 5, 5]
    },
    statusNA: {
        fontSize: 11,
        color: '#92400e',
        bold: true,
        background: '#fef3c7',
        margin: [5, 0, 5, 5]
    },
    checklistTitle: {
        fontSize: 12,
        bold: true,
        margin: [5, 5, 5, 2]
    },
    notes: {
        fontSize: 9,
        italics: true,
        color: '#666',
        margin: [5, 3, 5, 5]
    },
                }
            ,

    images: {
        mvmLogo: mvmLogoBase64,
        iwsLogo: iwsLogoBase64
    }
};

            
            // ‚≠ê PDF gener√°l√°s √©s Google Drive felt√∂lt√©s
            pdfMake.createPdf(docDefinition).getBase64(async function(pdfBase64) {
                console.log('üì§ PDF base64 gener√°lva, m√©ret:', pdfBase64.length, 'karakter');
                const imageCount = Object.keys(uploadedImages).reduce((sum, key) => sum + (uploadedImages[key]?.length || 0), 0);
                console.log('üì§ K√©pek sz√°ma felt√∂lt√©sre:', imageCount);

                // ‚≠ê Progress bar megjelen√≠t√©se
                showUploadProgress();
                updateUploadProgress(10, 'PDF el≈ëk√©sz√≠t√©se...');

                try {
                    // K√ºld√©s a backend-nek
                    updateUploadProgress(20, `PDF √©s ${imageCount} k√©p felt√∂lt√©se a szerverre...`);
                    console.log('üåê Fetch kezd√©s - PDF √©s k√©pek felt√∂lt√©se...');

                    const pdfFileName = generatePdfFileName();

                    const response = await fetch('/projects/<%= project.id %>/reports/first-aid/export-pdf', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            pdfData: `data:application/pdf;base64,${pdfBase64}`,
                            serialNumber: data.serialNumber || 'N/A',
                            projectName: data.projectName || '<%= project.name %>',
                            fileName: pdfFileName,
                            images: uploadedImages
                        })
                    });

                    updateUploadProgress(40, 'V√°lasz fogad√°sa...');
                    console.log('üì° V√°lasz √©rkezett:', response.status, response.statusText);

                    if (!response.ok) {
                        hideUploadProgress();
                        throw new Error(`HTTP hiba! St√°tusz: ${response.status}`);
                    }

                    const contentType = response.headers.get('content-type');
                    if (!contentType || !contentType.includes('application/json')) {
                        hideUploadProgress();
                        const responseText = await response.text();
                        console.error('‚ùå Nem JSON v√°lasz √©rkezett:', responseText.substring(0, 500));
                        throw new Error('A szerver nem JSON v√°laszt k√ºld√∂tt. Lehet, hogy ki vagy jelentkezve vagy szerver hiba t√∂rt√©nt.');
                    }

                    updateUploadProgress(60, 'Adatok feldolgoz√°sa...');
                    const result = await response.json();
                    console.log('‚úÖ Backend v√°lasz:', result);

                    if (result.success) {
                        updateUploadProgress(80, 'Drive felt√∂lt√©s...');

                        if (result.driveUrl) {
                            updateUploadProgress(100, `‚úÖ ${imageCount} k√©p sikeresen felt√∂ltve!`);

                            setTimeout(() => {
                                hideUploadProgress();
                                alert('‚úÖ PDF sikeresen export√°lva √©s felt√∂ltve a Google Drive-ra!');
                                console.log('üìÇ Drive URL:', result.driveUrl);
                                if (result.images && result.images.length > 0) {
                                    console.log(`üì∏ ${result.images.length} k√©p sikeresen felt√∂ltve metaadatokkal`);
                                }
                            }, 500);
                        } else {
                            hideUploadProgress();
                            alert('‚úÖ PDF let√∂lt√©sre k√©sz!');
                        }
                    } else {
                        hideUploadProgress();
                        console.warn('‚ö†Ô∏è Backend hiba:', result.message);
                        alert('‚ö†Ô∏è Hiba: ' + (result.message || 'Ismeretlen hiba'));
                    }

                    // ‚≠ê PDF let√∂lt√©s (minden eszk√∂z√∂n)
                    const fileName = pdfFileName;
                    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);

                    console.log(`üì± Eszk√∂z t√≠pus: ${isMobile ? 'Mobil' : 'Asztal'}, iOS: ${isIOS}`);

                    pdfMake.createPdf(docDefinition).getBlob(function(blob) {
                        try {
                            const blobUrl = URL.createObjectURL(blob);

                            if (isIOS) {
                                console.log('üçé iOS eszk√∂z - √öj ablak megnyit√°sa');
                                const reader = new FileReader();
                                reader.onloadend = function() {
                                    const newWindow = window.open('', '_blank');
                                    if (newWindow) {
                                        newWindow.document.write(`
                                            <html>
                                            <head><title>${fileName}</title></head>
                                            <body style="margin:0;">
                                                <embed src="${reader.result}" type="application/pdf" width="100%" height="100%" />
                                            </body>
                                            </html>
                                        `);
                                    } else {
                                        alert('‚ö†Ô∏è K√©rlek enged√©lyezd az √∫j ablak megnyit√°s√°t a b√∂ng√©sz≈ëben!');
                                    }
                                };
                                reader.readAsDataURL(blob);
                            } else if (isMobile) {
                                console.log('üì± Mobil b√∂ng√©sz≈ë - Let√∂lt√©s ind√≠t√°sa');
                                const link = document.createElement('a');
                                link.href = blobUrl;
                                link.download = fileName;
                                link.style.display = 'none';
                                document.body.appendChild(link);
                                if (link.click) {
                                    link.click();
                                } else {
                                    const clickEvent = new MouseEvent('click', {
                                        view: window,
                                        bubbles: true,
                                        cancelable: true
                                    });
                                    link.dispatchEvent(clickEvent);
                                }
                                setTimeout(() => {
                                    document.body.removeChild(link);
                                    URL.revokeObjectURL(blobUrl);
                                }, 100);
                                console.log('‚úÖ PDF let√∂lt√©s elind√≠tva (mobil)');
                            } else {
                                console.log('üíª Asztali b√∂ng√©sz≈ë - Standard let√∂lt√©s');
                                const link = document.createElement('a');
                                link.href = blobUrl;
                                link.download = fileName;
                                link.style.display = 'none';
                                document.body.appendChild(link);
                                link.click();
                                setTimeout(() => {
                                    document.body.removeChild(link);
                                    URL.revokeObjectURL(blobUrl);
                                }, 100);
                            }
                        } catch (error) {
                            console.error('‚ùå PDF let√∂lt√©si hiba:', error);
                            alert('‚ö†Ô∏è Hiba t√∂rt√©nt a PDF let√∂lt√©sekor. Pr√≥b√°ld √∫jra!');
                        }
                    });

                } catch (error) {
                    hideUploadProgress();
                    console.error('‚ùå Kritikus hiba a PDF export√°l√°s sor√°n:', error);

                    let errorMessage = '‚ö†Ô∏è Hiba t√∂rt√©nt a PDF export√°l√°sa k√∂zben.\n\n';

                    if (error.name === 'TypeError' && error.message.includes('fetch')) {
                        errorMessage += 'H√°l√≥zati kapcsolat hiba. Ellen≈ërizd az internet kapcsolatot √©s pr√≥b√°ld √∫jra!';
                    } else if (error.message.includes('HTTP hiba')) {
                        errorMessage += 'Szerver hiba: ' + error.message;
                    } else {
                        errorMessage += error.message || 'Ismeretlen hiba t√∂rt√©nt.';
                    }

                    alert(errorMessage);

                    // Pr√≥b√°ljunk helyi let√∂lt√©st biztons√°gi ment√©sk√©nt
                    console.log('üîÑ Pr√≥b√°lkoz√°s helyi PDF let√∂lt√©ssel...');
                    try {
                        const fileName = generatePdfFileName();
                        pdfMake.createPdf(docDefinition).download(fileName);
                        console.log('‚úÖ Helyi let√∂lt√©s siker√ºlt');
                    } catch (downloadError) {
                        console.error('‚ùå Helyi let√∂lt√©s is sikertelen:', downloadError);
                    }
                }
            });

            console.log('‚úì PDF export folyamat elind√≠tva');


            console.log('‚úì PDF gener√°lva');
        }

        // R√©sztvev≈ëk PDF-hez
        function getParticipantsForPDF(data) {
            const result = [
                { text: 'R√âSZTVEV≈êK', style: 'sectionHeader' }
            ];

            // Ellen≈ërz≈ë
            result.push({
                columns: [
                    {
                        width: '*',
                        stack: [
                            { text: 'Ellen≈ërz√©st v√©gz≈ë', style: 'participantLabel' },
                            { text: data.inspector_name || 'N/A', style: 'participantName' },
                            { text: data.inspector_position || '', style: 'participantPosition' }
                        ]
                    },
                    {
                        width: 150,
                        stack: [
                            signatures.inspector ? {
                                image: signatures.inspector,
                                width: 120,
                                alignment: 'center',
                                margin: [0, 5, 0, 0]
                            } : {
                                text: '[Al√°√≠r√°s hi√°nyzik]',
                                italics: true,
                                color: '#999',
                                fontSize: 9,
                                alignment: 'center',
                                margin: [0, 20, 0, 0]
                            }
                        ]
                    }
                ],
                margin: [0, 0, 0, 15],
                unbreakable: true
            });

            // Felel≈ës
            result.push({
                columns: [
                    {
                        width: '*',
                        stack: [
                            { text: 'Munkater√ºlet√©rt felel≈ës', style: 'participantLabel' },
                            { text: data.responsible_name || 'N/A', style: 'participantName' },
                            { text: data.responsible_position || '', style: 'participantPosition' }
                        ]
                    },
                    {
                        width: 150,
                        stack: [
                            signatures.responsible ? {
                                image: signatures.responsible,
                                width: 120,
                                alignment: 'center',
                                margin: [0, 5, 0, 0]
                            } : {
                                text: '[Al√°√≠r√°s hi√°nyzik]',
                                italics: true,
                                color: '#999',
                                fontSize: 9,
                                alignment: 'center',
                                margin: [0, 20, 0, 0]
                            }
                        ]
                    }
                ],
                margin: [0, 0, 0, 15],
                unbreakable: true
            });

            // Alv√°llalkoz√≥k
            if (data.subcontractors && data.subcontractors.length > 0) {
                result.push({
                    text: 'Alv√°llalkoz√≥i l√°nc',
                    style: 'participantLabel',
                    margin: [0, 10, 0, 5]
                });

                result.push({
                    text: '1. MVM Xpert Zrt.',
                    fontSize: 11,
                    margin: [0, 0, 0, 3]
                });

                data.subcontractors.forEach((company, index) => {
                    result.push({
                        text: `${index + 2}. ${company}`,
                        fontSize: 11,
                        margin: [0, 0, 0, 3]
                    });
                });

                result.push({ text: '\n' });
            }

            // Tan√∫k
            const noWitnessCheckbox = document.getElementById('noWitnessAvailable');
            if (noWitnessCheckbox && noWitnessCheckbox.checked) {
                result.push({
                    text: 'Tan√∫k',
                    style: 'participantLabel',
                    margin: [0, 0, 0, 5]
                });
                result.push({
                    text: 'Nem √°ll rendelkez√©sre Tan√∫',
                    style: 'participantName',
                    italics: true,
                    color: '#999',
                    margin: [0, 0, 0, 15]
                });
                return result;
            }

            if (!witnessesVisible || witnessCounter === 0) {
                return result;
            }

            for (let i = 0; i < 2; i++) {
                const witnessName = data[`witness_name_${i}`];
                const witnessPosition = data[`witness_position_${i}`];
                const witnessIdNumber = data[`witness_id_number_${i}`];
                const witnessAddress = data[`witness_address_${i}`];
                const witnessSignature = signatures[`witness_${i}`];

                result.push({
                    columns: [
                        {
                            width: '*',
                            stack: [
                                { text: `Tan√∫ ${i + 1}`, style: 'participantLabel' },
                                { text: witnessName || 'N/A', style: 'participantName' },
                                { text: witnessPosition || '', style: 'participantPosition' },
                                { text: `Szem√©lyi sz√°m: ${witnessIdNumber || 'N/A'}`, fontSize: 9, margin: [0, 3, 0, 0] },
                                { text: `Lakc√≠m: ${witnessAddress || 'N/A'}`, fontSize: 9, margin: [0, 2, 0, 0] }
                            ]
                        },
                        {
                            width: 150,
                            stack: [
                                witnessSignature ? {
                                    image: witnessSignature,
                                    width: 120,
                                    alignment: 'center',
                                    margin: [0, 5, 0, 0]
                                } : {
                                    text: '[Al√°√≠r√°s hi√°nyzik]',
                                    italics: true,
                                    color: '#999',
                                    fontSize: 9,
                                    alignment: 'center',
                                    margin: [0, 20, 0, 0]
                                }
                            ]
                        }
                    ],
                    margin: [0, 0, 0, 10],
                    unbreakable: true
                });
            }

            return result;
        }

        // Ellen≈ërz√©si pontok PDF-hez
        
        function getChecklistItemsForPDF(data) {
            const result = [
                {
                    text: 'ELLEN≈êRZ√âSI PONTOK',
                    style: 'sectionHeader',
                    margin: [0, 10, 0, 10],
                    pageBreak: 'before'
                }
            ];

            const items = [
                    { id: '7_1', label: 'Els≈ëseg√©ly felszerel√©sek, dobozok felt√∂lt√∂tts√©ge, el√©rhet≈ës√©ge' },
                    { id: '7_2', label: 'Els≈ëseg√©lyny√∫jt√≥k kijel√∂l√©se, k√©pzetts√©ge, tan√∫s√≠tv√°nyok' },
                    { id: '7_3', label: 'Els≈ëseg√©ly ny√∫jt√°si pontok jel√∂l√©se, t√°bl√°k' },
                    { id: '7_4', label: 'Szem√∂bl√≠t≈ë, vegyszeres s√©r√ºl√©s elleni felszerel√©sek' },
                    { id: '7_5', label: 'Els≈ëseg√©lyny√∫jt√°ssal kapcsolatos dokument√°ci√≥k, utas√≠t√°sok' }
                ];

            items.forEach(item => {
                const status = data['item_' + item.id];
                const notes = data['notes_' + item.id];

                // Table minden ellen≈ërz√©si ponthoz (documentation.ejs mint√°j√°ra)
                result.push({
                    table: {
                        widths: ['*'],
                        body: [[
                            {
                                stack: [
                                    { text: item.label, style: 'checklistTitle' },
                                    { text: '√ârt√©kel√©s: ' + getStatusText(status), style: getStatusStyle(status), margin: [0, 5, 0, 0] },
                                    getSeverityBadge(item.id, data) || {},
                                    notes ? { text: 'Megjegyz√©s: ' + notes, style: 'notes' } : {}
                                ].filter(Boolean),
                                border: [true, true, true, true],
                                fillColor: '#fafafa'
                            }
                        ]]
                    },
                    layout: {
                        hLineColor: '#333',
                        vLineColor: '#333',
                        hLineWidth: function() { return 1; },
                        vLineWidth: function() { return 1; }
                    },
                    margin: [0, 0, 0, 8],
                    unbreakable: true
                });

                // K√©pek hozz√°ad√°sa az adott ellen≈ërz√©si ponthoz
                result.push(...getImagesForPDF(item.id));
            });

            return result;
        }


        // Szankci√≥k PDF-hez
        function getAppliedSanctionsForPDF(data) {
            const sanctionLabels = {
                    sanction_1: '1. Felel≈ës szem√©ly hi√°nya',
                    sanction_3: '3. Els≈ëseg√©lyny√∫jt√°si felszerel√©sek, eszk√∂z√∂k hi√°nya vagy nem megfelel≈ës√©ge'
                };

            const sanctionPricesRaw = {
                    sanction_1: 100000,
                    sanction_3: 50000
                };

            const result = [];
            let hasAny = false;

            const checkboxes = document.querySelectorAll('.price-item input[type="checkbox"]');

            checkboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    const sanctionKey = checkbox.name;
                    hasAny = true;

                    const countInput = document.querySelector('input[name="' + sanctionKey + '_count"]');
                    const count = countInput ? parseInt(countInput.value) || 1 : 1;
                    const basePrice = sanctionPricesRaw[sanctionKey];
                    const totalPrice = basePrice * count;
                    const formattedPrice = totalPrice.toLocaleString('hu-HU') + ' Ft';

                    const countText = count > 1 ? ' (' + count + 'x)' : '';

                    result.push({
                        text: '‚Ä¢ ' + sanctionLabels[sanctionKey] + countText + ' - ' + formattedPrice,
                        style: 'sanctions',
                        margin: [0, 3, 0, 3]
                    });
                }
            });

            return { sanctions: result, hasAny: hasAny };
        }

        function getSanctionsSectionForPDF(data) {
            const sanctionsData = getAppliedSanctionsForPDF(data);

            if (!sanctionsData.hasAny) {
                return [];
            }

            const totalPriceElement = document.getElementById('totalPrice');

            return [
                {
                    text: 'SZANKCI√ìS LISTA',
                    style: 'sectionHeader',
                    margin: [0, 15, 0, 10]
                },
                {
                    text: 'Els≈ëseg√©lyny√∫jt√°s kateg√≥ria vonatkoz√≥ pontjai',
                    style: 'sanctionsSubtitle',
                    margin: [0, 0, 0, 10]
                },
                ...sanctionsData.sanctions,
                {
                    table: {
                        widths: ['*', 'auto'],
                        body: [[
                            { text: 'Kiszabhat√≥ √∂sszes√≠tett b√≠rs√°g:', bold: true, fontSize: 14, alignment: 'right', border: [false, true, false, false], margin: [0, 10, 0, 10] },
                            { text: totalPriceElement.textContent, bold: true, fontSize: 16, color: '#dc3545', alignment: 'right', border: [false, true, false, false], margin: [0, 10, 0, 10] }
                        ]]
                    },
                    layout: {
                        hLineColor: '#333',
                        hLineWidth: function() { return 2; }
                    },
                    margin: [0, 10, 0, 0]
                }
            ];
        }

        // K√©pek PDF-hez metaadatokkal
        function getImagesForPDF(itemId) {
            const images = uploadedImages[itemId];
            if (!images || images.length === 0) {
                return [];
            }

            const result = [
                {
                    text: 'Csatolt f√©nyk√©pek / dokument√°ci√≥:',
                    style: 'imageTitle',
                    margin: [0, 10, 0, 8]
                }
            ];

            for (let i = 0; i < images.length; i++) {
                const imgObj = images[i];
                const imageData = imgObj.data;
                const metadata = imgObj.metadata || {};

                result.push({
                    image: imageData,
                    width: 300,
                    alignment: 'center',
                    margin: [0, 5, 0, 5]
                });

                const metaText = [];

                if (metadata.fileName) {
                    metaText.push(`üìÑ ${metadata.fileName}`);
                }

                if (metadata.hasDate && metadata.takenDate) {
                    try {
                        const formattedMeta = formatDate(metadata.takenDate);
                        metaText.push(`üìÖ Felv√©tel ideje: ${formattedMeta}`);
                    } catch (e) {
                        console.warn('D√°tum form√°z√°si hiba:', e);
                    }
                }

                if (metadata.hasGPS && metadata.location) {
                    metaText.push(`üìç Helysz√≠n: ${metadata.location}`);
                }

                if (metadata.camera) {
                    metaText.push(`üì∑ ${metadata.camera}`);
                }

                if (!metadata.hasDate || !metadata.hasGPS) {
                    metaText.push(`‚ö†Ô∏è Hi√°nyos metaadatok`);
                }

                if (metaText.length === 0) {
                    metaText.push(`K√©p ${i + 1}`);
                }

                result.push({
                    text: metaText.join('\n'),
                    fontSize: 9,
                    color: '#666',
                    italics: true,
                    margin: [0, 3, 0, 15]
                });
            }

            return result;
        }

        // Modal bez√°r√°sa kattint√°ssal a h√°tt√©rre
        window.onclick = function(event) {
            const modal = document.getElementById('signatureModal');
            if (event.target == modal) {
                closeSignatureModal();
            }
        }

        // Mentett adatok bet√∂lt√©se a form-ba
function loadSavedData(data) {
    console.log('loadSavedData megh√≠vva:', data);

    // Projekt inform√°ci√≥k
    if (data.projectName) {
        document.getElementById('projectName').value = data.projectName;
    }
    if (data.serialNumber) {
        document.getElementById('serialNumber').value = data.serialNumber;
    }
    if (data.inspectorPerson) {
        document.getElementById('inspectorPerson').value = data.inspectorPerson;
    }
    if (data.inspectionDate) {
        document.getElementById('inspectionDate').value = data.inspectionDate;
    }

    // R√©sztvev≈ëk
    if (data.inspector_name) {
        document.querySelector('input[name="inspector_name"]').value = data.inspector_name;
    }
    if (data.inspector_position) {
        document.querySelector('input[name="inspector_position"]').value = data.inspector_position;
    }
    if (data.responsible_name) {
        document.querySelector('input[name="responsible_name"]').value = data.responsible_name;
    }
    if (data.responsible_position) {
        document.querySelector('input[name="responsible_position"]').value = data.responsible_position;
    }

    // Al√°√≠r√°sok bet√∂lt√©se
    if (data.inspector_signature) {
        signatures.inspector = data.inspector_signature;
        document.getElementById('inspectorSignature').value = data.inspector_signature;
        document.getElementById('inspectorPreview').innerHTML = `<img src="${data.inspector_signature}" alt="Al√°√≠r√°s">`;
        document.getElementById('inspectorClear').style.display = 'block';
    }

    if (data.responsible_signature) {
        signatures.responsible = data.responsible_signature;
        document.getElementById('responsibleSignature').value = data.responsible_signature;
        document.getElementById('responsiblePreview').innerHTML = `<img src="${data.responsible_signature}" alt="Al√°√≠r√°s">`;
        document.getElementById('responsibleClear').style.display = 'block';
    }

    // Tan√∫k bet√∂lt√©se
    if (data.witness_name_0 || data.witness_name_1 || data.witnessesVisible) {
        showWitnesses();

        setTimeout(() => {
            for (let i = 0; i < 2; i++) {
                const nameInput = document.querySelector(`input[name="witness_name_${i}"]`);
                const positionInput = document.querySelector(`input[name="witness_position_${i}"]`);
                const idNumberInput = document.querySelector(`input[name="witness_id_number_${i}"]`);
                const addressInput = document.querySelector(`input[name="witness_address_${i}"]`);

                if (nameInput && data[`witness_name_${i}`]) {
                    nameInput.value = data[`witness_name_${i}`];
                }
                if (positionInput && data[`witness_position_${i}`]) {
                    positionInput.value = data[`witness_position_${i}`];
                }
                if (idNumberInput && data[`witness_id_number_${i}`]) {
                    idNumberInput.value = data[`witness_id_number_${i}`];
                }
                if (addressInput && data[`witness_address_${i}`]) {
                    addressInput.value = data[`witness_address_${i}`];
                }

                if (data[`witness_signature_${i}`]) {
                    signatures[`witness_${i}`] = data[`witness_signature_${i}`];
                    const sigInput = document.getElementById(`witness_${i}Signature`);
                    const preview = document.getElementById(`witnessPreview_${i}`);
                    const clearBtn = document.getElementById(`witness_${i}Clear`);

                    if (sigInput) sigInput.value = data[`witness_signature_${i}`];
                    if (preview) preview.innerHTML = `<img src="${data[`witness_signature_${i}`]}" alt="Al√°√≠r√°s">`;
                    if (clearBtn) clearBtn.style.display = 'block';
                }
            }

            if (data.noWitnessAvailable) {
                document.getElementById('noWitnessAvailable').checked = true;
                toggleNoWitness();
            }
        }, 200);
    }

    // Alv√°llalkoz√≥k bet√∂lt√©se
    if (data.subcontractors && Array.isArray(data.subcontractors)) {
        data.subcontractors.forEach(companyName => {
            if (companyName && companyName !== 'MVM Xpert Zrt.') {
                addSubcontractor();
                const items = document.querySelectorAll('.subcontractor-item');
                const lastItem = items[items.length - 1];
                if (lastItem) {
                    const input = lastItem.querySelector('input');
                    if (input) input.value = companyName;
                }
            }
        });
    }

    // Ellen≈ërz√©si pontok
    ['item_7_1', 'item_7_2', 'item_7_3', 'item_7_4', 'item_7_5', 'item_7_5', 'item_7_5', 'item_7_5'].forEach(itemName => {
        if (data[itemName]) {
            const radio = document.querySelector(`input[name="${itemName}"][value="${data[itemName]}"]`);
            if (radio) {
                radio.checked = true;
                const itemId = itemName.replace('item_', '');
                toggleSeverity(itemId);
            }
        }

        const severityKey = `${itemName}_severity`;
        if (data[severityKey]) {
            const severityRadio = document.querySelector(`input[name="${severityKey}"][value="${data[severityKey]}"]`);
            if (severityRadio) severityRadio.checked = true;
        }
    });

    // Megjegyz√©sek
    ['notes_7_1', 'notes_7_2', 'notes_7_3', 'notes_7_4', 'notes_7_5', 'notes_7_5', 'notes_7_5', 'notes_7_5'].forEach(noteName => {
        if (data[noteName]) {
            const textarea = document.querySelector(`textarea[name="${noteName}"]`);
            if (textarea) textarea.value = data[noteName];
        }
    });

    // K√©pek bet√∂lt√©se metaadatokkal
    if (data.images) {
        ['7_1', '7_2', '7_3', '7_4', '7_5', '7_5', '7_5', '7_5'].forEach(itemId => {
            if (data.images[itemId] && Array.isArray(data.images[itemId])) {
                uploadedImages[itemId] = data.images[itemId];

                const previewContainer = document.getElementById(`preview_${itemId}`);
                data.images[itemId].forEach(imgObj => {
                    const imageData = imgObj.data || imgObj;
                    const metadata = imgObj.metadata || {};

                    const previewItem = document.createElement('div');
                    previewItem.className = 'image-preview-item';

                    const img = document.createElement('img');
                    img.src = imageData;
                    img.style.width = '100%';
                    img.style.height = '200px';
                    img.style.objectFit = 'cover';
                    img.style.display = 'block';

                    const metaInfo = document.createElement('div');
                    metaInfo.className = 'image-meta-info';

                    let metaHTML = '';

                    if (metadata.hasDate && metadata.takenDate) {
                        metaHTML += `
                            <div class="meta-item">
                                <i class="fas fa-calendar"></i>
                                <span>${formatDate(metadata.takenDate)}</span>
                            </div>
                        `;
                    }

                    if (metadata.hasGPS && metadata.location && metadata.latitude && metadata.longitude) {
                        metaHTML += `
                            <div class="meta-item">
                                <i class="fas fa-map-marker-alt"></i>
                                <span>
                                    <a href="https://www.google.com/maps?q=${metadata.latitude},${metadata.longitude}"
                                       target="_blank"
                                       rel="noopener noreferrer"
                                       class="map-link"
                                       style="color: #4CAF50; text-decoration: none; font-weight: bold;">
                                       ${metadata.location}
                                    </a>
                                </span>
                            </div>
                        `;
                    } else {
                        metaHTML += `
                            <div class="meta-item">
                                <i class="fas fa-map-marker-alt"></i>
                                <span style="color: #ffc107;">Nincs GPS adat</span>
                            </div>
                        `;
                    }

                    if (!metadata.hasDate || !metadata.hasGPS) {
                        metaHTML += `
                            <div class="no-metadata-warning">
                                <i class="fas fa-exclamation-triangle"></i>
                                <span>Hi√°nyos metaadatok</span>
                            </div>
                        `;
                    }

                    metaInfo.innerHTML = metaHTML;

                    const removeBtn = document.createElement('button');
                    removeBtn.className = 'image-remove-btn';
                    removeBtn.innerHTML = '&times;';
                    removeBtn.title = 'K√©p elt√°vol√≠t√°sa';
                    removeBtn.onclick = function(e) {
                        e.stopPropagation();
                        const index = uploadedImages[itemId].findIndex(img => {
                            if (typeof img === 'object' && img.data) {
                                return img.data === imageData;
                            }
                            return img === imageData;
                        });
                        if (index > -1) {
                            uploadedImages[itemId].splice(index, 1);
                        }
                        previewItem.remove();
                    };

                    previewItem.appendChild(img);
                    previewItem.appendChild(metaInfo);
                    previewItem.appendChild(removeBtn);
                    previewContainer.appendChild(previewItem);
                });
            }
        });
    }

    // Szankci√≥k bet√∂lt√©se
    const checkboxes = document.querySelectorAll('.price-item input[type="checkbox"]');
    checkboxes.forEach(checkbox => {
        if (data[checkbox.name] === 'on' || data[checkbox.name] === checkbox.value) {
            checkbox.checked = true;
        }

        const sanctionKey = checkbox.name;
        const countKey = `${sanctionKey}_count`;
        if (data[countKey]) {
            const countInput = document.querySelector(`input[name="${countKey}"]`);
            if (countInput) {
                countInput.value = data[countKey];
            }
        }
    });
    calculateTotal();

    console.log('‚úì Mentett adatok sikeresen bet√∂ltve a form-ba');
}
    </script>


    <!-- ‚≠ê Progress bar overlay -->
    <div id="uploadProgressOverlay" class="upload-progress-overlay">
        <div class="upload-progress-container">
            <div class="upload-progress-title">üì§ Felt√∂lt√©s folyamatban...</div>
            <div class="upload-progress-bar-container">
                <div id="uploadProgressBar" class="upload-progress-bar"></div>
                <div id="uploadProgressText" class="upload-progress-text">0%</div>
            </div>
            <div id="uploadProgressStatus" class="upload-progress-status">Inicializ√°l√°s...</div>
        </div>
    </div>

</body>
</html>
