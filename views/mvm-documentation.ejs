<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>1. Dokument√°ci√≥ - <%= project.name %></title>
     <link rel="stylesheet" href="/css/pages/mvm-documentation.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.min.js"></script>
    <!-- ‚≠ê EXIF.js - √∫jabb verzi√≥ mobilos kompatibilit√°ssal -->
    <script src="https://cdn.jsdelivr.net/npm/exif-js@2.3.0/exif.min.js"></script>

    <!-- ‚≠ê HEIC to JPEG konverzi√≥hoz -->
    <script src="https://cdn.jsdelivr.net/npm/heic2any@0.0.4/dist/heic2any.min.js"></script>

    <!-- ‚≠ê exifr - HEIC EXIF t√°mogat√°ssal (TELJES verzi√≥ GPS parsing-gel) -->
    <script src="https://cdn.jsdelivr.net/npm/exifr@7.1.3/dist/full.umd.js"></script>

    <!-- ‚≠ê piexifjs - GPS √≠r√°sra/olvas√°sra optimaliz√°lt (mobil kompatibilit√°s) -->
    <script src="https://cdn.jsdelivr.net/npm/piexifjs@1.0.6/piexif.min.js"></script>

    <!-- ‚≠ê EXIF metaadatok megjelen√≠t√©s√©re CSS -->
   
</head>
<body>

    <% 
// Eld√∂ntj√ºk hogy admin vagy user oldal kell
const isAdmin = user.isAdmin || false;
const backUrl = isAdmin 
    ? `/admin/projects/${project.id}` 
    : `/user/projects/${project.id}`;
%>

<a href="<%= backUrl %>" class="back-button">
    <i class="fas fa-arrow-left"></i> Vissza a kateg√≥ri√°khoz
</a>

    <div class="container">

        <!-- Projekt inform√°ci√≥k -->
        <div class="project-info">
            <h3><i class="fas fa-project-diagram"></i> Projekt r√©szletek</h3>
            
            <div class="form-group" style="margin-bottom: 15px;">
                <label for="projectName"><strong>Projekt neve:</strong></label>
                <input type="text" id="projectName" name="projectName" value="<%= project.name %>" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
            </div>

            <div class="form-group" style="margin-bottom: 15px;">
                <label for="inspectionDate"><strong>D√°tum:</strong></label>
                <input type="date" id="inspectionDate" name="inspectionDate" onchange="updateSerialNumber()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
            </div>

            <div class="form-group" style="margin-bottom: 15px;">
                <label for="serialNumber"><strong>Sorsz√°m:</strong></label>
                <input type="text" id="serialNumber" name="serialNumber" placeholder="Pl. IWS/BCS/20251201" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                <% if (project.serial_prefix) { %>
                    <p style="font-size: 11px; color: #666; margin-top: 5px;">A sorsz√°m automatikusan gener√°l√≥dik a d√°tum kiv√°laszt√°sa alapj√°n</p>
                <% } %>
            </div>

            <div class="form-group" style="margin-bottom: 15px;">
                <label for="inspectorPerson"><strong>Ellen≈ërz≈ë szem√©ly:</strong></label>
                <input type="text" id="inspectorPerson" name="inspectorPerson" value="<%= user.username %>" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
            </div>

            <p style="font-size: 13px; color: #999; margin-top: 10px;">
                <em>Projekt t√≠pus: <%= project.project_type %></em>
            </p>

            <!--  √öJ ellen≈ërz√©s GOMB -->
<div style="text-align: center; margin: 20px 0;">
    <button type="button" class="add-button" onclick="startNewInspection()" style="width: auto; padding: 12px 30px;">
        <i class="fas fa-plus"></i> √öj ellen≈ërz√©s ind√≠t√°sa
    </button>
</div>

        </div>

        <!-- Header -->
        <div class="header">
            <h1>1. Dokument√°ci√≥</h1>
            <p>Munkater√ºlet√©rt felel≈ës beazonos√≠t√°sa, enged√©lyek, tervdokument√°ci√≥k ellen≈ërz√©se</p>
        </div>

        <form id="documentationForm" method="POST" action="/projects/<%= project.id %>/reports/documentation">

            <!-- Ellen≈ërz√©s r√©sztvev≈ëi -->
            <div class="form-section">
                <div class="section-title">Ellen≈ërz√©s r√©sztvev≈ëi</div>
                
                <!-- Ellen≈ërz√©st v√©gz≈ë -->
                <div class="form-group">
                    <label>Ellen≈ërz√©st v√©gz≈ë</label>
                    <div class="two-column">
                        <input type="text" name="inspector_name" placeholder="N√©v" value="<%= user.username %>">
                        <input type="text" name="inspector_position" placeholder="Beoszt√°s">
                    </div>
                    
                    <div class="signature-container">
                        <div class="signature-preview" id="inspectorPreview" onclick="openSignatureModal('inspector')">
                            <span><i class="fas fa-pen"></i> Kattintson ide az al√°√≠r√°s hozz√°ad√°s√°hoz</span>
                        </div>
                        <div class="signature-buttons">
                            <button type="button" class="add-button" onclick="openSignatureModal('inspector')">
                                <i class="fas fa-signature"></i> Al√°√≠r√°s hozz√°ad√°sa
                            </button>
                            <button type="button" class="clear-signature" onclick="clearSignature('inspector')" style="display: none;" id="inspectorClear">
                                <i class="fas fa-trash"></i> T√∂rl√©s
                            </button>
                        </div>
                    </div>
                    <input type="hidden" name="inspector_signature" id="inspectorSignature">
                </div>

                <!-- Munkater√ºlet√©rt felel≈ës -->
                <div class="form-group">
                    <label>Munkater√ºlet√©rt felel≈ës</label>
                    <div class="two-column">
                        <input type="text" name="responsible_name" placeholder="Munkater√ºlet√©rt felel≈ës neve">
                        <input type="text" name="responsible_position" placeholder="Beoszt√°s">
                    </div>
                    
                    <div class="signature-container">
                        <div class="signature-preview" id="responsiblePreview" onclick="openSignatureModal('responsible')">
                            <span><i class="fas fa-pen"></i> Kattintson ide az al√°√≠r√°s hozz√°ad√°s√°hoz</span>
                        </div>
                        <div class="signature-buttons">
                            <button type="button" class="add-button" onclick="openSignatureModal('responsible')">
                                <i class="fas fa-signature"></i> Al√°√≠r√°s hozz√°ad√°sa
                            </button>
                            <button type="button" class="clear-signature" onclick="clearSignature('responsible')" style="display: none;" id="responsibleClear">
                                <i class="fas fa-trash"></i> T√∂rl√©s
                            </button>
                        </div>
                    </div>
                    <input type="hidden" name="responsible_signature" id="responsibleSignature">
                </div>

                <!-- Tan√∫k - Alapb√≥l elrejtve -->
        <div id="witnessToggleButton" style="margin-bottom: 15px; text-align: center;">
    <button 
        type="button" 
        class="add-button witness-button" 
        onclick="showWitnesses()"
    >
        <i class="fas fa-user-times"></i> Al√°√≠r√°st megtagadta
    </button>
</div>

                <div id="witnessSection" style="display: none;">
                    <div id="witnessesContainer"></div>

                    <div style="margin-top: 15px; padding: 10px; background-color: #f8f9fa; border-radius: 6px;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="noWitnessAvailable" onchange="toggleNoWitness()" style="margin-right: 10px; width: 18px; height: 18px;">
                            <span style="font-weight: 500;">Nem √°ll rendelkez√©sre Tan√∫</span>
                        </label>
                    </div>
                </div>

                <!-- Alv√°llalkoz√≥i l√°nc -->
                <div class="form-group">
                    <label>Alv√°llalkoz√≥i l√°nc</label>
                    <div style="background-color: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                        <div style="display: flex; align-items: center; margin-bottom: 8px;">
                            <span style="font-weight: 600; color: #2c5282; margin-right: 10px;">1.</span>
                            <input type="text" value="MVM Xpert Zrt." readonly
                                   style="flex: 1; background-color: #e8f4f8; border: 2px solid #bee3f8; padding: 8px 12px; border-radius: 6px; font-weight: 500;">
                        </div>
                        <div id="subcontractorsList"></div>
                        <button type="button" class="add-button" onclick="addSubcontractor()" style="margin-top: 10px; width: 100%;">
                            <i class="fas fa-plus"></i> Alv√°llalkoz√≥ c√©g hozz√°ad√°sa
                        </button>
                    </div>
                </div>
            </div>

            <!-- 1.1 Munkater√ºlet√©rt felel≈ës beazonos√≠t√°sa -->
            <div class="checklist-item">
                <div class="checklist-header">1.1 Munkater√ºlet√©rt felel≈ës beazonos√≠t√°sa</div>
                <div class="checklist-description">√Åtad√°s √°tv√©tel jegyz≈ëk√∂nyv fellelhet≈ës√©ge, munkaenged√©ly, stb.</div>
                
                <div class="radio-options">
                    <div class="radio-option success">
                        <input type="radio" id="item_1_1_m" name="item_1_1" value="megfelel≈ë" onchange="toggleSeverity('1_1')">
                        <label for="item_1_1_m">Megfelelt</label>
                    </div>
                    <div class="radio-option danger">
                        <input type="radio" id="item_1_1_nm" name="item_1_1" value="nem_megfelel≈ë" onchange="toggleSeverity('1_1')">
                        <label for="item_1_1_nm">Nem megfelelt</label>
                    </div>
                    <div class="radio-option info">
                        <input type="radio" id="item_1_1_ft" name="item_1_1" value="felsz√≥l√≠t√°s_ut√°n" onchange="toggleSeverity('1_1')">
                        <label for="item_1_1_ft">Felsz√≥l√≠t√°s ut√°n teljes√≠tve</label>
                    </div>
                    <div class="radio-option warning">
                        <input type="radio" id="item_1_1_nv" name="item_1_1" value="nem_vizsg√°lt" onchange="toggleSeverity('1_1')">
                        <label for="item_1_1_nv">Nem vonatkozik / Nem vizsg√°lt</label>
                    </div>
                </div>

                <div id="severity_1_1" class="severity-selector" style="display: none; margin-top: 15px; padding: 15px; background-color: #f7fafc; border-radius: 8px;">
                    <label style="font-weight: 600; display: block; margin-bottom: 10px;">Hiba s√∫lyoss√°ga:</label>
                    <div class="radio-options">
                        <div class="radio-option" style="border-color: #FFFF00;">
                            <input type="radio" id="item_1_1_sev_low" name="item_1_1_severity" value="alacsony">
                            <label for="item_1_1_sev_low" style="color: #000000;">üü°Alacsony</label>
                        </div>
                        <div class="radio-option" style="border-color: #ED7D31;">
                            <input type="radio" id="item_1_1_sev_medium" name="item_1_1_severity" value="k√∂zepes">
                            <label for="item_1_1_sev_medium" style="color: #000000;">üü†K√∂zepes</label>
                        </div>
                        <div class="radio-option" style="border-color: #FF0000;">
                            <input type="radio" id="item_1_1_sev_high" name="item_1_1_severity" value="magas">
                            <label for="item_1_1_sev_high" style="color: #000000;">üî¥Magas</label>
                        </div>
                    </div>
                </div>

              <div class="form-group" style="margin-top: 15px;">
    <label><i class="fas fa-camera"></i> F√©nyk√©pek / dokument√°ci√≥</label>
    <p style="font-size: 11px; color: #4CAF50; margin: 5px 0;">
        <i class="fas fa-check-circle"></i> Minden k√©pform√°tum t√°mogatott (HEIC is) ‚Ä¢ Automatikus t√∂m√∂r√≠t√©s
    </p>

    <!-- Rejtett file input -->
    <input 
        type="file" 
        id="photos_1_1" 
        multiple 
        onchange="handleImageUpload(event, '1_1')" 
        style="display: none;"
    >

    <!-- Sz√©p gomb -->
    <button type="button" class="upload-btn" onclick="document.getElementById('photos_1_1').click()">
        <i class="fas fa-upload"></i> F√°jlok felt√∂lt√©se
    </button>

    <div id="preview_1_1" class="image-preview-container"></div>
</div>

                <textarea class="notes-textarea" name="notes_1_1" placeholder="Megjegyz√©s..."></textarea>
            </div>

            <!-- 1.2 Egy√©b dokument√°ci√≥k -->
            <div class="checklist-item">
                <div class="checklist-header">1.2 Egy√©b dokument√°ci√≥k</div>
                <div class="checklist-description">√âp√≠t√©si napl√≥, hullad√©k nyilv√°ntart√≥lap stb.</div>
                
                <div class="radio-options">
                    <div class="radio-option success">
                        <input type="radio" id="item_1_2_m" name="item_1_2" value="megfelel≈ë" onchange="toggleSeverity('1_2')">
                        <label for="item_1_2_m">Megfelelt</label>
                    </div>
                    <div class="radio-option danger">
                        <input type="radio" id="item_1_2_nm" name="item_1_2" value="nem_megfelel≈ë" onchange="toggleSeverity('1_2')">
                        <label for="item_1_2_nm">Nem megfelelt</label>
                    </div>
                    <div class="radio-option info">
                        <input type="radio" id="item_1_2_ft" name="item_1_2" value="felsz√≥l√≠t√°s_ut√°n" onchange="toggleSeverity('1_2')">
                        <label for="item_1_2_ft">Felsz√≥l√≠t√°s ut√°n teljes√≠tve</label>
                    </div>
                    <div class="radio-option warning">
                        <input type="radio" id="item_1_2_nv" name="item_1_2" value="nem_vizsg√°lt" onchange="toggleSeverity('1_2')">
                        <label for="item_1_2_nv">Nem vonatkozik / Nem vizsg√°lt</label>
                    </div>
                </div>

                <div id="severity_1_2" class="severity-selector" style="display: none; margin-top: 15px; padding: 15px; background-color: #f7fafc; border-radius: 8px;">
                    <label style="font-weight: 600; display: block; margin-bottom: 10px;">Hiba s√∫lyoss√°ga:</label>
                    <div class="radio-options">
                        <div class="radio-option" style="border-color: #FFFF00;">
                            <input type="radio" id="item_1_2_sev_low" name="item_1_2_severity" value="alacsony">
                            <label for="item_1_2_sev_low" style="color: #000000;">üü°Alacsony</label>
                        </div>
                        <div class="radio-option" style="border-color: #ED7D31;">
                            <input type="radio" id="item_1_2_sev_medium" name="item_1_2_severity" value="k√∂zepes">
                            <label for="item_1_2_sev_medium" style="color: #000000;">üü†K√∂zepes</label>
                        </div>
                        <div class="radio-option" style="border-color: #FF0000;">
                            <input type="radio" id="item_1_2_sev_high" name="item_1_2_severity" value="magas">
                            <label for="item_1_2_sev_high" style="color: #000000;">üî¥Magas</label>
                        </div>
                    </div>
                </div>

                <div class="form-group" style="margin-top: 15px;">
    <label><i class="fas fa-camera"></i> F√©nyk√©pek / dokument√°ci√≥</label>

    <!-- Rejtett file input -->
    <input 
        type="file" 
        id="photos_1_2" 
        multiple 
        onchange="handleImageUpload(event, '1_2')" 
        style="display: none;"
    >

    <!-- St√≠lusos gomb -->
    <button 
        type="button" 
        class="upload-btn" 
        onclick="document.getElementById('photos_1_2').click()"
    >
        <i class="fas fa-upload"></i> F√°jlok felt√∂lt√©se
    </button>

    <div id="preview_1_2" class="image-preview-container"></div>
</div>

                <textarea class="notes-textarea" name="notes_1_2" placeholder="Megjegyz√©s..."></textarea>
            </div>

            <!-- 1.3 Sz√ºks√©ges enged√©lyek -->
            <div class="checklist-item">
                <div class="checklist-header">1.3 Sz√ºks√©ges enged√©lyek</div>
                <div class="checklist-description">T≈±zgy√∫jt√°si, besz√°ll√°si, fesz√ºlts√©g ment., emel√©si terv, nincs lefolytatva az elj√°r√°s, a benne foglalaltak nem teljes√ºlnek stb.</div>
                
                <div class="radio-options">
                    <div class="radio-option success">
                        <input type="radio" id="item_1_3_m" name="item_1_3" value="megfelel≈ë" onchange="toggleSeverity('1_3')">
                        <label for="item_1_3_m">Megfelelt</label>
                    </div>
                    <div class="radio-option danger">
                        <input type="radio" id="item_1_3_nm" name="item_1_3" value="nem_megfelel≈ë" onchange="toggleSeverity('1_3')">
                        <label for="item_1_3_nm">Nem megfelelt</label>
                    </div>
                    <div class="radio-option info">
                        <input type="radio" id="item_1_3_ft" name="item_1_3" value="felsz√≥l√≠t√°s_ut√°n" onchange="toggleSeverity('1_3')">
                        <label for="item_1_3_ft">Felsz√≥l√≠t√°s ut√°n teljes√≠tve</label>
                    </div>
                    <div class="radio-option warning">
                        <input type="radio" id="item_1_3_nv" name="item_1_3" value="nem_vizsg√°lt" onchange="toggleSeverity('1_3')">
                        <label for="item_1_3_nv">Nem vonatkozik / Nem vizsg√°lt</label>
                    </div>
                </div>

                <div id="severity_1_3" class="severity-selector" style="display: none; margin-top: 15px; padding: 15px; background-color: #f7fafc; border-radius: 8px;">
                    <label style="font-weight: 600; display: block; margin-bottom: 10px;">Hiba s√∫lyoss√°ga:</label>
                    <div class="radio-options">
                        <div class="radio-option" style="border-color: #FFFF00;">
                            <input type="radio" id="item_1_3_sev_low" name="item_1_3_severity" value="alacsony">
                            <label for="item_1_3_sev_low" style="color: #000000;">üü°Alacsony</label>
                        </div>
                        <div class="radio-option" style="border-color: #ED7D31;">
                            <input type="radio" id="item_1_3_sev_medium" name="item_1_3_severity" value="k√∂zepes">
                            <label for="item_1_3_sev_medium" style="color: #000000;">üü†K√∂zepes</label>
                        </div>
                        <div class="radio-option" style="border-color: #FF0000;">
                            <input type="radio" id="item_1_3_sev_high" name="item_1_3_severity" value="magas">
                            <label for="item_1_3_sev_high" style="color: #000000;">üî¥Magas</label>
                        </div>
                    </div>
                </div>
<div class="form-group" style="margin-top: 15px;">
    <label><i class="fas fa-camera"></i> F√©nyk√©pek / dokument√°ci√≥</label>

    <!-- Rejtett file input -->
    <input 
        type="file" 
        id="photos_1_3" 
        multiple 
        onchange="handleImageUpload(event, '1_3')" 
        style="display: none;"
    >

    <!-- St√≠lusos gomb -->
    <button 
        type="button" 
        class="upload-btn" 
        onclick="document.getElementById('photos_1_3').click()"
    >
        <i class="fas fa-upload"></i> F√°jlok felt√∂lt√©se
    </button>

    <div id="preview_1_3" class="image-preview-container"></div>
</div>

                <textarea class="notes-textarea" name="notes_1_3" placeholder="Megjegyz√©s..."></textarea>
            </div>

            <!-- 1.4 Sz√ºks√©ges tervdokument√°ci√≥k -->
            <div class="checklist-item">
                <div class="checklist-header">1.4 Sz√ºks√©ges tervdokument√°ci√≥k, jegyz≈ëk√∂nyvek</div>
                <div class="checklist-description">BET; EBK terv; organiz√°ci√≥s terv stb.</div>

                <div class="radio-options">
                    <div class="radio-option success">
                        <input type="radio" id="item_1_4_m" name="item_1_4" value="megfelel≈ë" onchange="toggleSeverity('1_4')">
                        <label for="item_1_4_m">Megfelelt</label>
                    </div>
                    <div class="radio-option danger">
                        <input type="radio" id="item_1_4_nm" name="item_1_4" value="nem_megfelel≈ë" onchange="toggleSeverity('1_4')">
                        <label for="item_1_4_nm">Nem megfelelt</label>
                    </div>
                    <div class="radio-option info">
                        <input type="radio" id="item_1_4_ft" name="item_1_4" value="felsz√≥l√≠t√°s_ut√°n" onchange="toggleSeverity('1_4')">
                        <label for="item_1_4_ft">Felsz√≥l√≠t√°s ut√°n teljes√≠tve </label>
                    </div>
                    <div class="radio-option warning">
                        <input type="radio" id="item_1_4_nv" name="item_1_4" value="nem_vizsg√°lt" onchange="toggleSeverity('1_4')">
                        <label for="item_1_4_nv">Nem vonatkozik / Nem vizsg√°lt</label>
                    </div>
                </div>

                <div id="severity_1_4" class="severity-selector" style="display: none; margin-top: 15px; padding: 15px; background-color: #f7fafc; border-radius: 8px;">
                    <label style="font-weight: 600; display: block; margin-bottom: 10px;">Hiba s√∫lyoss√°ga:</label>
                    <div class="radio-options">
                        <div class="radio-option" style="border-color: #FFFF00;">
                            <input type="radio" id="item_1_4_sev_low" name="item_1_4_severity" value="alacsony">
                            <label for="item_1_4_sev_low" style="color: #000000;">üü°Alacsony</label>
                        </div>
                        <div class="radio-option" style="border-color: #ED7D31;">
                            <input type="radio" id="item_1_4_sev_medium" name="item_1_4_severity" value="k√∂zepes">
                            <label for="item_1_4_sev_medium" style="color: #000000;">üü†K√∂zepes</label>
                        </div>
                        <div class="radio-option" style="border-color: #FF0000;">
                            <input type="radio" id="item_1_4_sev_high" name="item_1_4_severity" value="magas">
                            <label for="item_1_4_sev_high" style="color: #000000;">üî¥Magas</label>
                        </div>
                    </div>
                </div>

               <div class="form-group" style="margin-top: 15px;">
    <label><i class="fas fa-camera"></i> F√©nyk√©pek / dokument√°ci√≥</label>

    <!-- Rejtett file input -->
    <input 
        type="file" 
        id="photos_1_4" 
        multiple 
        onchange="handleImageUpload(event, '1_4')" 
        style="display: none;"
    >

    <!-- St√≠lusos gomb -->
    <button 
        type="button" 
        class="upload-btn" 
        onclick="document.getElementById('photos_1_4').click()"
    >
        <i class="fas fa-upload"></i> F√°jlok felt√∂lt√©se
    </button>

    <div id="preview_1_4" class="image-preview-container"></div>
</div>

                <textarea class="notes-textarea" name="notes_1_4" placeholder="Megjegyz√©s..."></textarea>
            </div>

            <!-- Szankci√≥s lista -->
            <div class="price-section">
                <h3>Szankci√≥s lista - Dokument√°ci√≥ kateg√≥ria vonatkoz√≥ pontjai</h3>
                
                <div class="price-item">
                    <input type="checkbox" id="price_1" name="sanction_1" value="100000" onchange="calculateTotal()">
                    <label for="price_1">1 MVM XPert munka-, t≈±z-, vagy k√∂rnyezetv√©delmi szab√°lyainak megs√©rt√©se</label>
                    <input type="number" name="sanction_1_count" min="1" value="1" style="width: 60px; margin: 0 10px;" onchange="calculateTotal()" placeholder="db">
                    <span style="margin-right: 10px; font-weight: 600;">√ó</span>
                    <span class="price">100,000 Ft</span>
                </div>

                <div class="price-item">
                    <input type="checkbox" id="price_2" name="sanction_2" value="50000" onchange="calculateTotal()">
                    <label for="price_2">6 Munkabiztons√°got jelent≈ësen befoly√°sol√≥ eszk√∂z√∂k, jelz√©sek, biztons√°gi berendez√©sek mell≈ëz√©se, kiiktat√°sa</label>
                    <input type="number" name="sanction_2_count" min="1" value="1" style="width: 60px; margin: 0 10px;" onchange="calculateTotal()" placeholder="db">
                    <span style="margin-right: 10px; font-weight: 600;">√ó</span>
                    <span class="price">50,000 Ft</span>
                </div>

                <div class="price-item">
                    <input type="checkbox" id="price_3" name="sanction_3" value="50000" onchange="calculateTotal()">
                    <label for="price_3">9 Vesz√©lyes munkaeszk√∂z √ºzembehelyez√©s√©nek √©s id≈ëszakos biztons√°gi fel√ºlvizsg√°lat elv√©gz√©s√©nek hi√°nya</label>
                    <input type="number" name="sanction_3_count" min="1" value="1" style="width: 60px; margin: 0 10px;" onchange="calculateTotal()" placeholder="db">
                    <span style="margin-right: 10px; font-weight: 600;">√ó</span>
                    <span class="price">50,000 Ft</span>
                </div>

                <div class="price-item">
                    <input type="checkbox" id="price_4" name="sanction_4" value="30000" onchange="calculateTotal()">
                    <label for="price_4">10 A munkav√©gz√©shez haszn√°lt id≈ëszakos fel√ºlvizsg√°latra k√∂telezett g√©pek, berendez√©sek, munkaeszk√∂z√∂k nem azonos√≠that√≥k</label>
                    <input type="number" name="sanction_4_count" min="1" value="1" style="width: 60px; margin: 0 10px;" onchange="calculateTotal()" placeholder="db">
                    <span style="margin-right: 10px; font-weight: 600;">√ó</span>
                    <span class="price">30,000 Ft</span>
                </div>

                <div class="price-item">
                    <input type="checkbox" id="price_5" name="sanction_5" value="50000" onchange="calculateTotal()">
                    <label for="price_5">15 Egy√©b jogosulatlan munkav√©gz√©s (pl: g√©pkezel≈ëi jogosults√°gok)</label>
                    <input type="number" name="sanction_5_count" min="1" value="1" style="width: 60px; margin: 0 10px;" onchange="calculateTotal()" placeholder="db">
                    <span style="margin-right: 10px; font-weight: 600;">√ó</span>
                    <span class="price">50,000 Ft</span>
                </div>

                <div class="price-item">
                    <input type="checkbox" id="price_6" name="sanction_6" value="100000" onchange="calculateTotal()">
                    <label for="price_6">16 Id≈ëszakos biztons√°gi √©s egy√©b jogszab√°lyban meghat√°rozott fel√ºlvizsg√°latok hi√°nya</label>
                    <input type="number" name="sanction_6_count" min="1" value="1" style="width: 60px; margin: 0 10px;" onchange="calculateTotal()" placeholder="db">
                    <span style="margin-right: 10px; font-weight: 600;">√ó</span>
                    <span class="price">100,000 Ft</span>
                </div>

                <div class="price-item">
                    <input type="checkbox" id="price_7" name="sanction_7" value="100000" onchange="calculateTotal()">
                    <label for="price_7">26 √çr√°sos enged√©lyhez k√∂t√∂tt tev√©kenys√©g v√©gz√©se enged√©ly n√©lk√ºl</label>
                    <input type="number" name="sanction_7_count" min="1" value="1" style="width: 60px; margin: 0 10px;" onchange="calculateTotal()" placeholder="db">
                    <span style="margin-right: 10px; font-weight: 600;">√ó</span>
                    <span class="price">100,000 Ft</span>
                </div>

                <div class="price-item">
                    <input type="checkbox" id="price_8" name="sanction_8" value="100000" onchange="calculateTotal()">
                    <label for="price_8">27 Emel√©si terv k√∂teles tev√©kenys√©g enged√©ly n√©lk√ºli v√©gz√©se</label>
                    <input type="number" name="sanction_8_count" min="1" value="1" style="width: 60px; margin: 0 10px;" onchange="calculateTotal()" placeholder="db">
                    <span style="margin-right: 10px; font-weight: 600;">√ó</span>
                    <span class="price">100,000 Ft</span>
                </div>

                <div class="price-item">
                    <input type="checkbox" id="price_9" name="sanction_9" value="100000" onchange="calculateTotal()">
                    <label for="price_9">39 Megrendel≈ë fel√© jelentend≈ë EBK esem√©ny jelent√©s√©nek elmulaszt√°sa</label>
                    <input type="number" name="sanction_9_count" min="1" value="1" style="width: 60px; margin: 0 10px;" onchange="calculateTotal()" placeholder="db">
                    <span style="margin-right: 10px; font-weight: 600;">√ó</span>
                    <span class="price">100,000 Ft</span>
                </div>

                <div class="total-price">
                    <span>Kiszabhat√≥ √∂sszes√≠tett b√≠rs√°g:</span>
                    <span id="totalPrice">0 Ft</span>
                </div>
            </div>

            <!-- Submit gombok -->
            <div class="submit-section">
                <button type="button" class="submit-button" onclick="exportToPDF()">
                    <i class="fas fa-file-pdf"></i> PDF export√°l√°sa
                </button>
                <button type="submit" class="preview-button">
                    <i class="fas fa-save"></i> Ellen≈ërz√©s ment√©se
                </button>
            </div>

        </form>

    </div>

    <!-- ‚≠ê Progress bar overlay -->
    <div id="uploadProgressOverlay" class="upload-progress-overlay">
        <div class="upload-progress-container">
            <div class="upload-progress-title">üì§ Felt√∂lt√©s folyamatban...</div>
            <div class="upload-progress-bar-container">
                <div id="uploadProgressBar" class="upload-progress-bar"></div>
                <div id="uploadProgressText" class="upload-progress-text">0%</div>
            </div>
            <div id="uploadProgressStatus" class="upload-progress-status">
                Felt√∂lt√©s ind√≠t√°sa...
            </div>
        </div>
    </div>

    <!-- Al√°√≠r√°s Modal -->
    <div id="signatureModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-signature"></i> Al√°√≠r√°s hozz√°ad√°sa</h2>
                <button class="close-modal" onclick="closeSignatureModal()">&times;</button>
            </div>
            <canvas id="signatureCanvas" width="540" height="300"></canvas>
            <div class="canvas-controls">
                <button class="btn-clear" onclick="clearCanvas()">
                    <i class="fas fa-trash"></i> T√∂rl√©s
                </button>
                <button class="btn-save" onclick="saveSignature()">
                    <i class="fas fa-save"></i></i> Ment√©s
                </button>
            </div>
        </div>
    </div>

    <script>
        // Projekt serial prefix EJS v√°ltoz√≥b√≥l
        const projectSerialPrefix = '<%= project.serial_prefix || "" %>';

        // Sorsz√°m automatikus friss√≠t√©se
        function updateSerialNumber() {
            const dateInput = document.getElementById('inspectionDate');
            const serialInput = document.getElementById('serialNumber');

            // Ha van serial prefix √©s d√°tum ki van v√°lasztva
            if (projectSerialPrefix && dateInput.value) {
                // K√∂zvetlen√ºl a string √©rt√©kb≈ël dolgozunk, hogy elker√ºlj√ºk az UTC konverzi√≥t
                const dateStr = dateInput.value.replace(/-/g, ''); // YYYY-MM-DD -> YYYYMMDD

                // Sorsz√°m gener√°l√°sa
                serialInput.value = `${projectSerialPrefix}${dateStr}`;
            }
        }

        // Glob√°lis v√°ltoz√≥k
        let canvas, ctx;
        let isDrawing = false;
        let currentSignatureType = '';
        const signatures = {
            inspector: null,
            responsible: null,
            subcontractor: null
        };

        // ‚≠ê Progress bar kezel√©s
        function showUploadProgress() {
            const overlay = document.getElementById('uploadProgressOverlay');
            overlay.style.display = 'flex';
        }

        function hideUploadProgress() {
            const overlay = document.getElementById('uploadProgressOverlay');
            overlay.style.display = 'none';
        }

        function updateUploadProgress(percent, status) {
            const bar = document.getElementById('uploadProgressBar');
            const text = document.getElementById('uploadProgressText');
            const statusDiv = document.getElementById('uploadProgressStatus');

            bar.style.width = percent + '%';
            text.textContent = Math.round(percent) + '%';
            if (status) {
                statusDiv.textContent = status;
            }

            console.log(`üìä Progress: ${Math.round(percent)}% - ${status}`);
        }

        // ‚≠ê M√ìDOS√çTOTT: K√©pek t√°rol√°sa metaadatokkal
        const uploadedImages = {
            '1_1': [],
            '1_2': [],
            '1_3': [],
            '1_4': []
        };

        // Tan√∫k sz√°ml√°l√≥
        let witnessCounter = 0;
        let witnessesVisible = false;

        // Inicializ√°l√°s
        document.addEventListener('DOMContentLoaded', async function() {
    canvas = document.getElementById('signatureCanvas');
    ctx = canvas.getContext('2d');
    
    // Canvas be√°ll√≠t√°sok
    ctx.strokeStyle = '#000';
    ctx.lineWidth = 2;
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';

    // Eg√©r esem√©nyek
    canvas.addEventListener('mousedown', startDrawing);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('mouseup', stopDrawing);
    canvas.addEventListener('mouseout', stopDrawing);

    // √ârint√©s esem√©nyek (mobilra)
    canvas.addEventListener('touchstart', handleTouchStart, { passive: false });
    canvas.addEventListener('touchmove', handleTouchMove, { passive: false });
    canvas.addEventListener('touchend', handleTouchEnd, { passive: false });

    // Aktu√°lis d√°tum be√°ll√≠t√°sa alap√©rtelmezettnek
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('inspectionDate').value = today;

    // Sorsz√°m automatikus gener√°l√°sa, ha van serial prefix
    updateSerialNumber();

    // Mentett adatok bet√∂lt√©se 
    try {
        const response = await fetch('/projects/<%= project.id %>/reports/documentation');
        const result = await response.json();
        
        if (result.success && result.data) {
            console.log('Mentett adatok bet√∂ltve:', result.data);
            loadSavedData(result.data);
        } else {
            console.log('Nincs mentett adat ehhez a projekthez/kateg√≥ri√°hoz');
        }
    } catch (error) {
        console.error('Hiba a mentett adatok bet√∂lt√©sekor:', error);
    }
});

        // Tan√∫k megjelen√≠t√©se (2 tan√∫ automatikusan)
        function showWitnesses() {
            if (witnessesVisible) return;

            witnessesVisible = true;
            document.getElementById('witnessToggleButton').style.display = 'none';
            document.getElementById('witnessSection').style.display = 'block';

            // 2 tan√∫ automatikus l√©trehoz√°sa
            createWitness(0);
            createWitness(1);
        }

        // Tan√∫ l√©trehoz√°sa
        function createWitness(index) {
            const container = document.getElementById('witnessesContainer');

            const witnessGroup = document.createElement('div');
            witnessGroup.className = 'witness-group';
            witnessGroup.setAttribute('data-witness-index', index);
            witnessGroup.style.cssText = 'margin-bottom: 25px; padding: 25px; background-color: #fff; border: 2px solid #e2e8f0; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);';

            witnessGroup.innerHTML = `
                <label style="font-weight: 700; font-size: 16px; color: #2d3748; margin-bottom: 15px; display: block; border-bottom: 2px solid #e2e8f0; padding-bottom: 8px;">Tan√∫ ${index + 1}</label>

                <div class="two-column" style="margin-bottom: 15px;">
                    <input type="text" name="witness_name_${index}" placeholder="N√©v" style="padding: 12px; font-size: 15px;">
                    <input type="text" name="witness_position_${index}" placeholder="Beoszt√°s" style="padding: 12px; font-size: 15px;">
                </div>

                <div class="two-column" style="margin-bottom: 15px;">
                    <input type="text" name="witness_id_number_${index}" placeholder="Szem√©lyigazolv√°ny sz√°m" style="padding: 12px; font-size: 15px;">
                    <input type="text" name="witness_address_${index}" placeholder="Lakc√≠m" style="padding: 12px; font-size: 15px;">
                </div>

                <div class="signature-container">
                    <div class="signature-preview" id="witnessPreview_${index}" onclick="openSignatureModal('witness_${index}')">
                        <span><i class="fas fa-pen"></i> Kattintson ide az al√°√≠r√°s hozz√°ad√°s√°hoz</span>
                    </div>
                    <div class="signature-buttons">
                        <button type="button" class="add-button" onclick="openSignatureModal('witness_${index}')">
                            <i class="fas fa-signature"></i> Al√°√≠r√°s hozz√°ad√°sa
                        </button>
                        <button type="button" class="clear-signature" onclick="clearSignature('witness_${index}')" style="display: none;" id="witness_${index}Clear">
                            <i class="fas fa-trash"></i> T√∂rl√©s
                        </button>
                    </div>
                </div>
                <input type="hidden" name="witness_signature_${index}" id="witness_${index}Signature">
            `;

            container.appendChild(witnessGroup);

            // Al√°√≠r√°s inicializ√°l√°sa
            signatures[`witness_${index}`] = null;
            witnessCounter = Math.max(witnessCounter, index + 1);
        }

        // "Nem √°ll rendelkez√©sre Tan√∫" checkbox kezel√©se
        function toggleNoWitness() {
            const checkbox = document.getElementById('noWitnessAvailable');
            const container = document.getElementById('witnessesContainer');

            if (checkbox.checked) {
                // Letiltjuk a tan√∫ mez≈ëket
                container.style.opacity = '0.5';
                container.style.pointerEvents = 'none';
            } else {
                // Enged√©lyezz√ºk a tan√∫ mez≈ëket
                container.style.opacity = '1';
                container.style.pointerEvents = 'auto';
            }
        }

        // Hiba s√∫lyoss√°g megjelen√≠t√©se/elrejt√©se
        function toggleSeverity(itemId) {
            const severityDiv = document.getElementById(`severity_${itemId}`);
            const selectedValue = document.querySelector(`input[name="item_${itemId}"]:checked`)?.value;

            if (severityDiv) {
                // Megjelen√≠tj√ºk, ha "nem_megfelel≈ë" vagy "felsz√≥l√≠t√°s_ut√°n" van kiv√°lasztva
                if (selectedValue === 'nem_megfelel≈ë' || selectedValue === 'felsz√≥l√≠t√°s_ut√°n') {
                    severityDiv.style.display = 'block';
                } else {
                    severityDiv.style.display = 'none';
                    // T√∂r√∂lj√ºk a severity kiv√°laszt√°st ha elrejtj√ºk
                    const severityRadios = severityDiv.querySelectorAll('input[type="radio"]');
                    severityRadios.forEach(radio => radio.checked = false);
                }
            }
        }

        // Alv√°llalkoz√≥k kezel√©se
        let subcontractorCounter = 0;

        function addSubcontractor() {
            const container = document.getElementById('subcontractorsList');
            const index = subcontractorCounter++;

            const subcontractorDiv = document.createElement('div');
            subcontractorDiv.className = 'subcontractor-item';
            subcontractorDiv.setAttribute('data-subcontractor-index', index);
            subcontractorDiv.style.cssText = 'display: flex; align-items: center; margin-bottom: 8px;';

            subcontractorDiv.innerHTML = `
                <span style="font-weight: 600; color: #2c5282; margin-right: 10px;">${index + 2}.</span>
                <input type="text" name="subcontractor_${index}" placeholder="Alv√°llalkoz√≥ c√©g neve"
                       style="flex: 1; padding: 8px 12px; border: 1px solid #cbd5e0; border-radius: 6px; margin-right: 8px;">
                <button type="button" onclick="removeSubcontractor(${index})"
                        style="background-color: #e53e3e; color: white; border: none; border-radius: 4px; padding: 8px 12px; cursor: pointer; display: flex; align-items: center; gap: 4px;">
                    <i class="fas fa-trash"></i>
                </button>
            `;

            container.appendChild(subcontractorDiv);
        }

        function removeSubcontractor(index) {
            const item = document.querySelector(`.subcontractor-item[data-subcontractor-index="${index}"]`);
            if (item) {
                item.remove();
                updateSubcontractorNumbers();
            }
        }

        function updateSubcontractorNumbers() {
            const items = document.querySelectorAll('.subcontractor-item');
            items.forEach((item, idx) => {
                const numberSpan = item.querySelector('span');
                if (numberSpan) {
                    numberSpan.textContent = `${idx + 2}.`;
                }
            });
        }

        function getSubcontractorChain() {
            const chain = ['MVM Xpert Zrt.'];
            const items = document.querySelectorAll('.subcontractor-item');
            items.forEach(item => {
                const input = item.querySelector('input');
                if (input && input.value.trim()) {
                    chain.push(input.value.trim());
                }
            });
            return chain;
        }

        function generatePdfFileName() {
            const serialNumber = document.getElementById('serialNumber').value || 'Sorszam_nelkul';
            const chain = getSubcontractorChain();
            const lastCompany = chain[chain.length - 1] || 'Ismeretlen';

            // F√°jln√©v friendly form√°tum - √©kezetes karakterek megengedettek
            // Csak a tiltott f√°jln√©v karaktereket t√°vol√≠tjuk el: / \ : * ? " < > |
            const cleanSerial = serialNumber.replace(/[\/\\:*?"<>|]/g, '-');
            const cleanCompany = lastCompany.replace(/[\/\\:*?"<>|]/g, '-');

            return `${cleanSerial} - ${cleanCompany}.pdf`;
        }

        // Al√°√≠r√°s modal megnyit√°sa
        function openSignatureModal(type) {
            currentSignatureType = type;
            document.getElementById('signatureModal').style.display = 'block';
            clearCanvas();
        }

        // Modal bez√°r√°sa
        function closeSignatureModal() {
            document.getElementById('signatureModal').style.display = 'none';
            currentSignatureType = '';
        }

        // Rajzol√°s kezd√©se
function startDrawing(e) {
    isDrawing = true;
    const rect = canvas.getBoundingClientRect();
    const scaleX = canvas.width / rect.width;
    const scaleY = canvas.height / rect.height;
    
    ctx.beginPath();
    ctx.moveTo(
        (e.clientX - rect.left) * scaleX,
        (e.clientY - rect.top) * scaleY
    );
}

        // Rajzol√°s
function draw(e) {
    if (!isDrawing) return;
    
    const rect = canvas.getBoundingClientRect();
    const scaleX = canvas.width / rect.width;
    const scaleY = canvas.height / rect.height;
    
    ctx.lineTo(
        (e.clientX - rect.left) * scaleX,
        (e.clientY - rect.top) * scaleY
    );
    ctx.stroke();
}

        // Rajzol√°s befejez√©se
        function stopDrawing() {
    if (isDrawing) {
        ctx.closePath();
    }
    isDrawing = false;
}

        // ‚≠ê M√ìDOS√çTOTT: K√©pfelt√∂lt√©s kezel√©se EXIF metaadatokkal
        function handleImageUpload(event, itemId) {
            const files = event.target.files;
            const previewContainer = document.getElementById(`preview_${itemId}`);

            if (!files || files.length === 0) return;

            console.log(`üì∏ ${files.length} k√©p felt√∂lt√©se indult (${itemId})`);

            // ‚≠ê √öJ: Minden k√©pform√°tum kezel√©se HEIC automatikus konverzi√≥val
            console.log(`üì∏ ${files.length} k√©p feldolgoz√°sa indult...`);

            Array.from(files).forEach(file => {
                const fileName = file.name.toLowerCase();
                const fileType = file.type.toLowerCase();

                console.log(`üîç F√°jl: ${file.name} (${fileType}, ${(file.size / 1024).toFixed(2)} KB)`);

                // HEIC detekt√°l√°s
                const isHEIC = fileName.endsWith('.heic') ||
                              fileName.endsWith('.heif') ||
                              fileType.includes('heic') ||
                              fileType.includes('heif');

                if (isHEIC) {
                    console.log(`üîÑ HEIC k√©p konvert√°l√°sa: ${file.name}`);
                    // ‚≠ê HEIC konvert√°l√°s Canvas-szal
                    convertHEICtoJPEG(file, itemId);
                } else if (fileType.startsWith('image/') || fileName.match(/\.(jpg|jpeg|png|webp|gif)$/i)) {
                    // Norm√°l k√©pfeldolgoz√°s
                    processNormalImage(file, itemId);
                } else {
                    console.warn(`‚ö†Ô∏è Ismeretlen form√°tum, megpr√≥b√°lom konvert√°lni: ${file.name}`);
                    // Pr√≥b√°ljuk meg Canvas-szal konvert√°lni
                    convertHEICtoJPEG(file, itemId);
                }
            });

            // Input reset
            event.target.value = '';
        }

        // ‚≠ê JAV√çTOTT: HEIC ‚Üí JPEG konverzi√≥ EXIF metaadatok meg≈ërz√©s√©vel
        async function convertHEICtoJPEG(file, itemId) {
            try {
                console.log(`üîÑ HEIC konverzi√≥ ind√≠t√°sa: ${file.name} (${(file.size / 1024).toFixed(2)} KB)`);

                // ‚≠ê KRITIKUS: EXIF metaadatok kinyer√©se az EREDETI HEIC f√°jlb√≥l exifr library-vel
                let originalExifData = {
                    date: null,
                    lat: null,
                    lon: null,
                    latRef: null,
                    lonRef: null,
                    make: null,
                    model: null
                };

                try {
                    // ‚≠ê NYERS TAG DUMP - l√°ssuk a teljes strukt√∫r√°t
                    const rawTags = await exifr.parse(file, {
                        gps: true,
                        translateKeys: false,
                        translateValues: false,
                        reviveValues: false,
                        sanitize: false,
                        mergeOutput: false
                    });
                    console.log('üî¨ NYERS EXIF STRUKT√öRA:', rawTags);
                    if (rawTags?.gps) {
                        console.log('üî¨ GPS TAG-ek (nyers sz√°mok):', rawTags.gps);
                    }

                    // ‚≠ê KRITIKUS: exifr.gps() - direktben GPS koordin√°t√°kat ad vissza!
                    const rawGPS = await exifr.gps(file);
                    console.log('üìç exifr.gps() DIREKT GPS:', rawGPS);

                    // ‚≠ê exifr library haszn√°lata - HEIC t√°mogat√°ssal, MERGED output!
                    const exifrData = await exifr.parse(file, {
                        gps: true,
                        exif: true,
                        ifd0: true,
                        tiff: true,
                        mergeOutput: true
                    });

                    console.log('üìã HEIC EXIF (exifr merged):', exifrData);

                    // ‚≠ê GPS debug - minden lehets√©ges mez≈ë
                    console.log('üîç GPS mez≈ëk:', {
                        'latitude': exifrData?.latitude,
                        'longitude': exifrData?.longitude,
                        'GPSLatitude': exifrData?.GPSLatitude,
                        'GPSLongitude': exifrData?.GPSLongitude,
                        'GPSLatitudeRef': exifrData?.GPSLatitudeRef,
                        'GPSLongitudeRef': exifrData?.GPSLongitudeRef
                    });

                    // ‚≠ê D√°tum debug
                    console.log('üìÖ D√°tum mez≈ëk:', {
                        'DateTimeOriginal': exifrData?.DateTimeOriginal,
                        'DateTime': exifrData?.DateTime,
                        'CreateDate': exifrData?.CreateDate
                    });

                    if (exifrData) {
                        // ‚≠ê D√ÅTUM kinyer√©se (KRITIKUS!)
                        const photoDate = exifrData.DateTimeOriginal ||
                                         exifrData.DateTime ||
                                         exifrData.CreateDate ||
                                         file.lastModified;

                        // ‚≠ê ELS≈ê: rawGPS objektum (exifr.gps() direkt met√≥dus)
                        if (rawGPS && typeof rawGPS.latitude === 'number' && !isNaN(rawGPS.latitude)) {
                            originalExifData = {
                                date: photoDate,
                                lat: rawGPS.latitude,
                                lon: rawGPS.longitude,
                                latRef: null,
                                lonRef: null,
                                make: exifrData.Make,
                                model: exifrData.Model,
                                isDecimal: true
                            };
                            console.log('‚úÖ GPS (exifr.gps() direkt):', rawGPS.latitude, rawGPS.longitude);
                            console.log('‚úÖ F√©nyk√©p d√°tuma:', photoDate);
                        }
                        // ‚≠ê M√ÅSODIK: decim√°lis GPS az exifrData-b√≥l
                        else if (typeof exifrData.latitude === 'number' && !isNaN(exifrData.latitude)) {
                            originalExifData = {
                                date: photoDate,
                                lat: exifrData.latitude,
                                lon: exifrData.longitude,
                                latRef: null,
                                lonRef: null,
                                make: exifrData.Make,
                                model: exifrData.Model,
                                isDecimal: true
                            };
                            console.log('‚úÖ Decim√°lis GPS (exifr.parse):', exifrData.latitude, exifrData.longitude);
                            console.log('‚úÖ F√©nyk√©p d√°tuma:', photoDate);
                        }
                        // ‚≠ê HARMADIK: GPS t√∂mbk√©nt (DMS format)
                        else if (exifrData.GPSLatitude && exifrData.GPSLongitude) {
                            originalExifData = {
                                date: photoDate,
                                lat: exifrData.GPSLatitude,
                                lon: exifrData.GPSLongitude,
                                latRef: exifrData.GPSLatitudeRef,
                                lonRef: exifrData.GPSLongitudeRef,
                                make: exifrData.Make,
                                model: exifrData.Model
                            };
                            console.log('‚úÖ DMS GPS (exifr):', exifrData.GPSLatitude, exifrData.GPSLongitude);
                            console.log('‚úÖ F√©nyk√©p d√°tuma:', photoDate);
                        }
                        // ‚≠ê Nincs GPS
                        else {
                            originalExifData = {
                                date: photoDate,
                                lat: null,
                                lon: null,
                                latRef: null,
                                lonRef: null,
                                make: exifrData.Make,
                                model: exifrData.Model
                            };
                            console.warn('‚ö†Ô∏è Nincs GPS adat sehol (rawGPS, latitude, GPSLatitude)');
                            console.log('‚úÖ F√©nyk√©p d√°tuma:', photoDate);
                        }
                    }
                } catch (exifrError) {
                    console.warn('‚ö†Ô∏è exifr hiba:', exifrError.message, exifrError);
                    // Fallback az eredeti EXIF.js-re
                }

                // ‚≠ê heic2any library haszn√°lata
                const convertedBlob = await heic2any({
                    blob: file,
                    toType: 'image/jpeg',
                    quality: 0.7 // 70% min≈ës√©g
                });

                // Ha t√∂bb blob j√∂n vissza (pl. burst photo), csak az els≈ët haszn√°ljuk
                const finalBlob = Array.isArray(convertedBlob) ? convertedBlob[0] : convertedBlob;

                console.log(`‚úÖ HEIC konvert√°lva: ${file.name} ‚Üí JPEG (${(finalBlob.size / 1024).toFixed(2)} KB)`);

                // Blob ‚Üí File object
                const convertedFile = new File(
                    [finalBlob],
                    file.name.replace(/\.heic$/i, '.jpg').replace(/\.heif$/i, '.jpg'),
                    {
                        type: 'image/jpeg',
                        lastModified: file.lastModified
                    }
                );

                // ‚≠ê KRITIKUS: Feldolgoz√°s az eredeti EXIF adatokkal
                processNormalImage(convertedFile, itemId, originalExifData);

            } catch (error) {
                console.error('‚ùå HEIC konverzi√≥ hiba:', error);
                console.warn('üîÑ Fallback: Pr√≥b√°lkoz√°s Canvas API-val...');

                // Fallback: Canvas API pr√≥b√°lkoz√°s
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');

                        let width = img.width;
                        let height = img.height;
                        const maxWidth = 1600;

                        if (width > maxWidth) {
                            height = (height * maxWidth) / width;
                            width = maxWidth;
                        }

                        canvas.width = width;
                        canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);

                        canvas.toBlob(function(blob) {
                            if (blob) {
                                console.log(`‚úÖ Fallback konverzi√≥ sikeres: ${file.name}`);
                                const convertedFile = new File([blob], file.name.replace(/\.heic$/i, '.jpg'), {
                                    type: 'image/jpeg',
                                    lastModified: file.lastModified
                                });
                                processNormalImage(convertedFile, itemId);
                            } else {
                                console.error('‚ùå Fallback konverzi√≥ is sikertelen');
                                alert(`‚ö†Ô∏è Ez a k√©p nem t√°mogatott form√°tumban van.\n\nK√©rlek pr√≥b√°ld meg:\n1. JPEG/PNG form√°tumban √∫jra menteni\n2. M√°sik k√©pet felt√∂lteni\n3. M√°s eszk√∂zr≈ël felt√∂lteni`);
                            }
                        }, 'image/jpeg', 0.7);
                    };

                    img.onerror = function() {
                        console.error('‚ùå Fallback is sikertelen - k√©p nem bet√∂lthet≈ë');
                        alert(`‚ö†Ô∏è "${file.name}" nem t√∂lthet≈ë be.\n\nEz a HEIC f√°jl nem kompatibilis a b√∂ng√©sz≈ëvel.\n\nMegold√°s:\n‚Ä¢ √Åll√≠tsd √°t a telefon be√°ll√≠t√°sait JPEG form√°tumra\n‚Ä¢ Vagy haszn√°lj k√©p konvert√°l√≥ alkalmaz√°st`);
                    };

                    img.src = e.target.result;
                };

                reader.onerror = function() {
                    console.error('‚ùå F√°jl olvas√°si hiba');
                    alert(`‚ö†Ô∏è Nem siker√ºlt beolvasni a f√°jlt: ${file.name}`);
                };

                reader.readAsDataURL(file);
            }
        }

        // ‚≠ê JAV√çTOTT: Norm√°l k√©pfeldolgoz√°s + opcion√°lis el≈ëre kinyert EXIF
        function processNormalImage(file, itemId, preExtractedExif = null) {
            const previewContainer = document.getElementById(`preview_${itemId}`);

            // ‚≠ê KRITIKUS FIX: Kinyerj√ºk az EXIF-et AZONNAL a file objektumb√≥l
            // MIEL≈êTT b√°rmilyen Image/Canvas feldolgoz√°s t√∂rt√©nne
            console.log('üîç EXIF kinyer√©se AZONNAL a f√°jlb√≥l (mobil fix)...');

            (async () => {
                let extractedExif = preExtractedExif;

                if (!extractedExif) {
                    try {
                        // ‚≠ê EXIF kinyer√©s K√ñZVETLEN√úL a file objektumb√≥l
                        const gpsData = await exifr.gps(file);
                        const exifrData = await exifr.parse(file, {
                            gps: true,
                            exif: true,
                            ifd0: true,
                            tiff: true,
                            mergeOutput: true
                        });

                        console.log('üìã Korai EXIF beolvas√°s (file objektumb√≥l):', {
                            gps: gpsData,
                            date: exifrData?.DateTimeOriginal || exifrData?.DateTime,
                            make: exifrData?.Make,
                            model: exifrData?.Model
                        });

                        // EXIF objektum el≈ëk√©sz√≠t√©se
                        extractedExif = {
                            date: exifrData?.DateTimeOriginal || exifrData?.DateTime || file.lastModified,
                            lat: gpsData?.latitude,
                            lon: gpsData?.longitude,
                            make: exifrData?.Make,
                            model: exifrData?.Model,
                            isDecimal: true
                        };

                        console.log('‚úÖ Korai EXIF kinyerve:', extractedExif);
                    } catch (err) {
                        console.warn('‚ö†Ô∏è Korai EXIF kinyer√©s sikertelen:', err.message);
                    }
                }

                // Most folytatjuk a k√©pfeldolgoz√°st
                processImageWithExif(file, itemId, extractedExif, previewContainer);
            })();
        }

        // ‚≠ê √öJ: K√©pfeldolgoz√°s m√°r kinyert EXIF-fel
        function processImageWithExif(file, itemId, extractedExif, previewContainer) {
            const reader = new FileReader();

            reader.onload = function(e) {
                // ‚≠ê EREDETI k√©p base64 (T√ñM√ñR√çT√âS N√âLK√úL - Google Drive-hoz)
                const originalImageData = e.target.result;
                console.log(`üì¶ Eredeti k√©p m√©ret: ${(file.size / 1024).toFixed(2)} KB (t√∂m√∂r√≠t√©s n√©lk√ºl)`);

                const img = new Image();
                img.onload = function() {
                    // ‚≠ê K√©pt√∂m√∂r√≠t√©s Canvas-szal (CSAK PDF-hez √©s preview-hoz)
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');

                    // Max 1600px sz√©less√©g
                    let width = img.width;
                    let height = img.height;
                    const maxWidth = 1600;

                    if (width > maxWidth) {
                        height = (height * maxWidth) / width;
                        width = maxWidth;
                    }

                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);

                    // ‚≠ê JPEG konverzi√≥ 70% min≈ës√©ggel (PDF √©s preview)
                    canvas.toBlob(function(blob) {
                        if (blob) {
                            const compressedSizeKB = (blob.size / 1024).toFixed(2);
                            console.log(`üìä T√∂m√∂r√≠tett preview: ${compressedSizeKB} KB (PDF-hez)`);

                            // Blob ‚Üí base64 (t√∂m√∂r√≠tett verzi√≥)
                            const blobReader = new FileReader();
                            blobReader.onload = function(blobEvent) {
                                const compressedImageData = blobEvent.target.result;

                                // ‚≠ê KRITIKUS: Haszn√°ljuk a KORAI EXIF-et (file objektumb√≥l kinyerve)
                                if (extractedExif) {
                                    console.log('‚úÖ Haszn√°lom a korai EXIF adatokat (file objektumb√≥l)');
                                    processExifData(extractedExif, file, originalImageData, compressedImageData, previewContainer, itemId);
                                } else {
                                    // ‚≠ê FALLBACK: Ha valahogy nem siker√ºlt kor√°bban
                                    console.log('‚ö†Ô∏è Fallback EXIF kinyer√©s...');

                                    (async () => {
                                        try {
                                            // ‚≠ê KRITIKUS FIX: Konvert√°ljuk a File-t ArrayBuffer-r√©
                                            // N√©h√°ny telefonos EXIF form√°tumn√°l az exifr library jobban m≈±k√∂dik buffer-rel
                                            const arrayBuffer = await file.arrayBuffer();

                                            // ‚≠ê MOBIL FIX: Pr√≥b√°ljuk piexifjs-t EL≈êSZ√ñR (mobil kompatibilit√°s)
                                            let piexifGPS = null;
                                            try {
                                                // Base64 a piexifjs sz√°m√°ra
                                                const base64String = originalImageData.split(',')[1];
                                                const exifObj = piexif.load(base64String);

                                                console.log('üîç PIEXIF EXIF objektum:', exifObj);

                                                if (exifObj && exifObj.GPS) {
                                                    console.log('üìç PIEXIF GPS tag-ek:', exifObj.GPS);

                                                    // GPS koordin√°t√°k kinyer√©se
                                                    const gpsIfd = exifObj.GPS;

                                                    if (gpsIfd[piexif.GPSIFD.GPSLatitude] && gpsIfd[piexif.GPSIFD.GPSLongitude]) {
                                                        const latDMS = gpsIfd[piexif.GPSIFD.GPSLatitude];
                                                        const lonDMS = gpsIfd[piexif.GPSIFD.GPSLongitude];
                                                        const latRef = gpsIfd[piexif.GPSIFD.GPSLatitudeRef];
                                                        const lonRef = gpsIfd[piexif.GPSIFD.GPSLongitudeRef];

                                                        console.log('üìç PIEXIF GPS DMS:', {
                                                            latDMS, lonDMS, latRef, lonRef
                                                        });

                                                        // DMS ‚Üí Decim√°lis konverzi√≥
                                                        function piexifDMSToDecimal(dms, ref) {
                                                            if (!dms || dms.length !== 3) return null;

                                                            const deg = dms[0][0] / dms[0][1];
                                                            const min = dms[1][0] / dms[1][1];
                                                            const sec = dms[2][0] / dms[2][1];

                                                            let decimal = deg + (min / 60) + (sec / 3600);

                                                            if (ref === 'S' || ref === 'W') {
                                                                decimal = -decimal;
                                                            }

                                                            return decimal;
                                                        }

                                                        const lat = piexifDMSToDecimal(latDMS, latRef);
                                                        const lon = piexifDMSToDecimal(lonDMS, lonRef);

                                                        if (lat !== null && lon !== null && !isNaN(lat) && !isNaN(lon)) {
                                                            piexifGPS = { latitude: lat, longitude: lon };
                                                            console.log('‚úÖ PIEXIF GPS sikeres:', piexifGPS);
                                                        }
                                                    }
                                                }
                                            } catch (piexifError) {
                                                console.warn('‚ö†Ô∏è piexifjs hiba:', piexifError.message);
                                            }

                                            // ‚≠ê exifr.gps() ArrayBuffer-rel (fallback)
                                            const gpsData = piexifGPS || await exifr.gps(arrayBuffer);
                                            console.log('üìç GPS (final):', gpsData);

                                            // ‚≠ê R√âSZLETES GPS DEBUG
                                            if (gpsData) {
                                                console.log('üîç GPS R√âSZLETEK:', {
                                                    'latitude': gpsData.latitude,
                                                    'longitude': gpsData.longitude,
                                                    'latitude t√≠pus': typeof gpsData.latitude,
                                                    'longitude t√≠pus': typeof gpsData.longitude,
                                                    'isNaN(lat)': isNaN(gpsData.latitude),
                                                    'isNaN(lon)': isNaN(gpsData.longitude),
                                                    '√∂sszes kulcs': Object.keys(gpsData)
                                                });
                                            }

                                            // ‚≠ê Teljes EXIF - ArrayBuffer-rel
                                            const exifrData = await exifr.parse(arrayBuffer, {
                                                gps: true,
                                                exif: true,
                                                ifd0: true,
                                                tiff: true,
                                                mergeOutput: true,
                                                sanitize: false,
                                                reviveValues: true,
                                                translateKeys: false,
                                                translateValues: false
                                            });

                                            console.log('üìã EXIF (exifr) ArrayBuffer-rel:', exifrData);

                                            // ‚≠ê EXIF GPS R√âSZLETEK
                                            console.log('üîç EXIF GPS MEZ≈êK:', {
                                                'latitude': exifrData?.latitude,
                                                'longitude': exifrData?.longitude,
                                                'GPSLatitude': exifrData?.GPSLatitude,
                                                'GPSLongitude': exifrData?.GPSLongitude,
                                                'GPSLatitudeRef': exifrData?.GPSLatitudeRef,
                                                'GPSLongitudeRef': exifrData?.GPSLongitudeRef
                                            });

                                            // ‚≠ê RAW GPS TAG-ek (tag sz√°mok szerint)
                                            console.log('üîç RAW GPS TAG-ek (numerikus kulcsok):', {
                                                'Tag 1 (GPSLatitudeRef)': exifrData?.[1],
                                                'Tag 2 (GPSLatitude)': exifrData?.[2],
                                                'Tag 3 (GPSLongitudeRef)': exifrData?.[3],
                                                'Tag 4 (GPSLongitude)': exifrData?.[4],
                                                'Tag 34853 (GPS IFD)': exifrData?.[34853]
                                            });

                                            const exifData = {
                                                date: exifrData?.DateTimeOriginal || exifrData?.DateTime || file.lastModified,
                                                lat: null,
                                                lon: null,
                                                make: exifrData?.Make,
                                                model: exifrData?.Model,
                                                isDecimal: false
                                            };

                                            // ‚≠ê GPS - pr√≥b√°ljuk exifr.gps() els≈ëk√©nt
                                            if (gpsData && typeof gpsData.latitude === 'number' && !isNaN(gpsData.latitude)) {
                                                exifData.lat = gpsData.latitude;
                                                exifData.lon = gpsData.longitude;
                                                exifData.isDecimal = true;
                                                console.log('‚úÖ GPS decim√°lis (exifr.gps):', gpsData.latitude, gpsData.longitude);
                                            } else if (exifrData?.latitude && !isNaN(exifrData.latitude)) {
                                                exifData.lat = exifrData.latitude;
                                                exifData.lon = exifrData.longitude;
                                                exifData.isDecimal = true;
                                                console.log('‚úÖ GPS decim√°lis (exifr.parse):', exifrData.latitude, exifrData.longitude);
                                            }
                                            // ‚≠ê KRITIKUS FIX: Ha NaN, pr√≥b√°ljuk meg manu√°lisan konvert√°lni a RAW GPS tag-ekb≈ël!
                                            else if (Array.isArray(exifrData?.[2]) && Array.isArray(exifrData?.[4])) {
                                                console.log('üîß Manu√°lis GPS konverzi√≥ (RAW tag-ekb≈ël)...');

                                                // DMS (Degrees, Minutes, Seconds) ‚Üí Decim√°lis konverzi√≥
                                                function dmsArrayToDecimal(dmsArray, ref) {
                                                    if (!Array.isArray(dmsArray) || dmsArray.length !== 3) return null;

                                                    const degrees = parseFloat(dmsArray[0]) || 0;
                                                    const minutes = parseFloat(dmsArray[1]) || 0;
                                                    const seconds = parseFloat(dmsArray[2]) || 0;

                                                    let decimal = degrees + (minutes / 60) + (seconds / 3600);

                                                    // Ha van reference (N/S/E/W) √©s az S vagy W, akkor negat√≠v
                                                    if (ref && (ref === 'S' || ref === 'W')) {
                                                        decimal = -decimal;
                                                    }

                                                    return decimal;
                                                }

                                                const latArray = exifrData[2];
                                                const lonArray = exifrData[4];
                                                const latRef = exifrData[1] || 'N';
                                                const lonRef = exifrData[3] || 'E';

                                                console.log('üìç RAW GPS adatok:', {
                                                    'latArray': latArray,
                                                    'lonArray': lonArray,
                                                    'latRef': latRef,
                                                    'lonRef': lonRef
                                                });

                                                // ‚≠ê R√âSZLETES T√ñMB TARTALOM
                                                console.log('üîç T√ñMB ELEMEK:', {
                                                    'latArray[0]': latArray[0],
                                                    'latArray[1]': latArray[1],
                                                    'latArray[2]': latArray[2],
                                                    'lonArray[0]': lonArray[0],
                                                    'lonArray[1]': lonArray[1],
                                                    'lonArray[2]': lonArray[2],
                                                    'parseFloat(latArray[0])': parseFloat(latArray[0]),
                                                    'isNaN(latArray[0])': isNaN(latArray[0])
                                                });

                                                const lat = dmsArrayToDecimal(latArray, latRef);
                                                const lon = dmsArrayToDecimal(lonArray, lonRef);

                                                if (lat !== null && lon !== null && !isNaN(lat) && !isNaN(lon)) {
                                                    exifData.lat = lat;
                                                    exifData.lon = lon;
                                                    exifData.isDecimal = true;
                                                    console.log('‚úÖ GPS manu√°lis konverzi√≥ sikeres:', lat, lon);
                                                } else {
                                                    console.warn('‚ö†Ô∏è Manu√°lis GPS konverzi√≥ sikertelen');
                                                }
                                            } else {
                                                console.warn('‚ö†Ô∏è Nincs GPS adat (exifr)');
                                            }

                                            processExifData(exifData, file, originalImageData, compressedImageData, previewContainer, itemId);

                                        } catch (exifrError) {
                                            console.error('‚ùå exifr hiba:', exifrError);
                                            // Fallback: GPS n√©lk√ºli feldolgoz√°s
                                            processExifData({
                                                date: file.lastModified,
                                                lat: null,
                                                lon: null,
                                                make: null,
                                                model: null
                                            }, file, originalImageData, compressedImageData, previewContainer, itemId);
                                        }
                                    })();
                                }
                            };

                            blobReader.readAsDataURL(blob);
                        } else {
                            console.error('‚ùå K√©p t√∂m√∂r√≠t√©s sikertelen:', file.name);
                        }
                    }, 'image/jpeg', 0.7);
                };

                img.onerror = function() {
                    console.error('‚ùå K√©p bet√∂lt√©si hiba:', file.name);
                };

                img.src = e.target.result;
            };

            reader.onerror = function() {
                console.error('‚ùå F√°jl olvas√°si hiba:', file.name);
            };

            reader.readAsDataURL(file);
        }

        // ‚≠ê EXIF adatok feldolgoz√°sa √©s preview l√©trehoz√°sa
        // originalImageData: t√∂m√∂r√≠tetlen (Google Drive-hoz)
        // compressedImageData: t√∂m√∂r√≠tett (preview √©s PDF-hez)
        function processExifData(exifData, file, originalImageData, compressedImageData, previewContainer, itemId) {
            // GPS konvert√°l√°s
            let location = null;
            let locationText = 'Nincs GPS adat';
            let hasGPS = false;

            console.log('üîç GPS Raw adatok:', {
                lat: exifData.lat,
                lon: exifData.lon,
                isDecimal: exifData.isDecimal
            });

            if (exifData.lat !== null && exifData.lon !== null) {
                let lat, lon;

                // ‚≠ê Ha m√°r decim√°lis (exifr adta vissza)
                if (exifData.isDecimal && typeof exifData.lat === 'number' && !isNaN(exifData.lat)) {
                    lat = exifData.lat;
                    lon = exifData.lon;
                    console.log('‚úÖ GPS m√°r decim√°lis form√°tumban:', lat, lon);
                } else {
                    // ‚≠ê DMS konverzi√≥
                    lat = convertDMSToDD(exifData.lat, exifData.latRef);
                    lon = convertDMSToDD(exifData.lon, exifData.lonRef);
                    console.log('üìê Konvert√°lt koordin√°t√°k (DMS‚ÜíDD):', { lat, lon });
                }

                if (lat !== null && lon !== null && !isNaN(lat) && !isNaN(lon)) {
                    location = { lat, lon };
                    locationText = `${lat.toFixed(6)}, ${lon.toFixed(6)}`;
                    hasGPS = true;
                    console.log('‚úÖ GPS koordin√°t√°k:', locationText);
                } else {
                    console.warn('‚ö†Ô∏è GPS konvert√°l√°s sikertelen');
                }
            } else {
                console.warn('‚ö†Ô∏è Nincs GPS adat a k√©pben');
            }

            // D√°tum feldolgoz√°s
            const dateText = exifData.date ? formatDate(exifData.date) : 'Nincs d√°tum adat';
            const hasDate = !!exifData.date;

            if (hasDate) {
                console.log('‚úÖ Felv√©tel d√°tuma:', dateText);
            } else {
                console.warn('‚ö†Ô∏è Nincs d√°tum adat a k√©pben');
            }

            // Kamera info
            const cameraInfo = (exifData.make || exifData.model)
                ? `${exifData.make || ''} ${exifData.model || ''}`.trim()
                : null;

            // ‚≠ê K√©p t√°rol√°sa metaadatokkal - K√âT VERZI√ì!
            uploadedImages[itemId].push({
                data: compressedImageData,  // ‚≠ê T√∂m√∂r√≠tett verzi√≥ PDF-hez
                originalData: originalImageData,  // ‚≠ê EREDETI verzi√≥ Google Drive-hoz (T√ñM√ñR√çTETLEN)
                metadata: {
                    takenDate: exifData.date || new Date().toISOString(),
                    location: locationText,
                    latitude: location?.lat,
                    longitude: location?.lon,
                    fileName: file.name,
                    camera: cameraInfo,
                    hasGPS: hasGPS,
                    hasDate: hasDate
                }
            });

            console.log('‚úÖ K√©p t√°rolva:', {
                'T√∂m√∂r√≠tett (PDF)': `${(compressedImageData.length / 1024).toFixed(2)} KB`,
                'Eredeti (Drive)': `${(originalImageData.length / 1024).toFixed(2)} KB`
            });

            // ‚≠ê Preview elem l√©trehoz√°sa (t√∂m√∂r√≠tett verzi√≥val)
            const previewItem = document.createElement('div');
            previewItem.className = 'image-preview-item';

            const img = document.createElement('img');
            img.src = compressedImageData;  // ‚≠ê Preview is t√∂m√∂r√≠tett
            img.alt = file.name;
            // ‚≠ê JAV√çTOTT - Mobilos k√©pmegjelen√≠t√©s
            img.style.width = '100%';
            img.style.height = '200px';
            img.style.objectFit = 'cover';
            img.style.display = 'block';
            img.onload = function() {
                console.log('‚úÖ K√©p bet√∂ltve:', file.name);
            };
            img.onerror = function() {
                console.error('‚ùå K√©p bet√∂lt√©si hiba:', file.name);
            };

            // ‚≠ê Metaadatok megjelen√≠t√©se
            const metaInfo = document.createElement('div');
            metaInfo.className = 'image-meta-info';
                            
                            let metaHTML = '';
                            
                            // D√°tum
                            if (hasDate) {
                                metaHTML += `
                                    <div class="meta-item">
                                        <i class="fas fa-calendar"></i> 
                                        <span title="${dateText}">${dateText}</span>
                                    </div>
                                `;
                            }

                            // GPS - JAV√çTOTT mobilra
                            if (hasGPS && location) {
                                console.log('üìç GPS megjelen√≠t√©s:', locationText, location);
                                metaHTML += `
                                    <div class="meta-item">
                                        <i class="fas fa-map-marker-alt"></i>
                                        <span>
                                            <a href="https://www.google.com/maps?q=${location.lat},${location.lon}"
                                               target="_blank"
                                               rel="noopener noreferrer"
                                               class="map-link"
                                               style="color: #4CAF50; text-decoration: none; font-weight: bold;"
                                               title="Megnyit√°s Google Maps-ben">
                                               ${locationText}
                                            </a>
                                        </span>
                                    </div>
                                `;
                            } else {
                                console.warn('‚ö†Ô∏è Nincs GPS adat a k√©phez');
                                metaHTML += `
                                    <div class="meta-item">
                                        <i class="fas fa-map-marker-alt"></i>
                                        <span style="color: #ffc107;">Nincs GPS adat</span>
                                    </div>
                                `;
                            }

                            // Kamera info (opcion√°lis)
                            if (cameraInfo) {
                                metaHTML += `
                                    <div class="meta-item">
                                        <i class="fas fa-camera"></i> 
                                        <span title="${cameraInfo}">${cameraInfo}</span>
                                    </div>
                                `;
                            }

                            // Figyelmeztet√©s ha nincs metaadat
                            if (!hasDate || !hasGPS) {
                                metaHTML += `
                                    <div class="no-metadata-warning">
                                        <i class="fas fa-exclamation-triangle"></i> 
                                        <span>Hi√°nyos metaadatok</span>
                                    </div>
                                `;
                            }

                            metaInfo.innerHTML = metaHTML;
                            
                            // T√∂rl√©s gomb
                            const removeBtn = document.createElement('button');
                            removeBtn.className = 'image-remove-btn';
                            removeBtn.innerHTML = '&times;';
                            removeBtn.title = 'K√©p elt√°vol√≠t√°sa';
                            removeBtn.onclick = function(e) {
                                e.stopPropagation();
                                // ‚≠ê FIX: compressedImageData haszn√°lata
                                const index = uploadedImages[itemId].findIndex(img => img.data === compressedImageData);
                                if (index > -1) {
                                    uploadedImages[itemId].splice(index, 1);
                                    console.log('üóëÔ∏è K√©p elt√°vol√≠tva:', file.name);
                                }
                                previewItem.remove();
                            };
                            
            // √ñsszerak√°s
            previewItem.appendChild(img);
            previewItem.appendChild(metaInfo);
            previewItem.appendChild(removeBtn);
            previewContainer.appendChild(previewItem);

            console.log('‚úÖ K√©p hozz√°adva metaadatokkal:', {
                fileName: file.name,
                hasDate: hasDate,
                hasGPS: hasGPS,
                location: locationText
            });
        }

        // ‚≠ê GPS DMS ‚Üí DD konvert√°l√°s
        function convertDMSToDD(dms, ref) {
            // ‚≠ê Ha m√°r decim√°lis sz√°m (exifr adta vissza k√∂zvetlen√ºl)
            if (typeof dms === 'number' && !isNaN(dms)) {
                console.log('‚úÖ M√°r decim√°lis koordin√°ta:', dms);
                return dms;
            }

            // ‚≠ê Ha NaN vagy null vagy undefined
            if (!dms || (typeof dms === 'number' && isNaN(dms))) {
                console.warn('‚ö†Ô∏è √ârv√©nytelen GPS adat (NaN/null/undefined):', dms);
                return null;
            }

            // ‚≠ê Ha nem t√∂mb vagy rossz m√©ret
            if (!Array.isArray(dms) || dms.length !== 3) {
                console.warn('‚ö†Ô∏è √ârv√©nytelen GPS form√°tum (nem 3 elem≈± t√∂mb):', dms);
                return null;
            }

            try {
                const degrees = dms[0];
                const minutes = dms[1];
                const seconds = dms[2];

                // ‚≠ê Ellen≈ërizz√ºk hogy a sz√°mok √©rv√©nyesek-e
                if (isNaN(degrees) || isNaN(minutes) || isNaN(seconds)) {
                    console.warn('‚ö†Ô∏è GPS t√∂mb tartalmaz NaN √©rt√©keket:', { degrees, minutes, seconds });
                    return null;
                }

                // ‚≠ê Ha exifr decim√°lis koordin√°t√°t adott [decimal, 0, 0] form√°ban
                if (minutes === 0 && seconds === 0 && Math.abs(degrees) > 0) {
                    console.log('‚úÖ Decim√°lis GPS [x,0,0] form√°tumban:', degrees);
                    return degrees; // M√°r decim√°lis, nem kell konvert√°lni
                }

                // ‚≠ê Norm√°l DMS konverzi√≥
                let dd = degrees + minutes/60 + seconds/3600;

                // ‚≠ê Ref lehet undefined is (akkor pozit√≠v marad)
                if (ref === "S" || ref === "W") {
                    dd = dd * -1;
                }

                console.log('‚úÖ DMS‚ÜíDD konverzi√≥:', { dms, ref, result: dd });
                return dd;
            } catch (e) {
                console.error('‚ùå GPS konvert√°l√°si hiba:', e);
                return null;
            }
        }

        // ‚≠ê D√°tum form√°z√°s
        function formatDate(dateString) {
            if (!dateString) return 'Nincs adat';
            
            try {
                // EXIF form√°tum: "2025:12:06 14:54:00"
                let cleaned = dateString;
                
                if (typeof dateString === 'string') {
                    cleaned = dateString
                        .replace(/^(\d{4}):(\d{2}):(\d{2})/, '$1-$2-$3')
                        .replace(' ', 'T');
                }
                
                const date = new Date(cleaned);
                
                if (isNaN(date.getTime())) {
                    console.warn('‚ö†Ô∏è √ârv√©nytelen d√°tum form√°tum:', dateString);
                    return dateString;
                }
                
                return date.toLocaleDateString('hu-HU', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (e) {
                console.error('‚ùå D√°tum form√°z√°si hiba:', e);
                return dateString;
            }
        }

        // Touch esem√©nyek kezel√©se
function handleTouchStart(e) {
    e.preventDefault();
    const touch = e.touches[0];
    const rect = canvas.getBoundingClientRect();
    const scaleX = canvas.width / rect.width;
    const scaleY = canvas.height / rect.height;
    
    isDrawing = true;
    ctx.beginPath();
    ctx.moveTo(
        (touch.clientX - rect.left) * scaleX,
        (touch.clientY - rect.top) * scaleY
    );
}

        function handleTouchMove(e) {
    e.preventDefault();
    if (!isDrawing) return;
    
    const touch = e.touches[0];
    const rect = canvas.getBoundingClientRect();
    const scaleX = canvas.width / rect.width;
    const scaleY = canvas.height / rect.height;
    
    ctx.lineTo(
        (touch.clientX - rect.left) * scaleX,
        (touch.clientY - rect.top) * scaleY
    );
    ctx.stroke();
}

// Touch befejez√©se
function handleTouchEnd(e) {
    e.preventDefault();
    if (isDrawing) {
        ctx.closePath();
    }
    isDrawing = false;
}

        // Canvas t√∂rl√©se
        function clearCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        // Al√°√≠r√°s ment√©se
       function saveSignature() {
    const dataURL = canvas.toDataURL('image/png');
    signatures[currentSignatureType] = dataURL;
    
    let hiddenInputId = currentSignatureType + 'Signature';
    if (currentSignatureType.startsWith('witness_')) {
        hiddenInputId = currentSignatureType + 'Signature';
    }
    
    const hiddenInput = document.getElementById(hiddenInputId);
    if (hiddenInput) {
        hiddenInput.value = dataURL;
        console.log('Hidden input friss√≠tve:', hiddenInputId);
    } else {
        console.error('Hidden input nem tal√°lhat√≥:', hiddenInputId);
    }
    
    let previewId = currentSignatureType + 'Preview';
    if (currentSignatureType.startsWith('witness_')) {
        previewId = 'witnessPreview_' + currentSignatureType.split('_')[1];
    }
    
    const preview = document.getElementById(previewId);
    if (preview) {
        preview.innerHTML = `<img src="${dataURL}" alt="Al√°√≠r√°s">`;
        console.log('Preview friss√≠tve:', previewId);
    } else {
        console.error('Preview nem tal√°lhat√≥:', previewId);
    }
    
    let clearBtnId = currentSignatureType + 'Clear';
    if (currentSignatureType.startsWith('witness_')) {
        clearBtnId = currentSignatureType + 'Clear';
    }
    
    const clearBtn = document.getElementById(clearBtnId);
    if (clearBtn) {
        clearBtn.style.display = 'block';
        console.log('Clear button megjelen√≠tve:', clearBtnId);
    } else {
        console.error('Clear button nem tal√°lhat√≥:', clearBtnId);
    }
    
    closeSignatureModal();
}

        // Al√°√≠r√°s t√∂rl√©se
     function clearSignature(type) {
    signatures[type] = null;
    
    let hiddenInputId = type + 'Signature';
    const hiddenInput = document.getElementById(hiddenInputId);
    if (hiddenInput) {
        hiddenInput.value = '';
    }
    
    let previewId = type + 'Preview';
    if (type.startsWith('witness_')) {
        previewId = 'witnessPreview_' + type.split('_')[1];
    }
    
    const preview = document.getElementById(previewId);
    if (preview) {
        preview.innerHTML = '<span><i class="fas fa-pen"></i> Kattintson ide az al√°√≠r√°s hozz√°ad√°s√°hoz</span>';
    }
    
    let clearBtnId = type + 'Clear';
    const clearBtn = document.getElementById(clearBtnId);
    if (clearBtn) {
        clearBtn.style.display = 'none';
    }
}

        // √År kalkul√°ci√≥
        const priceCheckboxes = document.querySelectorAll('.price-item input[type="checkbox"]');
        const totalPriceElement = document.getElementById('totalPrice');

        function calculateTotal() {
            let total = 0;
            priceCheckboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    const basePrice = parseInt(checkbox.value);
                    const sanctionName = checkbox.name; // pl: "sanction_1"
                    const countInput = document.querySelector(`input[name="${sanctionName}_count"]`);
                    const count = countInput ? parseInt(countInput.value) || 1 : 1;
                    total += basePrice * count;
                }
            });
            totalPriceElement.textContent = total.toLocaleString('hu-HU') + ' Ft';
            return total;
        }

        priceCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', calculateTotal);
        });

        // Form submit
document.getElementById('documentationForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const data = {};
    
    for (let [key, value] of formData.entries()) {
        data[key] = value;
    }

    // B√≠rs√°g √∂sszeg hozz√°ad√°sa
    data.total_fine = calculateTotal();
    data.total_fine_formatted = totalPriceElement.textContent;

    // Alv√°llalkoz√≥i l√°nc hozz√°ad√°sa
    data.subcontractors = getSubcontractorChain();

    // Tan√∫k √°llapot ment√©se
    data.witnessesVisible = witnessesVisible;
    data.noWitnessAvailable = document.getElementById('noWitnessAvailable')?.checked || false;

    // ‚≠ê K√©pek hozz√°ad√°sa metaadatokkal
    data.images = uploadedImages;
    
    // Projekt specifikus mez≈ëk hozz√°ad√°sa
    data.projectName = document.getElementById('projectName').value;
    data.serialNumber = document.getElementById('serialNumber').value;
    data.inspectorPerson = document.getElementById('inspectorPerson').value;
    data.inspectionDate = document.getElementById('inspectionDate').value;

    console.log('üì§ Ment√©s adatokkal:', data);

    fetch(this.action, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            alert('‚úì Ellen≈ërz√©s sikeresen elmentve!');
        } else {
            alert('‚úó Hiba t√∂rt√©nt: ' + result.message);
        }
    })
    .catch(error => {
        console.error('Hiba:', error);
        alert('‚úó Hiba t√∂rt√©nt a ment√©s sor√°n.');
    });
});

// √öj ellen≈ërz√©s ind√≠t√°sa
async function startNewInspection() {
    const confirmNew = confirm('‚ö†Ô∏è Biztosan √∫j ellen≈ërz√©st szeretn√©l ind√≠tani?\n\nEz t√∂rli a jelenlegi mentett adatokat √©s √ºres lappal kezdhetsz.');
    
    if (!confirmNew) {
        return;
    }

    try {
        const response = await fetch('/projects/<%= project.id %>/reports/documentation', {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        });

        const result = await response.json();

        if (result.success) {
            alert('‚úÖ √öj ellen≈ërz√©s ind√≠tva! Az oldal √∫jrat√∂lt≈ëdik.');
            window.location.reload();
        } else {
            alert('‚ùå Hiba t√∂rt√©nt: ' + result.message);
        }
    } catch (error) {
        console.error('Hiba az √∫j ellen≈ërz√©s ind√≠t√°sakor:', error);
        alert('‚ùå Hiba t√∂rt√©nt az √∫j ellen≈ërz√©s ind√≠t√°sakor.');
    }
}

       // PDF Export√°l√°s
        async function exportToPDF() {
            const projectName = document.getElementById('projectName').value || '<%= project.name %>';
            const serialNumber = document.getElementById('serialNumber').value || 'N/A';
            const inspectorPerson = document.getElementById('inspectorPerson').value || '<%= user.name %>';
            const inspectionDateValue = document.getElementById('inspectionDate').value;
            const formattedDate = inspectionDateValue ? new Date(inspectionDateValue).toLocaleDateString('hu-HU', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            }) : 'N/A';

            // Form adatok √∂sszegy≈±jt√©se
            const formData = new FormData(document.getElementById('documentationForm'));
            const data = {};
            for (let [key, value] of formData.entries()) {
                data[key] = value;
            }

            // Alv√°llalkoz√≥i l√°nc hozz√°ad√°sa
            data.subcontractors = getSubcontractorChain();

            // Log√≥k bet√∂lt√©se base64-k√©nt
            async function imageToBase64(url) {
                try {
                    const response = await fetch(url);
                    const blob = await response.blob();
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onloadend = () => resolve(reader.result);
                        reader.onerror = reject;
                        reader.readAsDataURL(blob);
                    });
                } catch (error) {
                    console.warn(`‚ö†Ô∏è Nem siker√ºlt bet√∂lteni a log√≥t: ${url}`, error);
                    return null;
                }
            }

            const mvmLogoBase64 = await imageToBase64('/images/MVM.png');
            const iwsLogoBase64 = await imageToBase64('/images/IWS-Solutions.jpg');

            // PDF dokumentum defin√≠ci√≥
const docDefinition = {
    pageSize: 'A4',
    pageMargins: [40, 40, 40, 40],
    content: [
        // Log√≥k
        {
            columns: [
                {
                    image: 'mvmLogo',
                    width: 80,
                    alignment: 'left'
                },
                {
                    width: '*',
                    text: ''
                },
                {
                    image: 'iwsLogo',
                    width: 80,
                    alignment: 'right'
                }
            ],
            margin: [0, 0, 0, 10]
        },
        // Fejl√©c
        {
            text: 'MUNKAV√âDELMI ELLEN≈êRZ√âSI JEGYZ≈êK√ñNYV',
            style: 'mainHeader',
            alignment: 'center',
            margin: [0, 0, 0, 5]
        },
        {
            text: '1. DOKUMENT√ÅCI√ì',
            style: 'categoryHeader',
            alignment: 'center',
            margin: [0, 0, 0, 10]
        },

        // Projekt inform√°ci√≥k
        {
            style: 'infoTable',
            table: {
                widths: [130, '*'],
                body: [
                    [
                        { text: 'Projekt neve:', style: 'labelCell' },
                        { text: projectName, style: 'valueCell' }
                    ],
                    [
                        { text: 'Sorsz√°m:', style: 'labelCell' },
                        { text: serialNumber, style: 'valueCell' }
                    ],
                    [
                        { text: 'Ellen≈ërz≈ë szem√©ly:', style: 'labelCell' },
                        { text: inspectorPerson, style: 'valueCell' }
                    ],
                    [
                        { text: 'D√°tum:', style: 'labelCell' },
                        { text: formattedDate, style: 'valueCell' }
                    ]
                ]
            },
            layout: {
                fillColor: function (rowIndex) {
                    return (rowIndex % 2 === 0) ? '#f9f9f9' : null;
                },
                hLineWidth: function () { return 0.5; },
                vLineWidth: function () { return 0; },
                hLineColor: function () { return '#e0e0e0'; }
            },
            margin: [0, 0, 0, 15],
            unbreakable: true
        },

        // R√©sztvev≈ëk szekci√≥
        {
            text: 'ELLEN≈êRZ√âS R√âSZTVEV≈êI',
            style: 'sectionHeader',
            margin: [0, 0, 0, 8]
        },

        // Ellen≈ërz√©st v√©gz≈ë
        {
            columns: [
                {
                    width: '*',
                    stack: [
                        { text: 'Ellen≈ërz√©st v√©gz≈ë', style: 'participantLabel' },
                        { text: data.inspector_name || 'N/A', style: 'participantName' },
                        { text: data.inspector_position || '', style: 'participantPosition' }
                    ]
                },
                {
                    width: 150,
                    stack: [
                        signatures.inspector ? {
                            image: signatures.inspector,
                            width: 120,
                            alignment: 'center',
                            margin: [0, 5, 0, 0]
                        } : {
                            text: '[Al√°√≠r√°s hi√°nyzik]',
                            italics: true,
                            color: '#999',
                            fontSize: 9,
                            alignment: 'center',
                            margin: [0, 20, 0, 0]
                        }
                    ]
                }
            ],
            margin: [0, 0, 0, 10],
            unbreakable: true
        },

        // Munkater√ºlet√©rt felel≈ës
        {
            columns: [
                {
                    width: '*',
                    stack: [
                        { text: 'Munkater√ºlet√©rt felel≈ës', style: 'participantLabel' },
                        { text: data.responsible_name || 'N/A', style: 'participantName' },
                        { text: data.responsible_position || '', style: 'participantPosition' }
                    ]
                },
                {
                    width: 150,
                    stack: [
                        signatures.responsible ? {
                            image: signatures.responsible,
                            width: 120,
                            alignment: 'center',
                            margin: [0, 5, 0, 0]
                        } : {
                            text: '[Al√°√≠r√°s hi√°nyzik]',
                            italics: true,
                            color: '#999',
                            fontSize: 9,
                            alignment: 'center',
                            margin: [0, 20, 0, 0]
                        }
                    ]
                }
            ],
            margin: [0, 0, 0, 10],
            unbreakable: true
        },

        // Tan√∫k
        ...getWitnessesForPDF(data),

        // Alv√°llalkoz√≥i l√°nc
        {
            stack: [
                { text: 'Alv√°llalkoz√≥i l√°nc', style: 'participantLabel', margin: [0, 0, 0, 8] },
                {
                    ol: getSubcontractorChain().map(company => ({
                        text: company,
                        style: 'participantName',
                        margin: [0, 2, 0, 2]
                    })),
                    margin: [0, 0, 0, 0]
                }
            ],
            margin: [0, 0, 0, 15],
            unbreakable: true
        },

        // Ellen≈ërz√©si pontok
        {
            text: 'ELLEN≈êRZ√âSI PONTOK',
            style: 'sectionHeader',
            margin: [0, 10, 0, 10],
            pageBreak: 'before'
        },

        // 1.1
      {
    table: {
        widths: ['*'],
        body: [[
            {
                stack: [
                    { text: '1.1 Munkater√ºlet√©rt felel≈ës beazonos√≠t√°sa', style: 'checklistTitle' },
                    { text: '√Åtad√°s √°tv√©tel jegyz≈ëk√∂nyv fellelhet≈ës√©ge, munkaenged√©ly, stb.', style: 'checklistDesc' },
                    { text: `√ârt√©kel√©s: ${getStatusText(data.item_1_1)}`, style: getStatusStyle(data.item_1_1), margin: [0, 5, 0, 0] },
                    getSeverityBadge('1_1', data) || {},
                    data.notes_1_1 ? { text: `Megjegyz√©s: ${data.notes_1_1}`, style: 'notes' } : {}
                ],
                border: [true, true, true, true],
                fillColor: '#fafafa'
            }
        ]]
    },
    layout: {
        hLineColor: '#333',
        vLineColor: '#333',
        hLineWidth: function() { return 1; },
        vLineWidth: function() { return 1; }
    },
    margin: [0, 0, 0, 8],
    unbreakable: true
},
        ...getImagesForPDF('1_1'),

        // 1.2
        {
            table: {
                widths: ['*'],
                body: [[
                    {
                        stack: [
                            { text: '1.2 Egy√©b dokument√°ci√≥k', style: 'checklistTitle' },
                            { text: '√âp√≠t√©si napl√≥, hullad√©k nyilv√°ntart√≥lap stb.', style: 'checklistDesc' },
                            { text: `√ârt√©kel√©s: ${getStatusText(data.item_1_2)}`, style: getStatusStyle(data.item_1_2), margin: [0, 5, 0, 0] },
                            getSeverityBadge('1_2', data) || {},
                            data.notes_1_2 ? { text: `Megjegyz√©s: ${data.notes_1_2}`, style: 'notes' } : {}
                        ],
                        border: [true, true, true, true],
                        fillColor: '#fafafa'
                    }
                ]]
            },
            layout: {
                hLineColor: '#333',
        vLineColor: '#333',
                hLineWidth: function() { return 1; },
                vLineWidth: function() { return 1; }
            },
            margin: [0, 0, 0, 8],
            unbreakable: true
        },
        ...getImagesForPDF('1_2'),

        // 1.3
        {
            table: {
                widths: ['*'],
                body: [[
                    {
                        stack: [
                            { text: '1.3 Sz√ºks√©ges enged√©lyek', style: 'checklistTitle' },
                            { text: 'T≈±zgy√∫jt√°si, besz√°ll√°si, fesz√ºlts√©g ment., emel√©si terv stb.', style: 'checklistDesc' },
                            { text: `√ârt√©kel√©s: ${getStatusText(data.item_1_3)}`, style: getStatusStyle(data.item_1_3), margin: [0, 5, 0, 0] },
                            getSeverityBadge('1_3', data) || {},
                            data.notes_1_3 ? { text: `Megjegyz√©s: ${data.notes_1_3}`, style: 'notes' } : {}
                        ],
                        border: [true, true, true, true],
                        fillColor: '#fafafa'
                    }
                ]]
            },
            layout: {
                hLineColor: '#333',
        vLineColor: '#333',
                hLineWidth: function() { return 1; },
                vLineWidth: function() { return 1; }
            },
            margin: [0, 0, 0, 8],
            unbreakable: true
        },
        ...getImagesForPDF('1_3'),

        // 1.4
        {
            table: {
                widths: ['*'],
                body: [[
                    {
                        stack: [
                            { text: '1.4 Sz√ºks√©ges tervdokument√°ci√≥k, jegyz≈ëk√∂nyvek', style: 'checklistTitle' },
                            { text: 'BET; EBK terv; organiz√°ci√≥s terv stb.', style: 'checklistDesc' },
                            { text: `√ârt√©kel√©s: ${getStatusText(data.item_1_4)}`, style: getStatusStyle(data.item_1_4), margin: [0, 5, 0, 0] },
                            getSeverityBadge('1_4', data) || {},
                            data.notes_1_4 ? { text: `Megjegyz√©s: ${data.notes_1_4}`, style: 'notes' } : {}
                        ],
                        border: [true, true, true, true],
                        fillColor: '#fafafa'
                    }
                ]]
            },
            layout: {
                hLineColor: '#333',
        vLineColor: '#333',
                hLineWidth: function() { return 1; },
                vLineWidth: function() { return 1; }
            },
            margin: [0, 0, 0, 8],
            unbreakable: true
        },
        ...getImagesForPDF('1_4'),

        // Szankci√≥k - csak akkor jelenik meg, ha van bejel√∂lve szankci√≥
        ...getSanctionsSectionForPDF(data)
    ],

    styles: {
    mainHeader: {
        fontSize: 16,
        bold: true,
        color: '#5c0099',
        letterSpacing: 1
    },
    categoryHeader: {
        fontSize: 14,
        bold: true,
        color: '#333'
    },
    sectionHeader: {
    fontSize: 13,
    bold: true,
    color: '#333',
    margin: [0, 0, 0, 10]
},
    infoTable: {
        fontSize: 11
    },
    labelCell: {
        bold: true,
        color: '#333',
        fontSize: 10
    },
    valueCell: {
        color: '#333',
        fontSize: 10
    },
    participantLabel: {
        fontSize: 11,
        bold: true,
        color: '#5c0099',
        margin: [0, 0, 0, 5]
    },
    participantName: {
        fontSize: 12,
        bold: true,
        color: '#333'
    },
    participantPosition: {
        fontSize: 10,
        color: '#666',
        italics: true
    },
    checklistTitle: {
        fontSize: 12,
        bold: true,
        color: '#333',
        margin: [5, 5, 5, 3]
    },
    checklistDesc: {
        fontSize: 9,
        color: '#666',
        italics: true,
        margin: [5, 0, 5, 5]
    },
    statusOk: {
        fontSize: 11,
        color: '#000000',
        bold: true,
        background: '#66FF66',
        margin: [5, 0, 5, 5]
    },
    statusFail: {
        fontSize: 11,
        color: '#000000',
        bold: true,
        background: '#FF0000',
        margin: [5, 0, 5, 5]
    },
    statusFT: {
        fontSize: 11,
        color: '#000000',
        bold: true,
        background: '#3b82f6',
        margin: [5, 0, 5, 5]
    },
    statusNA: {
        fontSize: 11,
        color: '#92400e',
        bold: true,
        background: '#fef3c7',
        margin: [5, 0, 5, 5]
    },
    notes: {
        fontSize: 9,
        italics: true,
        color: '#555',
        margin: [5, 5, 5, 8]
    },
    sanctionsSubtitle: {
        fontSize: 10,
        color: '#666',
        italics: true
    },
    sanctions: {
        fontSize: 10,
        margin: [0, 3, 0, 3]
    },
    imageTitle: {
        fontSize: 11,
        bold: true,
        color: '#333',
        margin: [0, 10, 0, 8]
    }
},

    defaultStyle: {
        font: 'Roboto'
    },

    images: {
        mvmLogo: mvmLogoBase64,
        iwsLogo: iwsLogoBase64
    }
};


            // PDF gener√°l√°s √©s felt√∂lt√©s
pdfMake.createPdf(docDefinition).getBase64(async function(pdfBase64) {
    console.log('üì§ PDF base64 gener√°lva, m√©ret:', pdfBase64.length, 'karakter');
    const imageCount = Object.keys(uploadedImages).reduce((sum, key) => sum + (uploadedImages[key]?.length || 0), 0);
    console.log('üì§ K√©pek sz√°ma felt√∂lt√©sre:', imageCount);

    // ‚≠ê Progress bar megjelen√≠t√©se
    showUploadProgress();
    updateUploadProgress(10, 'PDF el≈ëk√©sz√≠t√©se...');

    try {
        // K√ºld√©s a backend-nek
        updateUploadProgress(20, `PDF √©s ${imageCount} k√©p felt√∂lt√©se a szerverre...`);
        console.log('üåê Fetch kezd√©s - PDF √©s k√©pek felt√∂lt√©se...');

        const pdfFileName = generatePdfFileName();

        const response = await fetch('/projects/<%= project.id %>/reports/documentation/export-pdf', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                pdfData: `data:application/pdf;base64,${pdfBase64}`,
                serialNumber: serialNumber,
                projectName: projectName,
                fileName: pdfFileName,
                images: uploadedImages
            })
        });

        updateUploadProgress(40, 'V√°lasz fogad√°sa...');
        console.log('üì° V√°lasz √©rkezett:', response.status, response.statusText);

        if (!response.ok) {
            hideUploadProgress();
            throw new Error(`HTTP hiba! St√°tusz: ${response.status}`);
        }

        updateUploadProgress(60, 'Adatok feldolgoz√°sa...');
        const result = await response.json();
        console.log('‚úÖ Backend v√°lasz:', result);

        if (result.success) {
            updateUploadProgress(80, 'Drive felt√∂lt√©s...');

            if (result.driveUrl) {
                updateUploadProgress(100, `‚úÖ ${imageCount} k√©p sikeresen felt√∂ltve!`);

                setTimeout(() => {
                    hideUploadProgress();
                    alert('‚úÖ PDF sikeresen export√°lva √©s felt√∂ltve a Google Drive-ra!');
                    console.log('üìÇ Drive URL:', result.driveUrl);
                    if (result.images && result.images.length > 0) {
                        console.log(`üì∏ ${result.images.length} k√©p sikeresen felt√∂ltve metaadatokkal`);
                    }
                }, 500);
            } else {
                hideUploadProgress();
                alert('‚úÖ PDF let√∂lt√©sre k√©sz!');
            }
        } else {
            hideUploadProgress();
            console.warn('‚ö†Ô∏è Backend hiba:', result.message);
            alert('‚ö†Ô∏è Hiba: ' + (result.message || 'Ismeretlen hiba'));
        }

        // ‚≠ê JAV√çTOTT LET√ñLT√âS MOBILRA √âS ASZTALRA
        const fileName = pdfFileName;

        // Mobilos b√∂ng√©sz≈ë detekt√°l√°sa
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);

        console.log(`üì± Eszk√∂z t√≠pus: ${isMobile ? 'Mobil' : 'Asztal'}, iOS: ${isIOS}`);

        // PDF gener√°l√°s blob-k√©nt (minden eszk√∂z√∂n)
        pdfMake.createPdf(docDefinition).getBlob(function(blob) {
            try {
                const blobUrl = URL.createObjectURL(blob);

                if (isIOS) {
                    // iOS specifikus kezel√©s - √∫j ablakban nyit√°s
                    console.log('üçé iOS eszk√∂z - √öj ablak megnyit√°sa');
                    const reader = new FileReader();
                    reader.onloadend = function() {
                        const newWindow = window.open('', '_blank');
                        if (newWindow) {
                            newWindow.document.write(`
                                <html>
                                <head><title>${fileName}</title></head>
                                <body style="margin:0;">
                                    <embed src="${reader.result}" type="application/pdf" width="100%" height="100%" />
                                </body>
                                </html>
                            `);
                        } else {
                            alert('‚ö†Ô∏è K√©rlek enged√©lyezd az √∫j ablak megnyit√°s√°t a b√∂ng√©sz≈ëben!');
                        }
                    };
                    reader.readAsDataURL(blob);
                } else if (isMobile) {
                    // Android √©s egy√©b mobilok - Download attrib√∫tum
                    console.log('üì± Mobil b√∂ng√©sz≈ë - Let√∂lt√©s ind√≠t√°sa');
                    const link = document.createElement('a');
                    link.href = blobUrl;
                    link.download = fileName;
                    link.style.display = 'none';

                    document.body.appendChild(link);

                    // Kattint√°s szimul√°l√°sa t√∂bb m√≥don is
                    if (link.click) {
                        link.click();
                    } else {
                        const clickEvent = new MouseEvent('click', {
                            view: window,
                            bubbles: true,
                            cancelable: true
                        });
                        link.dispatchEvent(clickEvent);
                    }

                    // Cleanup k√©sleltet√©ssel
                    setTimeout(() => {
                        document.body.removeChild(link);
                        URL.revokeObjectURL(blobUrl);
                    }, 100);

                    console.log('‚úÖ PDF let√∂lt√©s elind√≠tva (mobil)');
                } else {
                    // Asztali b√∂ng√©sz≈ë - Standard let√∂lt√©s
                    console.log('üíª Asztali b√∂ng√©sz≈ë - Standard let√∂lt√©s');
                    const link = document.createElement('a');
                    link.href = blobUrl;
                    link.download = fileName;
                    link.style.display = 'none';

                    document.body.appendChild(link);
                    link.click();

                    setTimeout(() => {
                        document.body.removeChild(link);
                        URL.revokeObjectURL(blobUrl);
                    }, 100);
                }
            } catch (error) {
                console.error('‚ùå PDF let√∂lt√©si hiba:', error);
                alert('‚ö†Ô∏è Hiba t√∂rt√©nt a PDF let√∂lt√©sekor. Pr√≥b√°ld √∫jra!');
            }
        });

    } catch (error) {
        hideUploadProgress();
        console.error('‚ùå Kritikus hiba a PDF export√°l√°s sor√°n:', error);

        // R√©szletes hibakezel√©s
        let errorMessage = '‚ö†Ô∏è Hiba t√∂rt√©nt a PDF export√°l√°sa k√∂zben.\n\n';

        if (error.name === 'TypeError' && error.message.includes('fetch')) {
            errorMessage += 'H√°l√≥zati kapcsolat hiba. Ellen≈ërizd az internet kapcsolatot √©s pr√≥b√°ld √∫jra!';
        } else if (error.message.includes('HTTP hiba')) {
            errorMessage += 'Szerver hiba: ' + error.message;
        } else {
            errorMessage += error.message || 'Ismeretlen hiba t√∂rt√©nt.';
        }

        alert(errorMessage);

        // Pr√≥b√°ljunk helyi let√∂lt√©st biztons√°gi ment√©sk√©nt
        console.log('üîÑ Pr√≥b√°lkoz√°s helyi PDF let√∂lt√©ssel...');
        try {
            const fileName = generatePdfFileName();
            pdfMake.createPdf(docDefinition).download(fileName);
            console.log('‚úÖ Helyi let√∂lt√©s siker√ºlt');
        } catch (downloadError) {
            console.error('‚ùå Helyi let√∂lt√©s is sikertelen:', downloadError);
        }
    }
});
}

        // Seg√©df√ºggv√©nyek a PDF-hez
        function getStatusText(status) {
            switch(status) {
                case 'megfelel≈ë': return 'MEGFELEL≈ê (M)';
                case 'nem_megfelel≈ë': return 'NEM MEGFELEL≈ê (NM)';
                case 'felsz√≥l√≠t√°s_ut√°n': return 'FELSZ√ìL√çT√ÅS UT√ÅN TELJES√çTVE (FT)';
                case 'nem_vizsg√°lt': return 'NEM VIZSG√ÅLT (NV)';
                default: return 'Nincs √©rt√©kelve';
            }
        }

        function getStatusStyle(status) {
            switch(status) {
                case 'megfelel≈ë': return 'statusOk';
                case 'nem_megfelel≈ë': return 'statusFail';
                case 'felsz√≥l√≠t√°s_ut√°n': return 'statusFT';
                case 'nem_vizsg√°lt': return 'statusNA';
                default: return 'statusNA';
            }
        }

        function getSeverityBadge(itemId, data) {
            const severity = data[`item_${itemId}_severity`];
            if (!severity) return null;

            const severityConfig = {
                'alacsony': { text: 'Hiba s√∫lyoss√°ga: üü° ALACSONY', color: '#000000', bg: '#FFFF00' },
                'k√∂zepes': { text: 'Hiba s√∫lyoss√°ga: üü† K√ñZEPES', color: '#000000', bg: '#ED7D31' },
                'magas': { text: 'Hiba s√∫lyoss√°ga: üî¥ MAGAS', color: '#000000', bg: '#FF0000' }
            };

            const config = severityConfig[severity];
            if (!config) return null;

            return {
                text: config.text,
                bold: true,
                fontSize: 10,
                color: config.color,
                background: config.bg,
                margin: [0, 5, 0, 0]
            };
        }

        // Tan√∫k PDF-hez
        function getWitnessesForPDF(data) {
            const result = [];

            // Ha "Nem √°ll rendelkez√©sre Tan√∫" checkbox be van pip√°lva
            const noWitnessCheckbox = document.getElementById('noWitnessAvailable');
            if (noWitnessCheckbox && noWitnessCheckbox.checked) {
                result.push({
                    text: 'Tan√∫k',
                    style: 'participantLabel',
                    margin: [0, 0, 0, 5]
                });
                result.push({
                    text: 'Nem √°ll rendelkez√©sre Tan√∫',
                    style: 'participantName',
                    italics: true,
                    color: '#999',
                    margin: [0, 0, 0, 15]
                });
                return result;
            }

            // Ha nincsenek tan√∫k megjelen√≠tve
            if (!witnessesVisible || witnessCounter === 0) {
                return result;
            }

            // 2 tan√∫ megjelen√≠t√©se
            for (let i = 0; i < 2; i++) {
                const witnessName = data[`witness_name_${i}`];
                const witnessPosition = data[`witness_position_${i}`];
                const witnessIdNumber = data[`witness_id_number_${i}`];
                const witnessAddress = data[`witness_address_${i}`];
                const witnessSignature = signatures[`witness_${i}`];

                result.push({
                    columns: [
                        {
                            width: '*',
                            stack: [
                                { text: `Tan√∫ ${i + 1}`, style: 'participantLabel' },
                                { text: witnessName || 'N/A', style: 'participantName' },
                                { text: witnessPosition || '', style: 'participantPosition' },
                                { text: `Szem√©lyi sz√°m: ${witnessIdNumber || 'N/A'}`, fontSize: 9, margin: [0, 3, 0, 0] },
                                { text: `Lakc√≠m: ${witnessAddress || 'N/A'}`, fontSize: 9, margin: [0, 2, 0, 0] }
                            ]
                        },
                        {
                            width: 150,
                            stack: [
                                witnessSignature ? {
                                    image: witnessSignature,
                                    width: 120,
                                    alignment: 'center',
                                    margin: [0, 5, 0, 0]
                                } : {
                                    text: '[Al√°√≠r√°s hi√°nyzik]',
                                    italics: true,
                                    color: '#999',
                                    fontSize: 9,
                                    alignment: 'center',
                                    margin: [0, 20, 0, 0]
                                }
                            ]
                        }
                    ],
                    margin: [0, 0, 0, 10],
                    unbreakable: true
                });
            }

            return result;
        }

        // Szankci√≥k PDF-hez
        function getAppliedSanctionsForPDF(data) {
            const sanctionLabels = {
                sanction_1: '1 MVM XPert munka-, t≈±z-, vagy k√∂rnyezetv√©delmi szab√°lyainak megs√©rt√©se',
                sanction_2: '6 Munkabiztons√°got jelent≈ësen befoly√°sol√≥ eszk√∂z√∂k, jelz√©sek, biztons√°gi berendez√©sek mell≈ëz√©se, kiiktat√°sa',
                sanction_3: '9 Vesz√©lyes munkaeszk√∂z √ºzembehelyez√©s√©nek √©s id≈ëszakos biztons√°gi fel√ºlvizsg√°lat elv√©gz√©s√©nek hi√°nya',
                sanction_4: '10 A munkav√©gz√©shez haszn√°lt id≈ëszakos fel√ºlvizsg√°latra k√∂telezett g√©pek, berendez√©sek, munkaeszk√∂z√∂k nem azonos√≠that√≥k',
                sanction_5: '15 Egy√©b jogosulatlan munkav√©gz√©s (pl: g√©pkezel≈ëi jogosults√°gok)',
                sanction_6: '16 Id≈ëszakos biztons√°gi √©s egy√©b jogszab√°lyban meghat√°rozott fel√ºlvizsg√°latok hi√°nya',
                sanction_7: '26 √çr√°sos enged√©lyhez k√∂t√∂tt tev√©kenys√©g v√©gz√©se enged√©ly n√©lk√ºl',
                sanction_8: '27 Emel√©si terv k√∂teles tev√©kenys√©g enged√©ly n√©lk√ºli v√©gz√©se',
                sanction_9: '39 Megrendel≈ë fel√© jelentend≈ë EBK esem√©ny jelent√©s√©nek elmulaszt√°sa'
            };

            const sanctionPricesRaw = {
                sanction_1: 100000,
                sanction_2: 50000,
                sanction_3: 50000,
                sanction_4: 30000,
                sanction_5: 50000,
                sanction_6: 100000,
                sanction_7: 100000,
                sanction_8: 100000,
                sanction_9: 100000
            };

            const result = [];
            let hasAny = false;

            const checkboxes = document.querySelectorAll('.price-item input[type="checkbox"]');

            checkboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    const sanctionKey = checkbox.name;
                    hasAny = true;

                    // Darabsz√°m lek√©r√©se
                    const countInput = document.querySelector(`input[name="${sanctionKey}_count"]`);
                    const count = countInput ? parseInt(countInput.value) || 1 : 1;
                    const basePrice = sanctionPricesRaw[sanctionKey];
                    const totalPrice = basePrice * count;
                    const formattedPrice = totalPrice.toLocaleString('hu-HU') + ' Ft';

                    // Ha t√∂bb mint 1 db, megjelenitjuk a mennyis√©get
                    const countText = count > 1 ? ` (${count}x)` : '';

                    result.push({
                        text: `‚Ä¢ ${sanctionLabels[sanctionKey]}${countText} - ${formattedPrice}`,
                        style: 'sanctions',
                        margin: [0, 3, 0, 3]
                    });
                }
            });

            // Ha nincs szankci√≥, √ºres t√∂mb√∂t adunk vissza
            return { sanctions: result, hasAny: hasAny };
        }

        // Szankci√≥s lista teljes szekci√≥ja - csak akkor jelenik meg, ha van szankci√≥
        function getSanctionsSectionForPDF(data) {
            const sanctionsData = getAppliedSanctionsForPDF(data);

            // Ha nincs szankci√≥, √ºres t√∂mb√∂t adunk vissza
            if (!sanctionsData.hasAny) {
                return [];
            }

            // Ha van szankci√≥, visszaadjuk a teljes szekci√≥t
            return [
                {
                    text: 'SZANKCI√ìS LISTA',
                    style: 'sectionHeader',
                    margin: [0, 15, 0, 10]
                },
                {
                    text: 'Dokument√°ci√≥ kateg√≥ria vonatkoz√≥ pontjai',
                    style: 'sanctionsSubtitle',
                    margin: [0, 0, 0, 10]
                },
                ...sanctionsData.sanctions,
                {
                    table: {
                        widths: ['*', 'auto'],
                        body: [[
                            { text: 'Kiszabhat√≥ √∂sszes√≠tett b√≠rs√°g:', bold: true, fontSize: 14, alignment: 'right', border: [false, true, false, false], margin: [0, 10, 0, 10] },
                            { text: totalPriceElement.textContent, bold: true, fontSize: 16, color: '#dc3545', alignment: 'right', border: [false, true, false, false], margin: [0, 10, 0, 10] }
                        ]]
                    },
                    layout: {
                        hLineColor: '#333',
                        hLineWidth: function() { return 2; }
                    },
                    margin: [0, 10, 0, 0]
                }
            ];
        }

        // ‚≠ê M√ìDOS√çTOTT: K√©pek PDF-hez metaadatokkal
        function getImagesForPDF(itemId) {
            const images = uploadedImages[itemId];
            if (!images || images.length === 0) {
                return [];
            }

            const result = [
                {
                    text: 'Csatolt f√©nyk√©pek / dokument√°ci√≥:',
                    style: 'imageTitle',
                    margin: [0, 10, 0, 8]
                }
            ];

            for (let i = 0; i < images.length; i++) {
                const imgObj = images[i];
                const imageData = imgObj.data;
                const metadata = imgObj.metadata || {}; // ‚≠ê Biztons√°gi fallback

                // ‚≠ê K√©p megjelen√≠t√©se (m√°r t√∂m√∂r√≠tve 70% min≈ës√©g, max 1600px)
                result.push({
                    image: imageData,
                    width: 300, // PDF-ben 300px sz√©les
                    alignment: 'center',
                    margin: [0, 5, 0, 5]
                });

                // ‚≠ê Metaadatok megjelen√≠t√©se a k√©p alatt
                const metaText = [];

                if (metadata.fileName) {
                    metaText.push(`üìÑ ${metadata.fileName}`);
                }

                if (metadata.hasDate && metadata.takenDate) {
                    try {
                        const formattedMeta = formatDate(metadata.takenDate);
                        metaText.push(`üìÖ Felv√©tel ideje: ${formattedMeta}`);
                    } catch (e) {
                        console.warn('D√°tum form√°z√°si hiba:', e);
                    }
                }

                if (metadata.hasGPS && metadata.location) {
                    metaText.push(`üìç Helysz√≠n: ${metadata.location}`);
                }

                if (metadata.camera) {
                    metaText.push(`üì∑ ${metadata.camera}`);
                }

                if (!metadata.hasDate || !metadata.hasGPS) {
                    metaText.push(`‚ö†Ô∏è Hi√°nyos metaadatok`);
                }

                // ‚≠ê Csak akkor adjuk hozz√°, ha van valamilyen metaadat
                if (metaText.length === 0) {
                    metaText.push(`K√©p ${i + 1}`);
                }

                result.push({
                    text: metaText.join('\n'),
                    fontSize: 9,
                    color: '#666',
                    italics: true,
                    margin: [0, 3, 0, 15]
                });
            }

            return result;
        }

        // Modal bez√°r√°sa kattint√°ssal a h√°tt√©rre
        window.onclick = function(event) {
            const modal = document.getElementById('signatureModal');
            if (event.target == modal) {
                closeSignatureModal();
            }
        }

        // Mentett adatok bet√∂lt√©se a form-ba
function loadSavedData(data) {
    console.log('loadSavedData megh√≠vva:', data);
    
    // Projekt inform√°ci√≥k
    if (data.projectName) {
        document.getElementById('projectName').value = data.projectName;
    }
    if (data.serialNumber) {
        document.getElementById('serialNumber').value = data.serialNumber;
    }
    if (data.inspectorPerson) {
        document.getElementById('inspectorPerson').value = data.inspectorPerson;
    }
    if (data.inspectionDate) {
        document.getElementById('inspectionDate').value = data.inspectionDate;
    }
    
    // R√©sztvev≈ëk
    if (data.inspector_name) {
        document.querySelector('input[name="inspector_name"]').value = data.inspector_name;
    }
    if (data.inspector_position) {
        document.querySelector('input[name="inspector_position"]').value = data.inspector_position;
    }
    if (data.responsible_name) {
        document.querySelector('input[name="responsible_name"]').value = data.responsible_name;
    }
    if (data.responsible_position) {
        document.querySelector('input[name="responsible_position"]').value = data.responsible_position;
    }
    
    // Al√°√≠r√°sok bet√∂lt√©se
    if (data.inspector_signature) {
        signatures.inspector = data.inspector_signature;
        document.getElementById('inspectorSignature').value = data.inspector_signature;
        document.getElementById('inspectorPreview').innerHTML = `<img src="${data.inspector_signature}" alt="Al√°√≠r√°s">`;
        document.getElementById('inspectorClear').style.display = 'block';
    }
    
    if (data.responsible_signature) {
        signatures.responsible = data.responsible_signature;
        document.getElementById('responsibleSignature').value = data.responsible_signature;
        document.getElementById('responsiblePreview').innerHTML = `<img src="${data.responsible_signature}" alt="Al√°√≠r√°s">`;
        document.getElementById('responsibleClear').style.display = 'block';
    }

    // Tan√∫k bet√∂lt√©se - ha van mentett tan√∫ adat, megjelen√≠tj√ºk a szekci√≥t
    if (data.witness_name_0 || data.witness_name_1 || data.witnessesVisible) {
        showWitnesses();

        setTimeout(() => {
            // 2 tan√∫ bet√∂lt√©se
            for (let i = 0; i < 2; i++) {
                const nameInput = document.querySelector(`input[name="witness_name_${i}"]`);
                const positionInput = document.querySelector(`input[name="witness_position_${i}"]`);
                const idNumberInput = document.querySelector(`input[name="witness_id_number_${i}"]`);
                const addressInput = document.querySelector(`input[name="witness_address_${i}"]`);

                if (nameInput && data[`witness_name_${i}`]) {
                    nameInput.value = data[`witness_name_${i}`];
                }
                if (positionInput && data[`witness_position_${i}`]) {
                    positionInput.value = data[`witness_position_${i}`];
                }
                if (idNumberInput && data[`witness_id_number_${i}`]) {
                    idNumberInput.value = data[`witness_id_number_${i}`];
                }
                if (addressInput && data[`witness_address_${i}`]) {
                    addressInput.value = data[`witness_address_${i}`];
                }

                if (data[`witness_signature_${i}`]) {
                    signatures[`witness_${i}`] = data[`witness_signature_${i}`];
                    const sigInput = document.getElementById(`witness_${i}Signature`);
                    const preview = document.getElementById(`witnessPreview_${i}`);
                    const clearBtn = document.getElementById(`witness_${i}Clear`);

                    if (sigInput) sigInput.value = data[`witness_signature_${i}`];
                    if (preview) preview.innerHTML = `<img src="${data[`witness_signature_${i}`]}" alt="Al√°√≠r√°s">`;
                    if (clearBtn) clearBtn.style.display = 'block';
                }
            }

            // "Nem √°ll rendelkez√©sre Tan√∫" checkbox bet√∂lt√©se
            if (data.noWitnessAvailable) {
                document.getElementById('noWitnessAvailable').checked = true;
                toggleNoWitness();
            }
        }, 200);
    }
    
    // Alv√°llalkoz√≥k bet√∂lt√©se (√∫j form√°tum)
    if (data.subcontractors && Array.isArray(data.subcontractors)) {
        // Az √∫j form√°tum: t√∂mb a c√©gnevekkel (MVM Xpert Zrt. n√©lk√ºl, mert az fix)
        data.subcontractors.forEach(companyName => {
            if (companyName && companyName !== 'MVM Xpert Zrt.') {
                addSubcontractor();
                const items = document.querySelectorAll('.subcontractor-item');
                const lastItem = items[items.length - 1];
                if (lastItem) {
                    const input = lastItem.querySelector('input');
                    if (input) input.value = companyName;
                }
            }
        });
    } else {
        // R√©gi form√°tum kompatibilit√°s (ha van subcontractor_name)
        if (data.subcontractor_name && data.subcontractor_name !== 'MVM Xpert Zrt.') {
            addSubcontractor();
            const items = document.querySelectorAll('.subcontractor-item');
            const lastItem = items[items.length - 1];
            if (lastItem) {
                const input = lastItem.querySelector('input');
                if (input) input.value = data.subcontractor_name;
            }
        }
    }
    
    // Ellen≈ërz√©si pontok
    ['item_1_1', 'item_1_2', 'item_1_3', 'item_1_4'].forEach(itemName => {
        if (data[itemName]) {
            const radio = document.querySelector(`input[name="${itemName}"][value="${data[itemName]}"]`);
            if (radio) {
                radio.checked = true;
                // Severity megjelen√≠t√©se ha sz√ºks√©ges
                const itemId = itemName.replace('item_', '');
                toggleSeverity(itemId);
            }
        }

        // Severity √©rt√©kek bet√∂lt√©se
        const severityKey = `${itemName}_severity`;
        if (data[severityKey]) {
            const severityRadio = document.querySelector(`input[name="${severityKey}"][value="${data[severityKey]}"]`);
            if (severityRadio) severityRadio.checked = true;
        }
    });
    
    // Megjegyz√©sek
    ['notes_1_1', 'notes_1_2', 'notes_1_3', 'notes_1_4'].forEach(noteName => {
        if (data[noteName]) {
            const textarea = document.querySelector(`textarea[name="${noteName}"]`);
            if (textarea) textarea.value = data[noteName];
        }
    });
    
    // ‚≠ê K√©pek bet√∂lt√©se metaadatokkal
    if (data.images) {
        ['1_1', '1_2', '1_3', '1_4'].forEach(itemId => {
            if (data.images[itemId] && Array.isArray(data.images[itemId])) {
                uploadedImages[itemId] = data.images[itemId];
                
                const previewContainer = document.getElementById(`preview_${itemId}`);
                data.images[itemId].forEach(imgObj => {
                    // ‚≠ê √öj form√°tum: {data, originalData, metadata}
                    // ‚≠ê R√©gi form√°tum: {data, metadata}
                    const imageData = imgObj.data || imgObj;
                    const metadata = imgObj.metadata || {};
                    
                    const previewItem = document.createElement('div');
                    previewItem.className = 'image-preview-item';

                    const img = document.createElement('img');
                    img.src = imageData;
                    // ‚≠ê JAV√çTOTT - Mobilos k√©pmegjelen√≠t√©s bet√∂lt√∂tt k√©pekn√©l is
                    img.style.width = '100%';
                    img.style.height = '200px';
                    img.style.objectFit = 'cover';
                    img.style.display = 'block';
                    img.onload = function() {
                        console.log('‚úÖ Mentett k√©p bet√∂ltve');
                    };
                    img.onerror = function() {
                        console.error('‚ùå Mentett k√©p bet√∂lt√©si hiba');
                    };

                    // Metaadatok megjelen√≠t√©se
                    const metaInfo = document.createElement('div');
                    metaInfo.className = 'image-meta-info';

                    let metaHTML = '';

                    if (metadata.hasDate && metadata.takenDate) {
                        metaHTML += `
                            <div class="meta-item">
                                <i class="fas fa-calendar"></i>
                                <span>${formatDate(metadata.takenDate)}</span>
                            </div>
                        `;
                    }

                    // ‚≠ê JAV√çTOTT - GPS megjelen√≠t√©s bet√∂lt√∂tt k√©pekn√©l
                    if (metadata.hasGPS && metadata.location && metadata.latitude && metadata.longitude) {
                        console.log('üìç Bet√∂lt√∂tt GPS:', metadata.location);
                        metaHTML += `
                            <div class="meta-item">
                                <i class="fas fa-map-marker-alt"></i>
                                <span>
                                    <a href="https://www.google.com/maps?q=${metadata.latitude},${metadata.longitude}"
                                       target="_blank"
                                       rel="noopener noreferrer"
                                       class="map-link"
                                       style="color: #4CAF50; text-decoration: none; font-weight: bold;">
                                       ${metadata.location}
                                    </a>
                                </span>
                            </div>
                        `;
                    } else {
                        metaHTML += `
                            <div class="meta-item">
                                <i class="fas fa-map-marker-alt"></i>
                                <span style="color: #ffc107;">Nincs GPS adat</span>
                            </div>
                        `;
                    }
                    
                    if (!metadata.hasDate || !metadata.hasGPS) {
                        metaHTML += `
                            <div class="no-metadata-warning">
                                <i class="fas fa-exclamation-triangle"></i> 
                                <span>Hi√°nyos metaadatok</span>
                            </div>
                        `;
                    }
                    
                    metaInfo.innerHTML = metaHTML;
                    
                    const removeBtn = document.createElement('button');
                    removeBtn.className = 'image-remove-btn';
                    removeBtn.innerHTML = '&times;';
                    removeBtn.title = 'K√©p elt√°vol√≠t√°sa';
                    removeBtn.onclick = function(e) {
                        e.stopPropagation();
                        // ‚≠ê FIX: Bet√∂lt√∂tt k√©pekn√©l imageData a komplett objektum vagy string lehet
                        const index = uploadedImages[itemId].findIndex(img => {
                            // Ha img objektum (√∫j form√°tum: {data, originalData, metadata})
                            if (typeof img === 'object' && img.data) {
                                return img.data === imageData;
                            }
                            // Ha img string (r√©gi form√°tum)
                            return img === imageData;
                        });
                        if (index > -1) {
                            uploadedImages[itemId].splice(index, 1);
                            console.log('üóëÔ∏è Mentett k√©p elt√°vol√≠tva');
                        }
                        previewItem.remove();
                    };
                    
                    previewItem.appendChild(img);
                    previewItem.appendChild(metaInfo);
                    previewItem.appendChild(removeBtn);
                    previewContainer.appendChild(previewItem);
                });
            }
        });
    }
    
    // Szankci√≥k bet√∂lt√©se
    const checkboxes = document.querySelectorAll('.price-item input[type="checkbox"]');
    checkboxes.forEach(checkbox => {
        if (data[checkbox.name] === 'on' || data[checkbox.name] === checkbox.value) {
            checkbox.checked = true;
        }

        // Darabsz√°m bet√∂lt√©se
        const sanctionKey = checkbox.name;
        const countKey = `${sanctionKey}_count`;
        if (data[countKey]) {
            const countInput = document.querySelector(`input[name="${countKey}"]`);
            if (countInput) {
                countInput.value = data[countKey];
            }
        }
    });
    calculateTotal();
    
    console.log('‚úì Mentett adatok sikeresen bet√∂ltve a form-ba');
}
    </script>

</body>
</html>