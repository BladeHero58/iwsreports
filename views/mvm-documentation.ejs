<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>1. Dokument√°ci√≥ - <%= project.name %></title>
     <link rel="stylesheet" href="/css/pages/mvm-documentation.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.min.js"></script>
    <!-- ‚≠ê EXIF.js - √∫jabb verzi√≥ mobilos kompatibilit√°ssal -->
    <script src="https://cdn.jsdelivr.net/npm/exif-js@2.3.0/exif.min.js"></script>
    
    <!-- ‚≠ê EXIF metaadatok megjelen√≠t√©s√©re CSS -->
    <style>
        .image-preview-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 15px;
        }

        .image-preview-item {
            position: relative;
            width: 250px;
            border: 2px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.2s;
            background: white;
        }

        .image-preview-item:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .image-preview-item img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            display: block;
        }

        .image-meta-info {
            background: linear-gradient(to top, rgba(0,0,0,0.95), rgba(0,0,0,0.7));
            padding: 10px 12px;
            color: white;
            font-size: 11px;
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 6px;
            margin: 4px 0;
            line-height: 1.4;
        }

        .meta-item i {
            width: 14px;
            text-align: center;
            color: #4CAF50;
            flex-shrink: 0;
        }

        .meta-item span {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .map-link {
            color: #4CAF50;
            text-decoration: none;
            font-weight: bold;
        }

        .map-link:hover {
            text-decoration: underline;
            color: #66BB6A;
        }

        .image-remove-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(220, 53, 69, 0.95);
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 18px;
            line-height: 1;
            z-index: 10;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .image-remove-btn:hover {
            background: #dc3545;
            transform: scale(1.1);
        }

        .no-metadata-warning {
            background: rgba(255, 193, 7, 0.2);
            border-left: 3px solid #ffc107;
            padding: 6px 8px;
            margin-top: 5px;
            font-size: 10px;
            color: #f0f0f0;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .no-metadata-warning i {
            color: #ffc107;
        }
    </style>
   
</head>
<body>

    <% 
// Eld√∂ntj√ºk hogy admin vagy user oldal kell
const isAdmin = user.isAdmin || false;
const backUrl = isAdmin 
    ? `/admin/projects/${project.id}` 
    : `/user/projects/${project.id}`;
%>

<a href="<%= backUrl %>" class="back-button">
    <i class="fas fa-arrow-left"></i> Vissza a kateg√≥ri√°khoz
</a>

    <div class="container">

        <!-- Projekt inform√°ci√≥k -->
        <div class="project-info">
            <h3><i class="fas fa-project-diagram"></i> Projekt r√©szletek</h3>
            
            <div class="form-group" style="margin-bottom: 15px;">
                <label for="projectName"><strong>Projekt neve:</strong></label>
                <input type="text" id="projectName" name="projectName" value="<%= project.name %>" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
            </div>

            <div class="form-group" style="margin-bottom: 15px;">
                <label for="serialNumber"><strong>Sorsz√°m:</strong></label>
                <input type="text" id="serialNumber" name="serialNumber" placeholder="Pl. IWS/BCS/20251201" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
            </div>

            <div class="form-group" style="margin-bottom: 15px;">
                <label for="inspectorPerson"><strong>Ellen≈ërz≈ë szem√©ly:</strong></label>
                <input type="text" id="inspectorPerson" name="inspectorPerson" value="<%= user.name %>" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
            </div>

            <div class="form-group" style="margin-bottom: 15px;">
                <label for="inspectionDate"><strong>D√°tum:</strong></label>
                <input type="date" id="inspectionDate" name="inspectionDate" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
            </div>

            <p style="font-size: 13px; color: #999; margin-top: 10px;">
                <em>Projekt t√≠pus: <%= project.project_type %></em>
            </p>

            <!--  √öJ ellen≈ërz√©s GOMB -->
<div style="text-align: center; margin: 20px 0;">
    <button type="button" class="add-button" onclick="startNewInspection()" style="width: auto; padding: 12px 30px;">
        <i class="fas fa-plus"></i> √öj ellen≈ërz√©s ind√≠t√°sa
    </button>
</div>

        </div>

        <!-- Header -->
        <div class="header">
            <h1>1. Dokument√°ci√≥</h1>
            <p>Munkater√ºlet√©rt felel≈ës beazonos√≠t√°sa, enged√©lyek, tervdokument√°ci√≥k ellen≈ërz√©se</p>
        </div>

        <form id="documentationForm" method="POST" action="/projects/<%= project.id %>/reports/documentation">

            <!-- Ellen≈ërz√©s r√©sztvev≈ëi -->
            <div class="form-section">
                <div class="section-title">Ellen≈ërz√©s r√©sztvev≈ëi</div>
                
                <!-- Ellen≈ërz√©st v√©gz≈ë -->
                <div class="form-group">
                    <label>Ellen≈ërz√©st v√©gz≈ë</label>
                    <div class="two-column">
                        <input type="text" name="inspector_name" placeholder="N√©v">
                        <input type="text" name="inspector_position" placeholder="Beoszt√°s">
                    </div>
                    
                    <div class="signature-container">
                        <div class="signature-preview" id="inspectorPreview" onclick="openSignatureModal('inspector')">
                            <span><i class="fas fa-pen"></i> Kattintson ide az al√°√≠r√°s hozz√°ad√°s√°hoz</span>
                        </div>
                        <div class="signature-buttons">
                            <button type="button" class="add-button" onclick="openSignatureModal('inspector')">
                                <i class="fas fa-signature"></i> Al√°√≠r√°s hozz√°ad√°sa
                            </button>
                            <button type="button" class="clear-signature" onclick="clearSignature('inspector')" style="display: none;" id="inspectorClear">
                                <i class="fas fa-trash"></i> T√∂rl√©s
                            </button>
                        </div>
                    </div>
                    <input type="hidden" name="inspector_signature" id="inspectorSignature">
                </div>

                <!-- Munkater√ºlet√©rt felel≈ës -->
                <div class="form-group">
                    <label>Munkater√ºlet√©rt felel≈ës</label>
                    <div class="two-column">
                        <input type="text" name="responsible_name" placeholder="Munkater√ºlet√©rt felel≈ës neve">
                        <input type="text" name="responsible_position" placeholder="Beoszt√°s">
                    </div>
                    
                    <div class="signature-container">
                        <div class="signature-preview" id="responsiblePreview" onclick="openSignatureModal('responsible')">
                            <span><i class="fas fa-pen"></i> Kattintson ide az al√°√≠r√°s hozz√°ad√°s√°hoz</span>
                        </div>
                        <div class="signature-buttons">
                            <button type="button" class="add-button" onclick="openSignatureModal('responsible')">
                                <i class="fas fa-signature"></i> Al√°√≠r√°s hozz√°ad√°sa
                            </button>
                            <button type="button" class="clear-signature" onclick="clearSignature('responsible')" style="display: none;" id="responsibleClear">
                                <i class="fas fa-trash"></i> T√∂rl√©s
                            </button>
                        </div>
                    </div>
                    <input type="hidden" name="responsible_signature" id="responsibleSignature">
                </div>

                <!-- Tan√∫k kont√©ner -->
                <div id="witnessesContainer">
                    <div class="witness-group" data-witness-index="0">
                        <label>Tan√∫</label>
                        <div class="two-column">
                            <input type="text" name="witness_name_0" placeholder="N√©v">
                            <input type="text" name="witness_position_0" placeholder="Beoszt√°s">
                        </div>
                        
                        <div class="signature-container">
                            <div class="signature-preview" id="witnessPreview_0" onclick="openSignatureModal('witness_0')">
                                <span><i class="fas fa-pen"></i> Kattintson ide az al√°√≠r√°s hozz√°ad√°s√°hoz</span>
                            </div>
                            <div class="signature-buttons">
                                <button type="button" class="add-button" onclick="openSignatureModal('witness_0')">
                                    <i class="fas fa-signature"></i> Al√°√≠r√°s hozz√°ad√°sa
                                </button>
                                <button type="button" class="clear-signature" onclick="clearSignature('witness_0')" style="display: none;" id="witness_0Clear">
                                    <i class="fas fa-trash"></i> T√∂rl√©s
                                </button>
                            </div>
                        </div>
                        <input type="hidden" name="witness_signature_0" id="witness_0Signature">
                    </div>
                </div>

                <button type="button" class="add-button-secondary" onclick="addWitness()">
                    <i class="fas fa-user-plus"></i> Tov√°bbi tan√∫ hozz√°ad√°sa
                </button>

                <!-- Alv√°llalkoz√≥i l√°nc -->
                <div class="form-group">
                    <label>Alv√°llalkoz√≥i l√°nc</label>
                    <div class="two-column">
                        <input type="text" name="subcontractor_name" placeholder="Alv√°llalkoz√≥ c√©g neve">
                        <input type="text" name="subcontractor_representative" placeholder="Felel≈ës szem√©ly neve">
                    </div>
                    
                    <div class="signature-container">
                        <div class="signature-preview" id="subcontractorPreview" onclick="openSignatureModal('subcontractor')">
                            <span><i class="fas fa-pen"></i> Kattintson ide az al√°√≠r√°s hozz√°ad√°s√°hoz</span>
                        </div>
                        <div class="signature-buttons">
                            <button type="button" class="add-button" onclick="openSignatureModal('subcontractor')">
                                <i class="fas fa-signature"></i> Al√°√≠r√°s hozz√°ad√°sa
                            </button>
                            <button type="button" class="clear-signature" onclick="clearSignature('subcontractor')" style="display: none;" id="subcontractorClear">
                                <i class="fas fa-trash"></i> T√∂rl√©s
                            </button>
                        </div>
                    </div>
                    <input type="hidden" name="subcontractor_signature" id="subcontractorSignature">
                </div>
            </div>

            <!-- 1.1 Munkater√ºlet√©rt felel≈ës beazonos√≠t√°sa -->
            <div class="checklist-item">
                <div class="checklist-header">1.1 Munkater√ºlet√©rt felel≈ës beazonos√≠t√°sa</div>
                <div class="checklist-description">√Åtad√°s √°tv√©tel jegyz≈ëk√∂nyv fellelhet≈ës√©ge, munkaenged√©ly, stb.</div>
                
                <div class="radio-options">
                    <div class="radio-option success">
                        <input type="radio" id="item_1_1_m" name="item_1_1" value="megfelel≈ë">
                        <label for="item_1_1_m">Megfelelt</label>
                    </div>
                    <div class="radio-option danger">
                        <input type="radio" id="item_1_1_nm" name="item_1_1" value="nem_megfelel≈ë">
                        <label for="item_1_1_nm">Nem megfelelt</label>
                    </div>
                    <div class="radio-option warning">
                        <input type="radio" id="item_1_1_nv" name="item_1_1" value="nem_vizsg√°lt">
                        <label for="item_1_1_nv">Nem vonatkozik / Nem vizsg√°lt</label>
                    </div>
                </div>

                <div class="form-group" style="margin-top: 15px;">
                    <label><i class="fas fa-camera"></i> F√©nyk√©pek / dokument√°ci√≥</label>
                    <input type="file" id="photos_1_1" accept="image/*" multiple onchange="handleImageUpload(event, '1_1')" style="margin-bottom: 10px;">
                    <div id="preview_1_1" class="image-preview-container"></div>
                </div>

                <textarea class="notes-textarea" name="notes_1_1" placeholder="Megjegyz√©s..."></textarea>
            </div>

            <!-- 1.2 Egy√©b dokument√°ci√≥k -->
            <div class="checklist-item">
                <div class="checklist-header">1.2 Egy√©b dokument√°ci√≥k</div>
                <div class="checklist-description">√âp√≠t√©si napl√≥, hullad√©k nyilv√°ntart√≥lap stb.</div>
                
                <div class="radio-options">
                    <div class="radio-option success">
                        <input type="radio" id="item_1_2_m" name="item_1_2" value="megfelel≈ë">
                        <label for="item_1_2_m">Megfelelt</label>
                    </div>
                    <div class="radio-option danger">
                        <input type="radio" id="item_1_2_nm" name="item_1_2" value="nem_megfelel≈ë">
                        <label for="item_1_2_nm">Nem megfelelt</label>
                    </div>
                    <div class="radio-option warning">
                        <input type="radio" id="item_1_2_nv" name="item_1_2" value="nem_vizsg√°lt">
                        <label for="item_1_2_nv">Nem vonatkozik / Nem vizsg√°lt</label>
                    </div>
                </div>

                <div class="form-group" style="margin-top: 15px;">
                    <label><i class="fas fa-camera"></i> F√©nyk√©pek / dokument√°ci√≥</label>
                    <input type="file" id="photos_1_2" accept="image/*" multiple onchange="handleImageUpload(event, '1_2')" style="margin-bottom: 10px;">
                    <div id="preview_1_2" class="image-preview-container"></div>
                </div>

                <textarea class="notes-textarea" name="notes_1_2" placeholder="Megjegyz√©s..."></textarea>
            </div>

            <!-- 1.3 Sz√ºks√©ges enged√©lyek -->
            <div class="checklist-item">
                <div class="checklist-header">1.3 Sz√ºks√©ges enged√©lyek</div>
                <div class="checklist-description">T≈±zgy√∫jt√°si, besz√°ll√°si, fesz√ºlts√©g ment., emel√©si terv, nincs lefolytatva az elj√°r√°s, a benne foglalaltak nem teljes√ºlnek stb.</div>
                
                <div class="radio-options">
                    <div class="radio-option success">
                        <input type="radio" id="item_1_3_m" name="item_1_3" value="megfelel≈ë">
                        <label for="item_1_3_m">Megfelelt</label>
                    </div>
                    <div class="radio-option danger">
                        <input type="radio" id="item_1_3_nm" name="item_1_3" value="nem_megfelel≈ë">
                        <label for="item_1_3_nm">Nem megfelelt</label>
                    </div>
                    <div class="radio-option warning">
                        <input type="radio" id="item_1_3_nv" name="item_1_3" value="nem_vizsg√°lt">
                        <label for="item_1_3_nv">Nem vonatkozik / Nem vizsg√°lt</label>
                    </div>
                </div>

                <div class="form-group" style="margin-top: 15px;">
                    <label><i class="fas fa-camera"></i> F√©nyk√©pek / dokument√°ci√≥</label>
                    <input type="file" id="photos_1_3" accept="image/*" multiple onchange="handleImageUpload(event, '1_3')" style="margin-bottom: 10px;">
                    <div id="preview_1_3" class="image-preview-container"></div>
                </div>

                <textarea class="notes-textarea" name="notes_1_3" placeholder="Megjegyz√©s..."></textarea>
            </div>

            <!-- 1.4 Sz√ºks√©ges tervdokument√°ci√≥k -->
            <div class="checklist-item">
                <div class="checklist-header">1.4 Sz√ºks√©ges tervdokument√°ci√≥k, jegyz≈ëk√∂nyvek</div>
                <div class="checklist-description">BET; EBK terv; organiz√°ci√≥s terv stb.</div>
                
                <div class="radio-options">
                    <div class="radio-option success">
                        <input type="radio" id="item_1_4_m" name="item_1_4" value="megfelel≈ë">
                        <label for="item_1_4_m">Megfelelt</label>
                    </div>
                    <div class="radio-option danger">
                        <input type="radio" id="item_1_4_nm" name="item_1_4" value="nem_megfelel≈ë">
                        <label for="item_1_4_nm">Nem megfelelt</label>
                    </div>
                    <div class="radio-option warning">
                        <input type="radio" id="item_1_4_nv" name="item_1_4" value="nem_vizsg√°lt">
                        <label for="item_1_4_nv">Nem vonatkozik / Nem vizsg√°lt</label>
                    </div>
                </div>

                <div class="form-group" style="margin-top: 15px;">
                    <label><i class="fas fa-camera"></i> F√©nyk√©pek / dokument√°ci√≥</label>
                    <input type="file" id="photos_1_4" accept="image/*" multiple onchange="handleImageUpload(event, '1_4')" style="margin-bottom: 10px;">
                    <div id="preview_1_4" class="image-preview-container"></div>
                </div>

                <textarea class="notes-textarea" name="notes_1_4" placeholder="Megjegyz√©s..."></textarea>
            </div>

            <!-- Szankci√≥s lista -->
            <div class="price-section">
                <h3>Szankci√≥s lista - Dokument√°ci√≥ kateg√≥ria vonatkoz√≥ pontjai</h3>
                
                <div class="price-item">
                    <input type="checkbox" id="price_1" name="sanction_1" value="100000">
                    <label for="price_1">1 MVM XPert munka-, t≈±z-, vagy k√∂rnyezetv√©delmi szab√°lyainak megs√©rt√©se</label>
                    <span class="price">100,000 Ft</span>
                </div>

                <div class="price-item">
                    <input type="checkbox" id="price_2" name="sanction_2" value="50000">
                    <label for="price_2">6 Munkabiztons√°got jelent≈ësen befoly√°sol√≥ eszk√∂z√∂k, jelz√©sek, biztons√°gi berendez√©sek mell≈ëz√©se, kiiktat√°sa</label>
                    <span class="price">50,000 Ft</span>
                </div>

                <div class="price-item">
                    <input type="checkbox" id="price_3" name="sanction_3" value="50000">
                    <label for="price_3">9 Vesz√©lyes munkaeszk√∂z √ºzembehelyez√©s√©nek √©s id≈ëszakos biztons√°gi fel√ºlvizsg√°lat elv√©gz√©s√©nek hi√°nya</label>
                    <span class="price">50,000 Ft</span>
                </div>

                <div class="price-item">
                    <input type="checkbox" id="price_4" name="sanction_4" value="30000">
                    <label for="price_4">10 A munkav√©gz√©shez haszn√°lt id≈ëszakos fel√ºlvizsg√°latra k√∂telezett g√©pek, berendez√©sek, munkaeszk√∂z√∂k nem azonos√≠that√≥k</label>
                    <span class="price">30,000 Ft</span>
                </div>

                <div class="price-item">
                    <input type="checkbox" id="price_5" name="sanction_5" value="50000">
                    <label for="price_5">15 Egy√©b jogosulatlan munkav√©gz√©s (pl: g√©pkezel≈ëi jogosults√°gok)</label>
                    <span class="price">50,000 Ft</span>
                </div>

                <div class="price-item">
                    <input type="checkbox" id="price_6" name="sanction_6" value="100000">
                    <label for="price_6">16 Id≈ëszakos biztons√°gi √©s egy√©b jogszab√°lyban meghat√°rozott fel√ºlvizsg√°latok hi√°nya</label>
                    <span class="price">100,000 Ft</span>
                </div>

                <div class="price-item">
                    <input type="checkbox" id="price_7" name="sanction_7" value="100000">
                    <label for="price_7">26 √çr√°sos enged√©lyhez k√∂t√∂tt tev√©kenys√©g v√©gz√©se enged√©ly n√©lk√ºl</label>
                    <span class="price">100,000 Ft</span>
                </div>

                <div class="price-item">
                    <input type="checkbox" id="price_8" name="sanction_8" value="100000">
                    <label for="price_8">27 Emel√©si terv k√∂teles tev√©kenys√©g enged√©ly n√©lk√ºli v√©gz√©se</label>
                    <span class="price">100,000 Ft</span>
                </div>

                <div class="price-item">
                    <input type="checkbox" id="price_9" name="sanction_9" value="100000">
                    <label for="price_9">39 Megrendel≈ë fel√© jelentend≈ë EBK esem√©ny jelent√©s√©nek elmulaszt√°sa</label>
                    <span class="price">100,000 Ft</span>
                </div>

                <div class="total-price">
                    <span>√ñsszes√≠tett b√≠rs√°g:</span>
                    <span id="totalPrice">0 Ft</span>
                </div>
            </div>

            <!-- Submit gombok -->
            <div class="submit-section">
                <button type="button" class="submit-button" onclick="exportToPDF()">
                    <i class="fas fa-file-pdf"></i> PDF export√°l√°sa
                </button>
                <button type="submit" class="preview-button">
                    <i class="fas fa-save"></i> Ellen≈ërz√©s ment√©se
                </button>
            </div>

        </form>

    </div>

    <!-- Al√°√≠r√°s Modal -->
    <div id="signatureModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-signature"></i> Al√°√≠r√°s hozz√°ad√°sa</h2>
                <button class="close-modal" onclick="closeSignatureModal()">&times;</button>
            </div>
            <canvas id="signatureCanvas" width="540" height="300"></canvas>
            <div class="canvas-controls">
                <button class="btn-clear" onclick="clearCanvas()">
                    <i class="fas fa-trash"></i> T√∂rl√©s
                </button>
                <button class="btn-save" onclick="saveSignature()">
                    <i class="fas fa-check"></i> Ment√©s
                </button>
            </div>
        </div>
    </div>

    <script>
        // Glob√°lis v√°ltoz√≥k
        let canvas, ctx;
        let isDrawing = false;
        let currentSignatureType = '';
        const signatures = {
            inspector: null,
            responsible: null,
            subcontractor: null
        };

        // ‚≠ê M√ìDOS√çTOTT: K√©pek t√°rol√°sa metaadatokkal
        const uploadedImages = {
            '1_1': [],
            '1_2': [],
            '1_3': [],
            '1_4': []
        };

        // Tan√∫k sz√°ml√°l√≥
        let witnessCounter = 1;

        // Inicializ√°l√°s
        document.addEventListener('DOMContentLoaded', async function() {
    canvas = document.getElementById('signatureCanvas');
    ctx = canvas.getContext('2d');
    
    // Canvas be√°ll√≠t√°sok
    ctx.strokeStyle = '#000';
    ctx.lineWidth = 2;
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';

    // Eg√©r esem√©nyek
    canvas.addEventListener('mousedown', startDrawing);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('mouseup', stopDrawing);
    canvas.addEventListener('mouseout', stopDrawing);

    // √ârint√©s esem√©nyek (mobilra)
    canvas.addEventListener('touchstart', handleTouchStart, { passive: false });
    canvas.addEventListener('touchmove', handleTouchMove, { passive: false });
    canvas.addEventListener('touchend', handleTouchEnd, { passive: false });

    // Aktu√°lis d√°tum be√°ll√≠t√°sa alap√©rtelmezettnek
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('inspectionDate').value = today;

    // Mentett adatok bet√∂lt√©se 
    try {
        const response = await fetch('/projects/<%= project.id %>/reports/documentation');
        const result = await response.json();
        
        if (result.success && result.data) {
            console.log('Mentett adatok bet√∂ltve:', result.data);
            loadSavedData(result.data);
        } else {
            console.log('Nincs mentett adat ehhez a projekthez/kateg√≥ri√°hoz');
        }
    } catch (error) {
        console.error('Hiba a mentett adatok bet√∂lt√©sekor:', error);
    }
});

        // Tan√∫ hozz√°ad√°sa
        function addWitness() {
            const container = document.getElementById('witnessesContainer');
            const witnessIndex = witnessCounter++;
            
            const witnessGroup = document.createElement('div');
            witnessGroup.className = 'witness-group';
            witnessGroup.setAttribute('data-witness-index', witnessIndex);
            
            witnessGroup.innerHTML = `
                <button type="button" class="remove-witness-btn" onclick="removeWitness(${witnessIndex})">√ó</button>
                <label>Tan√∫ ${witnessIndex + 1}</label>
                <div class="two-column">
                    <input type="text" name="witness_name_${witnessIndex}" placeholder="N√©v">
                    <input type="text" name="witness_position_${witnessIndex}" placeholder="Beoszt√°s">
                </div>
                
                <div class="signature-container">
                    <div class="signature-preview" id="witnessPreview_${witnessIndex}" onclick="openSignatureModal('witness_${witnessIndex}')">
                        <span><i class="fas fa-pen"></i> Kattintson ide az al√°√≠r√°s hozz√°ad√°s√°hoz</span>
                    </div>
                    <div class="signature-buttons">
                        <button type="button" class="add-button" onclick="openSignatureModal('witness_${witnessIndex}')">
                            <i class="fas fa-signature"></i> Al√°√≠r√°s hozz√°ad√°sa
                        </button>
                        <button type="button" class="clear-signature" onclick="clearSignature('witness_${witnessIndex}')" style="display: none;" id="witness_${witnessIndex}Clear">
                            <i class="fas fa-trash"></i> T√∂rl√©s
                        </button>
                    </div>
                </div>
                <input type="hidden" name="witness_signature_${witnessIndex}" id="witness_${witnessIndex}Signature">
            `;
            
            container.appendChild(witnessGroup);
            
            // Al√°√≠r√°s inicializ√°l√°sa
            signatures[`witness_${witnessIndex}`] = null;
        }

        // Tan√∫ elt√°vol√≠t√°sa
        function removeWitness(index) {
            const witnessGroup = document.querySelector(`.witness-group[data-witness-index="${index}"]`);
            if (witnessGroup) {
                delete signatures[`witness_${index}`];
                witnessGroup.remove();
            }
        }

        // Al√°√≠r√°s modal megnyit√°sa
        function openSignatureModal(type) {
            currentSignatureType = type;
            document.getElementById('signatureModal').style.display = 'block';
            clearCanvas();
        }

        // Modal bez√°r√°sa
        function closeSignatureModal() {
            document.getElementById('signatureModal').style.display = 'none';
            currentSignatureType = '';
        }

        // Rajzol√°s kezd√©se
function startDrawing(e) {
    isDrawing = true;
    const rect = canvas.getBoundingClientRect();
    const scaleX = canvas.width / rect.width;
    const scaleY = canvas.height / rect.height;
    
    ctx.beginPath();
    ctx.moveTo(
        (e.clientX - rect.left) * scaleX,
        (e.clientY - rect.top) * scaleY
    );
}

        // Rajzol√°s
function draw(e) {
    if (!isDrawing) return;
    
    const rect = canvas.getBoundingClientRect();
    const scaleX = canvas.width / rect.width;
    const scaleY = canvas.height / rect.height;
    
    ctx.lineTo(
        (e.clientX - rect.left) * scaleX,
        (e.clientY - rect.top) * scaleY
    );
    ctx.stroke();
}

        // Rajzol√°s befejez√©se
        function stopDrawing() {
    if (isDrawing) {
        ctx.closePath();
    }
    isDrawing = false;
}

        // ‚≠ê M√ìDOS√çTOTT: K√©pfelt√∂lt√©s kezel√©se EXIF metaadatokkal
        function handleImageUpload(event, itemId) {
            const files = event.target.files;
            const previewContainer = document.getElementById(`preview_${itemId}`);
            
            if (!files || files.length === 0) return;

            console.log(`üì∏ ${files.length} k√©p felt√∂lt√©se indult (${itemId})`);

            Array.from(files).forEach(file => {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        const imageData = e.target.result;
                        
                        // ‚≠ê EXIF adatok kinyer√©se
                        EXIF.getData(file, function() {
                            // ‚≠ê KRITIKUS - Mobilon gyakran undefined a 'this'
                            const imageElement = this || file;
                            
                            const allTags = EXIF.getAllTags(imageElement);
                            console.log('üìã EXIF adatok:', file.name, allTags);

                            const exifData = {
                                date: EXIF.getTag(imageElement, "DateTimeOriginal") || 
                                      EXIF.getTag(imageElement, "DateTime") || 
                                      file.lastModified, // ‚≠ê Fallback f√°jl d√°tumra
                                lat: EXIF.getTag(imageElement, "GPSLatitude"),
                                lon: EXIF.getTag(imageElement, "GPSLongitude"),
                                latRef: EXIF.getTag(imageElement, "GPSLatitudeRef"),
                                lonRef: EXIF.getTag(imageElement, "GPSLongitudeRef"),
                                make: EXIF.getTag(imageElement, "Make"),
                                model: EXIF.getTag(imageElement, "Model")
                            };

                            // GPS konvert√°l√°s
                            let location = null;
                            let locationText = 'Nincs GPS adat';
                            let hasGPS = false;

                            console.log('üîç GPS Raw adatok:', {
                                lat: exifData.lat,
                                lon: exifData.lon,
                                latRef: exifData.latRef,
                                lonRef: exifData.lonRef
                            });

                            if (exifData.lat && exifData.lon) {
                                const lat = convertDMSToDD(exifData.lat, exifData.latRef);
                                const lon = convertDMSToDD(exifData.lon, exifData.lonRef);
                                
                                console.log('üìê Konvert√°lt koordin√°t√°k:', { lat, lon });
                                
                                if (lat !== null && lon !== null) {
                                    location = { lat, lon };
                                    locationText = `${lat.toFixed(6)}, ${lon.toFixed(6)}`;
                                    hasGPS = true;
                                    console.log('‚úÖ GPS koordin√°t√°k:', locationText);
                                } else {
                                    console.warn('‚ö†Ô∏è GPS konvert√°l√°s sikertelen');
                                }
                            } else {
                                console.warn('‚ö†Ô∏è Nincs GPS adat a k√©pben');
                            }

                            // D√°tum feldolgoz√°s
                            const dateText = exifData.date ? formatDate(exifData.date) : 'Nincs d√°tum adat';
                            const hasDate = !!exifData.date;

                            if (hasDate) {
                                console.log('‚úÖ Felv√©tel d√°tuma:', dateText);
                            } else {
                                console.warn('‚ö†Ô∏è Nincs d√°tum adat a k√©pben');
                            }

                            // Kamera info
                            const cameraInfo = (exifData.make || exifData.model) 
                                ? `${exifData.make || ''} ${exifData.model || ''}`.trim()
                                : null;

                            // ‚≠ê K√©p t√°rol√°sa metaadatokkal
                            uploadedImages[itemId].push({
                                data: imageData,
                                metadata: {
                                    takenDate: exifData.date || new Date().toISOString(),
                                    location: locationText,
                                    latitude: location?.lat,
                                    longitude: location?.lon,
                                    fileName: file.name,
                                    camera: cameraInfo,
                                    hasGPS: hasGPS,
                                    hasDate: hasDate
                                }
                            });
                            
                            // ‚≠ê Preview elem l√©trehoz√°sa
                            const previewItem = document.createElement('div');
                            previewItem.className = 'image-preview-item';
                            
                            const img = document.createElement('img');
                            img.src = imageData;
                            img.alt = file.name;
                            img.loading = 'lazy'; // ‚≠ê Lazy loading mobilra
                            img.style.maxWidth = '100%'; // ‚≠ê Mobil kompatibilit√°s
                            
                            // ‚≠ê Metaadatok megjelen√≠t√©se
                            const metaInfo = document.createElement('div');
                            metaInfo.className = 'image-meta-info';
                            
                            let metaHTML = '';
                            
                            // D√°tum
                            if (hasDate) {
                                metaHTML += `
                                    <div class="meta-item">
                                        <i class="fas fa-calendar"></i> 
                                        <span title="${dateText}">${dateText}</span>
                                    </div>
                                `;
                            }

                            // GPS
                            if (hasGPS) {
                                metaHTML += `
                                    <div class="meta-item">
                                        <i class="fas fa-map-marker-alt"></i> 
                                        <span>
                                            <a href="https://www.google.com/maps?q=${location.lat},${location.lon}" 
                                               target="_blank" 
                                               class="map-link"
                                               title="Megnyit√°s Google Maps-ben">
                                               ${locationText}
                                            </a>
                                        </span>
                                    </div>
                                `;
                            } else {
                                metaHTML += `
                                    <div class="meta-item">
                                        <i class="fas fa-map-marker-alt"></i> 
                                        <span style="color: #ffc107;">Nincs GPS adat</span>
                                    </div>
                                `;
                            }

                            // Kamera info (opcion√°lis)
                            if (cameraInfo) {
                                metaHTML += `
                                    <div class="meta-item">
                                        <i class="fas fa-camera"></i> 
                                        <span title="${cameraInfo}">${cameraInfo}</span>
                                    </div>
                                `;
                            }

                            // Figyelmeztet√©s ha nincs metaadat
                            if (!hasDate || !hasGPS) {
                                metaHTML += `
                                    <div class="no-metadata-warning">
                                        <i class="fas fa-exclamation-triangle"></i> 
                                        <span>Hi√°nyos metaadatok</span>
                                    </div>
                                `;
                            }

                            metaInfo.innerHTML = metaHTML;
                            
                            // T√∂rl√©s gomb
                            const removeBtn = document.createElement('button');
                            removeBtn.className = 'image-remove-btn';
                            removeBtn.innerHTML = '&times;';
                            removeBtn.title = 'K√©p elt√°vol√≠t√°sa';
                            removeBtn.onclick = function(e) {
                                e.stopPropagation();
                                const index = uploadedImages[itemId].findIndex(img => img.data === imageData);
                                if (index > -1) {
                                    uploadedImages[itemId].splice(index, 1);
                                    console.log('üóëÔ∏è K√©p elt√°vol√≠tva:', file.name);
                                }
                                previewItem.remove();
                            };
                            
                            // √ñsszerak√°s
                            previewItem.appendChild(img);
                            previewItem.appendChild(metaInfo);
                            previewItem.appendChild(removeBtn);
                            previewContainer.appendChild(previewItem);

                            console.log('‚úÖ K√©p hozz√°adva metaadatokkal:', {
                                fileName: file.name,
                                hasDate: hasDate,
                                hasGPS: hasGPS,
                                location: locationText
                            });
                        });
                    };
                    
                    reader.readAsDataURL(file);
                }
            });
            
            // Input reset
            event.target.value = '';
        }

        // ‚≠ê GPS DMS ‚Üí DD konvert√°l√°s
        function convertDMSToDD(dms, ref) {
            if (!dms || !Array.isArray(dms) || dms.length !== 3) {
                console.warn('‚ö†Ô∏è √ârv√©nytelen GPS form√°tum:', dms);
                return null;
            }
            
            try {
                const degrees = dms[0];
                const minutes = dms[1];
                const seconds = dms[2];
                
                let dd = degrees + minutes/60 + seconds/3600;
                
                if (ref === "S" || ref === "W") {
                    dd = dd * -1;
                }
                
                return dd;
            } catch (e) {
                console.error('‚ùå GPS konvert√°l√°si hiba:', e);
                return null;
            }
        }

        // ‚≠ê D√°tum form√°z√°s
        function formatDate(dateString) {
            if (!dateString) return 'Nincs adat';
            
            try {
                // EXIF form√°tum: "2025:12:06 14:54:00"
                let cleaned = dateString;
                
                if (typeof dateString === 'string') {
                    cleaned = dateString
                        .replace(/^(\d{4}):(\d{2}):(\d{2})/, '$1-$2-$3')
                        .replace(' ', 'T');
                }
                
                const date = new Date(cleaned);
                
                if (isNaN(date.getTime())) {
                    console.warn('‚ö†Ô∏è √ârv√©nytelen d√°tum form√°tum:', dateString);
                    return dateString;
                }
                
                return date.toLocaleDateString('hu-HU', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (e) {
                console.error('‚ùå D√°tum form√°z√°si hiba:', e);
                return dateString;
            }
        }

        // Touch esem√©nyek kezel√©se
function handleTouchStart(e) {
    e.preventDefault();
    const touch = e.touches[0];
    const rect = canvas.getBoundingClientRect();
    const scaleX = canvas.width / rect.width;
    const scaleY = canvas.height / rect.height;
    
    isDrawing = true;
    ctx.beginPath();
    ctx.moveTo(
        (touch.clientX - rect.left) * scaleX,
        (touch.clientY - rect.top) * scaleY
    );
}

        function handleTouchMove(e) {
    e.preventDefault();
    if (!isDrawing) return;
    
    const touch = e.touches[0];
    const rect = canvas.getBoundingClientRect();
    const scaleX = canvas.width / rect.width;
    const scaleY = canvas.height / rect.height;
    
    ctx.lineTo(
        (touch.clientX - rect.left) * scaleX,
        (touch.clientY - rect.top) * scaleY
    );
    ctx.stroke();
}

// Touch befejez√©se
function handleTouchEnd(e) {
    e.preventDefault();
    if (isDrawing) {
        ctx.closePath();
    }
    isDrawing = false;
}

        // Canvas t√∂rl√©se
        function clearCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        // Al√°√≠r√°s ment√©se
       function saveSignature() {
    const dataURL = canvas.toDataURL('image/png');
    signatures[currentSignatureType] = dataURL;
    
    let hiddenInputId = currentSignatureType + 'Signature';
    if (currentSignatureType.startsWith('witness_')) {
        hiddenInputId = currentSignatureType + 'Signature';
    }
    
    const hiddenInput = document.getElementById(hiddenInputId);
    if (hiddenInput) {
        hiddenInput.value = dataURL;
        console.log('Hidden input friss√≠tve:', hiddenInputId);
    } else {
        console.error('Hidden input nem tal√°lhat√≥:', hiddenInputId);
    }
    
    let previewId = currentSignatureType + 'Preview';
    if (currentSignatureType.startsWith('witness_')) {
        previewId = 'witnessPreview_' + currentSignatureType.split('_')[1];
    }
    
    const preview = document.getElementById(previewId);
    if (preview) {
        preview.innerHTML = `<img src="${dataURL}" alt="Al√°√≠r√°s">`;
        console.log('Preview friss√≠tve:', previewId);
    } else {
        console.error('Preview nem tal√°lhat√≥:', previewId);
    }
    
    let clearBtnId = currentSignatureType + 'Clear';
    if (currentSignatureType.startsWith('witness_')) {
        clearBtnId = currentSignatureType + 'Clear';
    }
    
    const clearBtn = document.getElementById(clearBtnId);
    if (clearBtn) {
        clearBtn.style.display = 'block';
        console.log('Clear button megjelen√≠tve:', clearBtnId);
    } else {
        console.error('Clear button nem tal√°lhat√≥:', clearBtnId);
    }
    
    closeSignatureModal();
}

        // Al√°√≠r√°s t√∂rl√©se
     function clearSignature(type) {
    signatures[type] = null;
    
    let hiddenInputId = type + 'Signature';
    const hiddenInput = document.getElementById(hiddenInputId);
    if (hiddenInput) {
        hiddenInput.value = '';
    }
    
    let previewId = type + 'Preview';
    if (type.startsWith('witness_')) {
        previewId = 'witnessPreview_' + type.split('_')[1];
    }
    
    const preview = document.getElementById(previewId);
    if (preview) {
        preview.innerHTML = '<span><i class="fas fa-pen"></i> Kattintson ide az al√°√≠r√°s hozz√°ad√°s√°hoz</span>';
    }
    
    let clearBtnId = type + 'Clear';
    const clearBtn = document.getElementById(clearBtnId);
    if (clearBtn) {
        clearBtn.style.display = 'none';
    }
}

        // √År kalkul√°ci√≥
        const priceCheckboxes = document.querySelectorAll('.price-item input[type="checkbox"]');
        const totalPriceElement = document.getElementById('totalPrice');

        function calculateTotal() {
            let total = 0;
            priceCheckboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    total += parseInt(checkbox.value);
                }
            });
            totalPriceElement.textContent = total.toLocaleString('hu-HU') + ' Ft';
            return total;
        }

        priceCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', calculateTotal);
        });

        // Form submit
document.getElementById('documentationForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const data = {};
    
    for (let [key, value] of formData.entries()) {
        data[key] = value;
    }

    // B√≠rs√°g √∂sszeg hozz√°ad√°sa
    data.total_fine = calculateTotal();
    data.total_fine_formatted = totalPriceElement.textContent;
    
    // ‚≠ê K√©pek hozz√°ad√°sa metaadatokkal
    data.images = uploadedImages;
    
    // Projekt specifikus mez≈ëk hozz√°ad√°sa
    data.projectName = document.getElementById('projectName').value;
    data.serialNumber = document.getElementById('serialNumber').value;
    data.inspectorPerson = document.getElementById('inspectorPerson').value;
    data.inspectionDate = document.getElementById('inspectionDate').value;

    console.log('üì§ Ment√©s adatokkal:', data);

    fetch(this.action, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            alert('‚úì Ellen≈ërz√©s sikeresen elmentve!');
        } else {
            alert('‚úó Hiba t√∂rt√©nt: ' + result.message);
        }
    })
    .catch(error => {
        console.error('Hiba:', error);
        alert('‚úó Hiba t√∂rt√©nt a ment√©s sor√°n.');
    });
});

// √öj ellen≈ërz√©s ind√≠t√°sa
async function startNewInspection() {
    const confirmNew = confirm('‚ö†Ô∏è Biztosan √∫j ellen≈ërz√©st szeretn√©l ind√≠tani?\n\nEz t√∂rli a jelenlegi mentett adatokat √©s √ºres lappal kezdhetsz.');
    
    if (!confirmNew) {
        return;
    }

    try {
        const response = await fetch('/projects/<%= project.id %>/reports/documentation', {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        });

        const result = await response.json();

        if (result.success) {
            alert('‚úÖ √öj ellen≈ërz√©s ind√≠tva! Az oldal √∫jrat√∂lt≈ëdik.');
            window.location.reload();
        } else {
            alert('‚ùå Hiba t√∂rt√©nt: ' + result.message);
        }
    } catch (error) {
        console.error('Hiba az √∫j ellen≈ërz√©s ind√≠t√°sakor:', error);
        alert('‚ùå Hiba t√∂rt√©nt az √∫j ellen≈ërz√©s ind√≠t√°sakor.');
    }
}

       // PDF Export√°l√°s
        function exportToPDF() {
            const projectName = document.getElementById('projectName').value || '<%= project.name %>';
            const serialNumber = document.getElementById('serialNumber').value || 'N/A';
            const inspectorPerson = document.getElementById('inspectorPerson').value || '<%= user.name %>';
            const inspectionDateValue = document.getElementById('inspectionDate').value;
            const formattedDate = inspectionDateValue ? new Date(inspectionDateValue).toLocaleDateString('hu-HU', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            }) : 'N/A';

            // Form adatok √∂sszegy≈±jt√©se
            const formData = new FormData(document.getElementById('documentationForm'));
            const data = {};
            for (let [key, value] of formData.entries()) {
                data[key] = value;
            }

            // PDF dokumentum defin√≠ci√≥
const docDefinition = {
    pageSize: 'A4',
    pageMargins: [40, 60, 40, 60],
    content: [
        // Fejl√©c
        {
            text: 'MUNKAV√âDELMI ELLEN≈êRZ√âSI JEGYZ≈êK√ñNYV',
            style: 'mainHeader',
            alignment: 'center',
            margin: [0, 0, 0, 10]
        },
        {
            text: '1. DOKUMENT√ÅCI√ì',
            style: 'categoryHeader',
            alignment: 'center',
            margin: [0, 0, 0, 20]
        },

        // Projekt inform√°ci√≥k
        {
            style: 'infoTable',
            table: {
                widths: [130, '*'],
                body: [
                    [
                        { text: 'Projekt neve:', style: 'labelCell' },
                        { text: projectName, style: 'valueCell' }
                    ],
                    [
                        { text: 'Sorsz√°m:', style: 'labelCell' },
                        { text: serialNumber, style: 'valueCell' }
                    ],
                    [
                        { text: 'Ellen≈ërz≈ë szem√©ly:', style: 'labelCell' },
                        { text: inspectorPerson, style: 'valueCell' }
                    ],
                    [
                        { text: 'D√°tum:', style: 'labelCell' },
                        { text: formattedDate, style: 'valueCell' }
                    ]
                ]
            },
            layout: {
                fillColor: function (rowIndex) {
                    return (rowIndex % 2 === 0) ? '#f9f9f9' : null;
                },
                hLineWidth: function () { return 0.5; },
                vLineWidth: function () { return 0; },
                hLineColor: function () { return '#e0e0e0'; }
            },
            margin: [0, 0, 0, 30]
        },

        // R√©sztvev≈ëk szekci√≥
        {
            text: 'ELLEN≈êRZ√âS R√âSZTVEV≈êI',
            style: 'sectionHeader',
            margin: [0, 0, 0, 15]
        },

        // Ellen≈ërz√©st v√©gz≈ë
        {
            columns: [
                { 
                    width: '*',
                    stack: [
                        { text: 'Ellen≈ërz√©st v√©gz≈ë', style: 'participantLabel' },
                        { text: data.inspector_name || 'N/A', style: 'participantName' },
                        { text: data.inspector_position || '', style: 'participantPosition' }
                    ]
                },
                {
                    width: 150,
                    stack: [
                        signatures.inspector ? {
                            image: signatures.inspector,
                            width: 120,
                            alignment: 'center',
                            margin: [0, 5, 0, 0]
                        } : { 
                            text: '[Al√°√≠r√°s hi√°nyzik]', 
                            italics: true, 
                            color: '#999',
                            fontSize: 9,
                            alignment: 'center',
                            margin: [0, 20, 0, 0]
                        }
                    ]
                }
            ],
            margin: [0, 0, 0, 15]
        },

        // Munkater√ºlet√©rt felel≈ës
        {
            columns: [
                { 
                    width: '*',
                    stack: [
                        { text: 'Munkater√ºlet√©rt felel≈ës', style: 'participantLabel' },
                        { text: data.responsible_name || 'N/A', style: 'participantName' },
                        { text: data.responsible_position || '', style: 'participantPosition' }
                    ]
                },
                {
                    width: 150,
                    stack: [
                        signatures.responsible ? {
                            image: signatures.responsible,
                            width: 120,
                            alignment: 'center',
                            margin: [0, 5, 0, 0]
                        } : { 
                            text: '[Al√°√≠r√°s hi√°nyzik]', 
                            italics: true, 
                            color: '#999',
                            fontSize: 9,
                            alignment: 'center',
                            margin: [0, 20, 0, 0]
                        }
                    ]
                }
            ],
            margin: [0, 0, 0, 15]
        },

        // Tan√∫k
        ...getWitnessesForPDF(data),

        // Alv√°llalkoz√≥i l√°nc
        {
            columns: [
                { 
                    width: '*',
                    stack: [
                        { text: 'Alv√°llalkoz√≥i l√°nc', style: 'participantLabel' },
                        { text: data.subcontractor_name || 'N/A', style: 'participantName' },
                        { text: data.subcontractor_representative || '', style: 'participantPosition' }
                    ]
                },
                {
                    width: 150,
                    stack: [
                        signatures.subcontractor ? {
                            image: signatures.subcontractor,
                            width: 120,
                            alignment: 'center',
                            margin: [0, 5, 0, 0]
                        } : { 
                            text: '[Al√°√≠r√°s hi√°nyzik]', 
                            italics: true, 
                            color: '#999',
                            fontSize: 9,
                            alignment: 'center',
                            margin: [0, 20, 0, 0]
                        }
                    ]
                }
            ],
            margin: [0, 0, 0, 30]
        },

        // Ellen≈ërz√©si pontok
        {
            text: 'ELLEN≈êRZ√âSI PONTOK',
            style: 'sectionHeader',
            margin: [0, 0, 0, 20],
            pageBreak: 'before'
        },

        // 1.1
      {
    table: {
        widths: ['*'],
        body: [[
            {
                stack: [
                    { text: '1.1 Munkater√ºlet√©rt felel≈ës beazonos√≠t√°sa', style: 'checklistTitle' },
                    { text: '√Åtad√°s √°tv√©tel jegyz≈ëk√∂nyv fellelhet≈ës√©ge, munkaenged√©ly, stb.', style: 'checklistDesc' },
                    { text: `√ârt√©kel√©s: ${getStatusText(data.item_1_1)}`, style: getStatusStyle(data.item_1_1), margin: [0, 8, 0, 0] },
                    data.notes_1_1 ? { text: `Megjegyz√©s: ${data.notes_1_1}`, style: 'notes' } : {}
                ],
                border: [true, true, true, true],
                fillColor: '#fafafa'
            }
        ]]
    },
    layout: {
        hLineColor: '#333',
        vLineColor: '#333',
        hLineWidth: function() { return 1; },
        vLineWidth: function() { return 1; }
    },
    margin: [0, 0, 0, 10]
},
        ...getImagesForPDF('1_1'),

        // 1.2
        {
            table: {
                widths: ['*'],
                body: [[
                    {
                        stack: [
                            { text: '1.2 Egy√©b dokument√°ci√≥k', style: 'checklistTitle' },
                            { text: '√âp√≠t√©si napl√≥, hullad√©k nyilv√°ntart√≥lap stb.', style: 'checklistDesc' },
                            { text: `√ârt√©kel√©s: ${getStatusText(data.item_1_2)}`, style: getStatusStyle(data.item_1_2), margin: [0, 8, 0, 0] },
                            data.notes_1_2 ? { text: `Megjegyz√©s: ${data.notes_1_2}`, style: 'notes' } : {}
                        ],
                        border: [true, true, true, true],
                        fillColor: '#fafafa'
                    }
                ]]
            },
            layout: {
                hLineColor: '#333',
        vLineColor: '#333', 
                hLineWidth: function() { return 1; },
                vLineWidth: function() { return 1; }
            },
            margin: [0, 0, 0, 10]
        },
        ...getImagesForPDF('1_2'),

        // 1.3
        {
            table: {
                widths: ['*'],
                body: [[
                    {
                        stack: [
                            { text: '1.3 Sz√ºks√©ges enged√©lyek', style: 'checklistTitle' },
                            { text: 'T≈±zgy√∫jt√°si, besz√°ll√°si, fesz√ºlts√©g ment., emel√©si terv stb.', style: 'checklistDesc' },
                            { text: `√ârt√©kel√©s: ${getStatusText(data.item_1_3)}`, style: getStatusStyle(data.item_1_3), margin: [0, 8, 0, 0] },
                            data.notes_1_3 ? { text: `Megjegyz√©s: ${data.notes_1_3}`, style: 'notes' } : {}
                        ],
                        border: [true, true, true, true],
                        fillColor: '#fafafa'
                    }
                ]]
            },
            layout: {
                hLineColor: '#333',
        vLineColor: '#333', 
                hLineWidth: function() { return 1; },
                vLineWidth: function() { return 1; }
            },
            margin: [0, 0, 0, 10]
        },
        ...getImagesForPDF('1_3'),

        // 1.4
        {
            table: {
                widths: ['*'],
                body: [[
                    {
                        stack: [
                            { text: '1.4 Sz√ºks√©ges tervdokument√°ci√≥k, jegyz≈ëk√∂nyvek', style: 'checklistTitle' },
                            { text: 'BET; EBK terv; organiz√°ci√≥s terv stb.', style: 'checklistDesc' },
                            { text: `√ârt√©kel√©s: ${getStatusText(data.item_1_4)}`, style: getStatusStyle(data.item_1_4), margin: [0, 8, 0, 0] },
                            data.notes_1_4 ? { text: `Megjegyz√©s: ${data.notes_1_4}`, style: 'notes' } : {}
                        ],
                        border: [true, true, true, true],
                        fillColor: '#fafafa'
                    }
                ]]
            },
            layout: {
                hLineColor: '#333',
        vLineColor: '#333', 
                hLineWidth: function() { return 1; },
                vLineWidth: function() { return 1; }
            },
            margin: [0, 0, 0, 10]
        },
        ...getImagesForPDF('1_4'),

        // Szankci√≥k
        {
            text: 'SZANKCI√ìS LISTA',
            style: 'sectionHeader',
            margin: [0, 30, 0, 15],
            pageBreak: 'before'
        },
        {
            text: 'Dokument√°ci√≥ kateg√≥ria vonatkoz√≥ pontjai',
            style: 'sanctionsSubtitle',
            margin: [0, 0, 0, 15]
        },
        ...getAppliedSanctionsForPDF(data),
        {
            table: {
        widths: ['*', 'auto'],
        body: [[
            { text: '√ñsszes√≠tett b√≠rs√°g:', bold: true, fontSize: 14, alignment: 'right', border: [false, true, false, false], margin: [0, 10, 0, 10] },
            { text: totalPriceElement.textContent, bold: true, fontSize: 16, color: '#dc3545', alignment: 'right', border: [false, true, false, false], margin: [0, 10, 0, 10] }
        ]]
    },
    layout: {
        hLineColor: '#333',
        hLineWidth: function() { return 2; }
    },
    margin: [0, 10, 0, 0]
}
    ],

    styles: {
    mainHeader: {
        fontSize: 16,
        bold: true,
        color: '#5c0099',
        letterSpacing: 1
    },
    categoryHeader: {
        fontSize: 14,
        bold: true,
        color: '#333'
    },
    sectionHeader: {
    fontSize: 13,
    bold: true,
    color: '#333',
    margin: [0, 0, 0, 10]
},
    infoTable: {
        fontSize: 11
    },
    labelCell: {
        bold: true,
        color: '#333',
        fontSize: 10
    },
    valueCell: {
        color: '#333',
        fontSize: 10
    },
    participantLabel: {
        fontSize: 11,
        bold: true,
        color: '#5c0099',
        margin: [0, 0, 0, 5]
    },
    participantName: {
        fontSize: 12,
        bold: true,
        color: '#333'
    },
    participantPosition: {
        fontSize: 10,
        color: '#666',
        italics: true
    },
    checklistTitle: {
        fontSize: 12,
        bold: true,
        color: '#333',
        margin: [5, 5, 5, 3]
    },
    checklistDesc: {
        fontSize: 9,
        color: '#666',
        italics: true,
        margin: [5, 0, 5, 5]
    },
    statusOk: {
        fontSize: 11,
        color: '#28a745',
        bold: true,
        margin: [5, 0, 5, 5]
    },
    statusFail: {
        fontSize: 11,
        color: '#dc3545',
        bold: true,
        margin: [5, 0, 5, 5]
    },
    statusNA: {
        fontSize: 11,
        color: '#ffc107',
        bold: true,
        margin: [5, 0, 5, 5]
    },
    notes: {
        fontSize: 9,
        italics: true,
        color: '#555',
        margin: [5, 5, 5, 8]
    },
    sanctionsSubtitle: {
        fontSize: 10,
        color: '#666',
        italics: true
    },
    sanctions: {
        fontSize: 10,
        margin: [0, 3, 0, 3]
    },
    imageTitle: {
        fontSize: 11,
        bold: true,
        color: '#333',
        margin: [0, 10, 0, 8]
    }
},
    
    defaultStyle: {
        font: 'Roboto'
    }
};


            // PDF gener√°l√°s √©s felt√∂lt√©s
pdfMake.createPdf(docDefinition).getBase64(async function(pdfBase64) {
    try {
        // K√ºld√©s a backend-nek
        const response = await fetch('/projects/<%= project.id %>/reports/documentation/export-pdf', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                pdfData: `data:application/pdf;base64,${pdfBase64}`,
                serialNumber: serialNumber,
                projectName: projectName,
                images: uploadedImages
            })
        });

        const result = await response.json();

        if (result.success) {
            if (result.driveUrl) {
                alert('‚úÖ PDF sikeresen export√°lva √©s felt√∂ltve a Google Drive-ra!');
                console.log('Drive URL:', result.driveUrl);
            } else {
                alert('‚úÖ PDF let√∂lt√©sre k√©sz!');
            }
        }

        // ‚≠ê JAV√çTOTT LET√ñLT√âS MOBILRA
        const fileName = `Dokumentacio_${serialNumber.replace(/\//g, '-')}_${Date.now()}.pdf`;
        
        // Mobilos b√∂ng√©sz≈ë detekt√°l√°sa
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        
        if (isMobile) {
            console.log('üì± Mobil b√∂ng√©sz≈ë - Blob URL haszn√°lata');
            
            // PDF gener√°l√°s blob-k√©nt
            pdfMake.createPdf(docDefinition).getBlob(function(blob) {
                // Blob URL l√©trehoz√°sa
                const blobUrl = URL.createObjectURL(blob);
                
                // Link elem l√©trehoz√°sa √©s kattint√°s szimul√°l√°sa
                const link = document.createElement('a');
                link.href = blobUrl;
                link.download = fileName;
                link.style.display = 'none';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // Cleanup
                setTimeout(() => URL.revokeObjectURL(blobUrl), 100);
                
                console.log('‚úÖ PDF let√∂lt√©s elind√≠tva (mobil)');
            });
        } else {
            console.log('üíª Asztali b√∂ng√©sz≈ë - Standard let√∂lt√©s');
            pdfMake.createPdf(docDefinition).download(fileName);
        }

    } catch (error) {
        console.error('Hiba a PDF felt√∂lt√©sekor:', error);
        alert('‚ö†Ô∏è Hiba t√∂rt√©nt, de a PDF let√∂lt√©se folytat√≥dik.');
        
        // Let√∂lt√©s akkor is megt√∂rt√©nik
        const fileName = `Dokumentacio_${serialNumber.replace(/\//g, '-')}_${Date.now()}.pdf`;
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        
        if (isMobile) {
            pdfMake.createPdf(docDefinition).getBlob(function(blob) {
                const blobUrl = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = blobUrl;
                link.download = fileName;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                setTimeout(() => URL.revokeObjectURL(blobUrl), 100);
            });
        } else {
            pdfMake.createPdf(docDefinition).download(fileName);
        }
    }
});
}

        // Seg√©df√ºggv√©nyek a PDF-hez
        function getStatusText(status) {
            switch(status) {
                case 'megfelel≈ë': return 'MEGFELEL≈ê (M)';
                case 'nem_megfelel≈ë': return 'NEM MEGFELEL≈ê (NM)';
                case 'nem_vizsg√°lt': return 'NEM VIZSG√ÅLT (NV)';
                default: return 'Nincs √©rt√©kelve';
            }
        }

        function getStatusStyle(status) {
            switch(status) {
                case 'megfelel≈ë': return 'statusOk';
                case 'nem_megfelel≈ë': return 'statusFail';
                case 'nem_vizsg√°lt': return 'statusNA';
                default: return 'statusNA';
            }
        }

        // Tan√∫k PDF-hez
        function getWitnessesForPDF(data) {
            const result = [];
            
            for (let i = 0; i < witnessCounter; i++) {
                const witnessName = data[`witness_name_${i}`];
                const witnessPosition = data[`witness_position_${i}`];
                const witnessSignature = signatures[`witness_${i}`];
                
                if (witnessName && witnessName.trim() !== '') {
                    result.push({
                        text: `Tan√∫ ${i === 0 ? '' : i + 1}`,
                        style: 'participantTitle'
                    });
                    
                    result.push({
                        columns: [
                            { width: '*', text: `N√©v: ${witnessName}` },
                            { width: '*', text: `Beoszt√°s: ${witnessPosition || 'N/A'}` }
                        ],
                        margin: [0, 5, 0, 5]
                    });
                    
                    if (witnessSignature) {
                        result.push({
                            image: witnessSignature,
                            width: 150,
                            margin: [0, 10, 0, 20]
                        });
                    } else {
                        result.push({
                            text: '[Al√°√≠r√°s hi√°nyzik]',
                            italics: true,
                            margin: [0, 10, 0, 20]
                        });
                    }
                }
            }
            
            return result;
        }

        // Szankci√≥k PDF-hez
        function getAppliedSanctionsForPDF(data) {
            const sanctionLabels = {
                sanction_1: '1 MVM XPert munka-, t≈±z-, vagy k√∂rnyezetv√©delmi szab√°lyainak megs√©rt√©se',
                sanction_2: '6 Munkabiztons√°got jelent≈ësen befoly√°sol√≥ eszk√∂z√∂k, jelz√©sek, biztons√°gi berendez√©sek mell≈ëz√©se, kiiktat√°sa',
                sanction_3: '9 Vesz√©lyes munkaeszk√∂z √ºzembehelyez√©s√©nek √©s id≈ëszakos biztons√°gi fel√ºlvizsg√°lat elv√©gz√©s√©nek hi√°nya',
                sanction_4: '10 A munkav√©gz√©shez haszn√°lt id≈ëszakos fel√ºlvizsg√°latra k√∂telezett g√©pek, berendez√©sek, munkaeszk√∂z√∂k nem azonos√≠that√≥k',
                sanction_5: '15 Egy√©b jogosulatlan munkav√©gz√©s (pl: g√©pkezel≈ëi jogosults√°gok)',
                sanction_6: '16 Id≈ëszakos biztons√°gi √©s egy√©b jogszab√°lyban meghat√°rozott fel√ºlvizsg√°latok hi√°nya',
                sanction_7: '26 √çr√°sos enged√©lyhez k√∂t√∂tt tev√©kenys√©g v√©gz√©se enged√©ly n√©lk√ºl',
                sanction_8: '27 Emel√©si terv k√∂teles tev√©kenys√©g enged√©ly n√©lk√ºli v√©gz√©se',
                sanction_9: '39 Megrendel≈ë fel√© jelentend≈ë EBK esem√©ny jelent√©s√©nek elmulaszt√°sa'
            };

            const sanctionPrices = {
                sanction_1: '100,000 Ft',
                sanction_2: '50,000 Ft',
                sanction_3: '50,000 Ft',
                sanction_4: '30,000 Ft',
                sanction_5: '50,000 Ft',
                sanction_6: '100,000 Ft',
                sanction_7: '100,000 Ft',
                sanction_8: '100,000 Ft',
                sanction_9: '100,000 Ft'
            };

            const result = [];
            let hasAny = false;

            const checkboxes = document.querySelectorAll('.price-item input[type="checkbox"]');
            
            checkboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    const sanctionKey = checkbox.name;
                    hasAny = true;
                    
                    result.push({
                        text: `‚Ä¢ ${sanctionLabels[sanctionKey]} - ${sanctionPrices[sanctionKey]}`,
                        style: 'sanctions',
                        margin: [0, 3, 0, 3]
                    });
                }
            });

            if (!hasAny) {
                result.push({
                    text: 'Nincs alkalmazott szankci√≥.',
                    style: 'sanctions',
                    italics: true,
                    color: '#999'
                });
            }

            return result;
        }

        // ‚≠ê M√ìDOS√çTOTT: K√©pek PDF-hez metaadatokkal
        function getImagesForPDF(itemId) {
            const images = uploadedImages[itemId];
            if (!images || images.length === 0) {
                return [];
            }

            const result = [
                {
                    text: 'Csatolt f√©nyk√©pek / dokument√°ci√≥:',
                    style: 'imageTitle',
                    margin: [0, 10, 0, 8]
                }
            ];

            for (let i = 0; i < images.length; i++) {
                const imgObj = images[i];
                const imageData = imgObj.data;
                const metadata = imgObj.metadata;

                // K√©p megjelen√≠t√©se
                result.push({
                    image: imageData,
                    width: 400,
                    alignment: 'center',
                    margin: [0, 5, 0, 5]
                });

                // ‚≠ê Metaadatok megjelen√≠t√©se a k√©p alatt
                const metaText = [];
                
                if (metadata.fileName) {
                    metaText.push(`üìÑ ${metadata.fileName}`);
                }
                
                if (metadata.hasDate && metadata.takenDate) {
                    const formattedMeta = formatDate(metadata.takenDate);
                    metaText.push(`üìÖ Felv√©tel ideje: ${formattedMeta}`);
                }
                
                if (metadata.hasGPS && metadata.location) {
                    metaText.push(`üìç Helysz√≠n: ${metadata.location}`);
                }

                if (metadata.camera) {
                    metaText.push(`üì∑ ${metadata.camera}`);
                }

                if (!metadata.hasDate || !metadata.hasGPS) {
                    metaText.push(`‚ö†Ô∏è Hi√°nyos metaadatok`);
                }

                result.push({
                    text: metaText.join('\n'),
                    fontSize: 9,
                    color: '#666',
                    italics: true,
                    margin: [0, 3, 0, 15]
                });
            }

            return result;
        }

        // Modal bez√°r√°sa kattint√°ssal a h√°tt√©rre
        window.onclick = function(event) {
            const modal = document.getElementById('signatureModal');
            if (event.target == modal) {
                closeSignatureModal();
            }
        }

        // Mentett adatok bet√∂lt√©se a form-ba
function loadSavedData(data) {
    console.log('loadSavedData megh√≠vva:', data);
    
    // Projekt inform√°ci√≥k
    if (data.projectName) {
        document.getElementById('projectName').value = data.projectName;
    }
    if (data.serialNumber) {
        document.getElementById('serialNumber').value = data.serialNumber;
    }
    if (data.inspectorPerson) {
        document.getElementById('inspectorPerson').value = data.inspectorPerson;
    }
    if (data.inspectionDate) {
        document.getElementById('inspectionDate').value = data.inspectionDate;
    }
    
    // R√©sztvev≈ëk
    if (data.inspector_name) {
        document.querySelector('input[name="inspector_name"]').value = data.inspector_name;
    }
    if (data.inspector_position) {
        document.querySelector('input[name="inspector_position"]').value = data.inspector_position;
    }
    if (data.responsible_name) {
        document.querySelector('input[name="responsible_name"]').value = data.responsible_name;
    }
    if (data.responsible_position) {
        document.querySelector('input[name="responsible_position"]').value = data.responsible_position;
    }
    
    // Al√°√≠r√°sok bet√∂lt√©se
    if (data.inspector_signature) {
        signatures.inspector = data.inspector_signature;
        document.getElementById('inspectorSignature').value = data.inspector_signature;
        document.getElementById('inspectorPreview').innerHTML = `<img src="${data.inspector_signature}" alt="Al√°√≠r√°s">`;
        document.getElementById('inspectorClear').style.display = 'block';
    }
    
    if (data.responsible_signature) {
        signatures.responsible = data.responsible_signature;
        document.getElementById('responsibleSignature').value = data.responsible_signature;
        document.getElementById('responsiblePreview').innerHTML = `<img src="${data.responsible_signature}" alt="Al√°√≠r√°s">`;
        document.getElementById('responsibleClear').style.display = 'block';
    }
    
    if (data.subcontractor_signature) {
        signatures.subcontractor = data.subcontractor_signature;
        document.getElementById('subcontractorSignature').value = data.subcontractor_signature;
        document.getElementById('subcontractorPreview').innerHTML = `<img src="${data.subcontractor_signature}" alt="Al√°√≠r√°s">`;
        document.getElementById('subcontractorClear').style.display = 'block';
    }
    
    // Tan√∫k bet√∂lt√©se
    let witnessIndex = 0;
    while (data[`witness_name_${witnessIndex}`]) {
        if (witnessIndex > 0) {
            addWitness();
        }
        
        setTimeout(() => {
            const nameInput = document.querySelector(`input[name="witness_name_${witnessIndex}"]`);
            const positionInput = document.querySelector(`input[name="witness_position_${witnessIndex}"]`);
            
            if (nameInput && data[`witness_name_${witnessIndex}`]) {
                nameInput.value = data[`witness_name_${witnessIndex}`];
            }
            if (positionInput && data[`witness_position_${witnessIndex}`]) {
                positionInput.value = data[`witness_position_${witnessIndex}`];
            }
            
            if (data[`witness_signature_${witnessIndex}`]) {
                signatures[`witness_${witnessIndex}`] = data[`witness_signature_${witnessIndex}`];
                const sigInput = document.getElementById(`witness_${witnessIndex}Signature`);
                const preview = document.getElementById(`witnessPreview_${witnessIndex}`);
                const clearBtn = document.getElementById(`witness_${witnessIndex}Clear`);
                
                if (sigInput) sigInput.value = data[`witness_signature_${witnessIndex}`];
                if (preview) preview.innerHTML = `<img src="${data[`witness_signature_${witnessIndex}`]}" alt="Al√°√≠r√°s">`;
                if (clearBtn) clearBtn.style.display = 'block';
            }
        }, 100 * witnessIndex);
        
        witnessIndex++;
    }
    
    // Alv√°llalkoz√≥
    if (data.subcontractor_name) {
        document.querySelector('input[name="subcontractor_name"]').value = data.subcontractor_name;
    }
    if (data.subcontractor_representative) {
        document.querySelector('input[name="subcontractor_representative"]').value = data.subcontractor_representative;
    }
    
    // Ellen≈ërz√©si pontok
    ['item_1_1', 'item_1_2', 'item_1_3', 'item_1_4'].forEach(itemName => {
        if (data[itemName]) {
            const radio = document.querySelector(`input[name="${itemName}"][value="${data[itemName]}"]`);
            if (radio) radio.checked = true;
        }
    });
    
    // Megjegyz√©sek
    ['notes_1_1', 'notes_1_2', 'notes_1_3', 'notes_1_4'].forEach(noteName => {
        if (data[noteName]) {
            const textarea = document.querySelector(`textarea[name="${noteName}"]`);
            if (textarea) textarea.value = data[noteName];
        }
    });
    
    // ‚≠ê K√©pek bet√∂lt√©se metaadatokkal
    if (data.images) {
        ['1_1', '1_2', '1_3', '1_4'].forEach(itemId => {
            if (data.images[itemId] && Array.isArray(data.images[itemId])) {
                uploadedImages[itemId] = data.images[itemId];
                
                const previewContainer = document.getElementById(`preview_${itemId}`);
                data.images[itemId].forEach(imgObj => {
                    const imageData = imgObj.data;
                    const metadata = imgObj.metadata || {};
                    
                    const previewItem = document.createElement('div');
                    previewItem.className = 'image-preview-item';
                    
                    const img = document.createElement('img');
                    img.src = imageData;
                    
                    // Metaadatok megjelen√≠t√©se
                    const metaInfo = document.createElement('div');
                    metaInfo.className = 'image-meta-info';
                    
                    let metaHTML = '';
                    
                    if (metadata.hasDate && metadata.takenDate) {
                        metaHTML += `
                            <div class="meta-item">
                                <i class="fas fa-calendar"></i> 
                                <span>${formatDate(metadata.takenDate)}</span>
                            </div>
                        `;
                    }
                    
                    if (metadata.hasGPS && metadata.location) {
                        metaHTML += `
                            <div class="meta-item">
                                <i class="fas fa-map-marker-alt"></i> 
                                <span>
                                    <a href="https://www.google.com/maps?q=${metadata.latitude},${metadata.longitude}" 
                                       target="_blank" 
                                       class="map-link">
                                       ${metadata.location}
                                    </a>
                                </span>
                            </div>
                        `;
                    } else {
                        metaHTML += `
                            <div class="meta-item">
                                <i class="fas fa-map-marker-alt"></i> 
                                <span style="color: #ffc107;">Nincs GPS adat</span>
                            </div>
                        `;
                    }
                    
                    if (!metadata.hasDate || !metadata.hasGPS) {
                        metaHTML += `
                            <div class="no-metadata-warning">
                                <i class="fas fa-exclamation-triangle"></i> 
                                <span>Hi√°nyos metaadatok</span>
                            </div>
                        `;
                    }
                    
                    metaInfo.innerHTML = metaHTML;
                    
                    const removeBtn = document.createElement('button');
                    removeBtn.className = 'image-remove-btn';
                    removeBtn.innerHTML = '&times;';
                    removeBtn.onclick = function() {
                        const index = uploadedImages[itemId].findIndex(img => img.data === imageData);
                        if (index > -1) {
                            uploadedImages[itemId].splice(index, 1);
                        }
                        previewItem.remove();
                    };
                    
                    previewItem.appendChild(img);
                    previewItem.appendChild(metaInfo);
                    previewItem.appendChild(removeBtn);
                    previewContainer.appendChild(previewItem);
                });
            }
        });
    }
    
    // Szankci√≥k bet√∂lt√©se
    const checkboxes = document.querySelectorAll('.price-item input[type="checkbox"]');
    checkboxes.forEach(checkbox => {
        if (data[checkbox.name] === 'on' || data[checkbox.name] === checkbox.value) {
            checkbox.checked = true;
        }
    });
    calculateTotal();
    
    console.log('‚úì Mentett adatok sikeresen bet√∂ltve a form-ba');
}
    </script>

</body>
</html>